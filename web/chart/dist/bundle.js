(()=>{"use strict";function t(t){return"number"==typeof t&&isFinite(t)}function e(t){return"number"==typeof t&&t%1==0}function i(t){return"string"==typeof t}function s(t){return"boolean"==typeof t}function n(t){const e=t;if(!e||"object"!=typeof e)return e;let i,s,o;for(s in i=Array.isArray(e)?[]:{},e)e.hasOwnProperty(s)&&(o=e[s],i[s]=o&&"object"==typeof o?n(o):o);return i}function o(t){return null!==t}function r(t){return null===t?void 0:t}function a(t,e){if(!t)throw new Error("Assertion failed"+(e?": "+e:""))}function l(t){if(void 0===t)throw new Error("Value is undefined");return t}function h(t){if(null===t)throw new Error("Value is null");return t}function c(t){return h(l(t))}function d(t,...e){for(const i of e)for(const e in i)void 0!==i[e]&&("object"!=typeof i[e]||void 0===t[e]||Array.isArray(i[e])?t[e]=i[e]:d(t[e],i[e]));return t}function u(t,e){return{x:t.x-e.x,y:t.y-e.y}}function _(t,e){return{x:t.x/e,y:t.y/e}}function p(t,e,i){return Math.min(Math.max(t,e),i)}function m(t,e,i){return e-t<=i}function g(t,e){return null===t||null===e?t===e:t.equals(e)}function f(t,e){const i={0:[],1:[t.lineWidth,t.lineWidth],2:[2*t.lineWidth,2*t.lineWidth],3:[6*t.lineWidth,6*t.lineWidth],4:[t.lineWidth,4*t.lineWidth]}[e];t.setLineDash(i)}function v(t,e,i,s){t.beginPath();const n=t.lineWidth%2?.5:0;t.moveTo(i,e+n),t.lineTo(s,e+n),t.stroke()}function S(t){return t<0?0:t>255?255:Math.round(t)||0}function b(t){return t<=0||t>0?t<0?0:t>1?1:Math.round(1e4*t)/1e4:0}const w=/^#([0-9a-f])([0-9a-f])([0-9a-f])([0-9a-f])?$/i,x=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i,C=/^rgb\(\s*(-?\d{1,10})\s*,\s*(-?\d{1,10})\s*,\s*(-?\d{1,10})\s*\)$/,y=/^rgba\(\s*(-?\d{1,10})\s*,\s*(-?\d{1,10})\s*,\s*(-?\d{1,10})\s*,\s*(-?[\d]{0,10}(?:\.\d+)?)\s*\)$/;function P(t){t=t.toLowerCase();{const e=y.exec(t)||C.exec(t);if(e)return[S(parseInt(e[1],10)),S(parseInt(e[2],10)),S(parseInt(e[3],10)),b(e.length<5?1:parseFloat(e[4]))]}{const e=x.exec(t);if(e)return[S(parseInt(e[1],16)),S(parseInt(e[2],16)),S(parseInt(e[3],16)),1]}{const e=w.exec(t);if(e)return[S(17*parseInt(e[1],16)),S(17*parseInt(e[2],16)),S(17*parseInt(e[3],16)),1]}throw new Error(`Cannot parse color: ${t}`)}function M(t){const e=P(t);return{background:`rgb(${e[0]}, ${e[1]}, ${e[2]})`,foreground:(i=e,.199*i[0]+.687*i[1]+.114*i[2]>160?"black":"white")};var i}function T(t,e,i,s,n,o){t.fillRect(e+o,i,s-2*o,o),t.fillRect(e+o,i+n-o,s-2*o,o),t.fillRect(e,i,o,n),t.fillRect(e+s-o,i,o,n)}function k(t,e,i,s,n,o){t.save(),t.globalCompositeOperation="copy",t.fillStyle=o,t.fillRect(e,i,s,n),t.restore()}function E(t,e){return t.map((t=>0===t?t:t+e))}function z(t,e,i,s,n,o){t.beginPath(),t.lineTo(e+s-o[1],i),0!==o[1]&&t.arcTo(e+s,i,e+s,i+o[1],o[1]),t.lineTo(e+s,i+n-o[2]),0!==o[2]&&t.arcTo(e+s,i+n,e+s-o[2],i+n,o[2]),t.lineTo(e+o[3],i+n),0!==o[3]&&t.arcTo(e,i+n,e,i+n-o[3],o[3]),t.lineTo(e,i+o[0]),0!==o[0]&&t.arcTo(e,i,e+o[0],i,o[0])}function R(t,e,i,s,n,o,r=0,a=[0,0,0,0],l=""){if(t.save(),!r||!l||l===o)return z(t,e,i,s,n,a),t.fillStyle=o,t.fill(),void t.restore();const h=r/2;"transparent"!==o&&(z(t,e+r,i+r,s-2*r,n-2*r,E(a,-r)),t.fillStyle=o,t.fill()),"transparent"!==l&&(z(t,e+h,i+h,s-r,n-r,E(a,-h)),t.lineWidth=r,t.strokeStyle=l,t.closePath(),t.stroke()),t.restore()}function B(t,e,i,s,n,o,r){t.save(),t.globalCompositeOperation="copy";const a=t.createLinearGradient(0,0,0,n);a.addColorStop(0,o),a.addColorStop(1,r),t.fillStyle=a,t.fillRect(e,i,s,n),t.restore()}function I(t,e,i){const s=Math.max(0,e-1),n=Math.min(t.length-1,i+1);var o,r;return[(o=t[e],r=_(u(t[i],t[s]),6),{x:o.x+r.x,y:o.y+r.y}),u(t[i],_(u(t[n],t[e]),6))]}function O(i,s){if(!t(i))return"n/a";if(!e(s))throw new TypeError("invalid length");if(s<0||s>16)throw new TypeError("invalid length");return 0===s?i.toString():("0000000000000000"+i.toString()).slice(-s)}class V{constructor(i,s){if(s||(s=1),t(i)&&e(i)||(i=100),i<0)throw new TypeError("invalid base");this._priceScale=i,this._minMove=s,this._calculateDecimal()}format(t){const e=t<0?"âˆ’":"";return t=Math.abs(t),e+this._formatAsDecimal(t)}_calculateDecimal(){if(this._fractionalLength=0,this._priceScale>0&&this._minMove>0){let t=this._priceScale;for(;t>1;)t/=10,this._fractionalLength++}}_formatAsDecimal(t){const e=this._priceScale/this._minMove;let i=Math.floor(t),s="";const n=void 0!==this._fractionalLength?this._fractionalLength:NaN;if(e>1){let o=+(Math.round(t*e)-i*e).toFixed(this._fractionalLength);o>=e&&(o-=e,i+=1),s="."+O(+o.toFixed(this._fractionalLength)*this._minMove,n)}else i=Math.round(i*e)/e,n>0&&(s="."+O(0,n));return i.toFixed(0)+s}}class D extends V{constructor(t=100){super(t)}format(t){return`${super.format(t)}%`}}class A{constructor(t){this._precision=t}format(t){let e="";return t<0&&(e="-",t=-t),t<995?e+this._formatNumber(t):t<999995?e+this._formatNumber(t/1e3)+"K":t<999999995?(t=1e3*Math.round(t/1e3),e+this._formatNumber(t/1e6)+"M"):(t=1e6*Math.round(t/1e6),e+this._formatNumber(t/1e9)+"B")}_formatNumber(t){let e;const i=Math.pow(10,this._precision);return e=(t=Math.round(t*i)/i)>=1e-15&&t<1?t.toFixed(this._precision).replace(/\.?0+$/,""):String(t),e.replace(/(\.[1-9]*)0+$/,((t,e)=>e))}}const L=t=>t.getUTCFullYear();class W{constructor(t="yyyy-MM-dd",e="default"){this._dateFormat=t,this._locale=e}format(t){return function(t,e,i){return e.replace(/yyyy/g,(t=>O(L(t),4))(t)).replace(/yy/g,(t=>O(L(t)%100,2))(t)).replace(/MMMM/g,((t,e)=>new Date(t.getUTCFullYear(),t.getUTCMonth(),1).toLocaleString(e,{month:"long"}))(t,i)).replace(/MMM/g,((t,e)=>new Date(t.getUTCFullYear(),t.getUTCMonth(),1).toLocaleString(e,{month:"short"}))(t,i)).replace(/MM/g,(t=>O((t=>t.getUTCMonth()+1)(t),2))(t)).replace(/dd/g,(t=>O((t=>t.getUTCDate())(t),2))(t))}(t,this._dateFormat,this._locale)}}class F{constructor(t){this._formatStr=t||"%h:%m:%s"}format(t){return this._formatStr.replace("%h",O(t.getUTCHours(),2)).replace("%m",O(t.getUTCMinutes(),2)).replace("%s",O(t.getUTCSeconds(),2))}}const N={dateFormat:"yyyy-MM-dd",timeFormat:"%h:%m:%s",dateTimeSeparator:" ",locale:"default"};class H{constructor(t={}){const e=Object.assign(Object.assign({},N),t);this._dateFormatter=new W(e.dateFormat,e.locale),this._timeFormatter=new F(e.timeFormat),this._separator=e.dateTimeSeparator}format(t){return`${this._dateFormatter.format(t)}${this._separator}${this._timeFormatter.format(t)}`}}class U{draw(t,e,i){t.useBitmapCoordinateSpace((t=>this._drawImpl(t,e,i)))}}class Y extends U{constructor(t){super(),this._data=t}_drawImpl({context:t,bitmapSize:e,horizontalPixelRatio:i,verticalPixelRatio:s}){if(null===this._data)return;const n=this._data.vertLine.visible,o=this._data.horzLine.visible;if(!n&&!o)return;const r=Math.round(this._data.x*i),a=Math.round(this._data.y*s);t.lineCap="butt",n&&r>=0&&(t.lineWidth=Math.floor(this._data.vertLine.lineWidth*i),t.strokeStyle=this._data.vertLine.color,t.fillStyle=this._data.vertLine.color,f(t,this._data.vertLine.lineStyle),function(t,e,i,s){t.beginPath();const n=t.lineWidth%2?.5:0;t.moveTo(e+n,0),t.lineTo(e+n,s),t.stroke()}(t,r,0,e.height)),o&&a>=0&&(t.lineWidth=Math.floor(this._data.horzLine.lineWidth*s),t.strokeStyle=this._data.horzLine.color,t.fillStyle=this._data.horzLine.color,f(t,this._data.horzLine.lineStyle),v(t,a,0,e.width))}}class j{constructor(t){this._invalidated=!0,this._rendererData={vertLine:{lineWidth:1,lineStyle:0,color:"",visible:!1},horzLine:{lineWidth:1,lineStyle:0,color:"",visible:!1},x:0,y:0},this._renderer=new Y(this._rendererData),this._source=t}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){const t=this._source.visible(),e=h(this._source.pane()),i=e.model().options().crosshair,s=this._rendererData;s.horzLine.visible=t&&this._source.horzLineVisible(e),s.vertLine.visible=t&&this._source.vertLineVisible(),s.horzLine.lineWidth=i.horzLine.width,s.horzLine.lineStyle=i.horzLine.style,s.horzLine.color=i.horzLine.color,s.vertLine.lineWidth=i.vertLine.width,s.vertLine.lineStyle=i.vertLine.style,s.vertLine.color=i.vertLine.color,s.x=this._source.appliedX(),s.y=this._source.appliedY()}}class ${constructor(t,e){this.setData(t,e)}setData(t,e){this._data=t,this._commonData=e}height(t,e){return this._data.visible?t.fontSize+t.paddingTop+t.paddingBottom:0}draw(t,e,i,s){if(!this._data.visible||0===this._data.text.length)return;const n=this._data.color,o=this._commonData.background,r=t.useBitmapCoordinateSpace((t=>{const r=t.context;r.font=e.font;const a=this._calculateGeometry(t,e,i,s),l=a.bitmap,h=(t,e)=>{a.alignRight?R(r,l.xOutside,l.yTop,l.totalWidth,l.totalHeight,t,l.horzBorder,[l.radius,0,0,l.radius],e):R(r,l.xInside,l.yTop,l.totalWidth,l.totalHeight,t,l.horzBorder,[0,l.radius,l.radius,0],e)};return h(o,"transparent"),this._data.tickVisible&&(r.fillStyle=n,r.fillRect(l.xInside,l.yMid,l.xTick-l.xInside,l.tickHeight)),h("transparent",o),this._data.borderVisible&&(r.fillStyle=e.paneBackgroundColor,r.fillRect(a.alignRight?l.right-l.horzBorder:0,l.yTop,l.horzBorder,l.yBottom-l.yTop)),a}));t.useMediaCoordinateSpace((({context:t})=>{const i=r.media;t.font=e.font,t.textAlign=r.alignRight?"right":"left",t.textBaseline="middle",t.fillStyle=n,t.fillText(this._data.text,i.xText,(i.yTop+i.yBottom)/2+i.textMidCorrection)}))}_calculateGeometry(t,e,i,s){var n;const{context:o,bitmapSize:r,mediaSize:a,horizontalPixelRatio:l,verticalPixelRatio:h}=t,c=this._data.tickVisible||!this._data.moveTextToInvisibleTick?e.tickLength:0,d=this._data.separatorVisible?e.borderSize:0,u=e.paddingTop+this._commonData.additionalPaddingTop,_=e.paddingBottom+this._commonData.additionalPaddingBottom,p=e.paddingInner,m=e.paddingOuter,g=this._data.text,f=e.fontSize,v=i.yMidCorrection(o,g),S=Math.ceil(i.measureText(o,g)),b=f+u+_,w=e.borderSize+p+m+S+c,x=Math.max(1,Math.floor(h));let C=Math.round(b*h);C%2!=x%2&&(C+=1);const y=d>0?Math.max(1,Math.floor(d*l)):0,P=Math.round(w*l),M=Math.round(c*l),T=null!==(n=this._commonData.fixedCoordinate)&&void 0!==n?n:this._commonData.coordinate,k=Math.round(T*h)-Math.floor(.5*h),E=Math.floor(k+x/2-C/2),z=E+C,R="right"===s,B=R?a.width-d:d,I=R?r.width-y:y;let O,V,D;return R?(O=I-P,V=I-M,D=B-c-p-d):(O=I+P,V=I+M,D=B+c+p),{alignRight:R,bitmap:{yTop:E,yMid:k,yBottom:z,totalWidth:P,totalHeight:C,radius:2*l,horzBorder:y,xOutside:O,xInside:I,xTick:V,tickHeight:x,right:r.width},media:{yTop:E/h,yBottom:z/h,xText:D,textMidCorrection:v}}}}class X{constructor(t){this._commonRendererData={coordinate:0,background:"#000",additionalPaddingBottom:0,additionalPaddingTop:0},this._axisRendererData={text:"",visible:!1,tickVisible:!0,moveTextToInvisibleTick:!1,borderColor:"",color:"#FFF",borderVisible:!1,separatorVisible:!1},this._paneRendererData={text:"",visible:!1,tickVisible:!1,moveTextToInvisibleTick:!0,borderColor:"",color:"#FFF",borderVisible:!0,separatorVisible:!0},this._invalidated=!0,this._axisRenderer=new(t||$)(this._axisRendererData,this._commonRendererData),this._paneRenderer=new(t||$)(this._paneRendererData,this._commonRendererData)}text(){return this._axisRendererData.text}coordinate(){return this._commonRendererData.coordinate}update(){}height(t,e=!1){return Math.max(this._axisRenderer.height(t,e),this._paneRenderer.height(t,e))}getFixedCoordinate(){return this._commonRendererData.fixedCoordinate||0}setFixedCoordinate(t){this._commonRendererData.fixedCoordinate=t}isVisible(){return this._updateRendererDataIfNeeded(),this._axisRendererData.visible||this._paneRendererData.visible}isAxisLabelVisible(){return this._updateRendererDataIfNeeded(),this._axisRendererData.visible}renderer(t){return this._updateRendererDataIfNeeded(),this._axisRendererData.tickVisible=this._axisRendererData.tickVisible&&t.options().ticksVisible,this._paneRendererData.tickVisible=this._paneRendererData.tickVisible&&t.options().ticksVisible,this._axisRenderer.setData(this._axisRendererData,this._commonRendererData),this._paneRenderer.setData(this._paneRendererData,this._commonRendererData),this._axisRenderer}paneRenderer(){return this._updateRendererDataIfNeeded(),this._axisRenderer.setData(this._axisRendererData,this._commonRendererData),this._paneRenderer.setData(this._paneRendererData,this._commonRendererData),this._paneRenderer}_updateRendererDataIfNeeded(){this._invalidated&&(this._axisRendererData.tickVisible=!0,this._paneRendererData.tickVisible=!1,this._updateRendererData(this._axisRendererData,this._paneRendererData,this._commonRendererData))}}class G extends X{constructor(t,e,i){super(),this._source=t,this._priceScale=e,this._valueProvider=i}_updateRendererData(t,e,i){t.visible=!1;const s=this._source.options().horzLine;if(!s.labelVisible)return;const n=this._priceScale.firstValue();if(!this._source.visible()||this._priceScale.isEmpty()||null===n)return;const o=M(s.labelBackgroundColor);i.background=o.background,t.color=o.foreground;const r=2/12*this._priceScale.fontSize();i.additionalPaddingTop=r,i.additionalPaddingBottom=r;const a=this._valueProvider(this._priceScale);i.coordinate=a.coordinate,t.text=this._priceScale.formatPrice(a.price,n),t.visible=!0}}const K=/[1-9]/g;class Z{constructor(){this._data=null}setData(t){this._data=t}draw(t,e){if(null===this._data||!1===this._data.visible||0===this._data.text.length)return;const i=t.useMediaCoordinateSpace((({context:t})=>(t.font=e.font,Math.round(e.widthCache.measureText(t,h(this._data).text,K)))));if(i<=0)return;const s=e.paddingHorizontal,n=i+2*s,o=n/2,r=this._data.width;let a=this._data.coordinate,l=Math.floor(a-o)+.5;l<0?(a+=Math.abs(0-l),l=Math.floor(a-o)+.5):l+n>r&&(a-=Math.abs(r-(l+n)),l=Math.floor(a-o)+.5);const c=l+n,d=Math.ceil(0+e.borderSize+e.tickLength+e.paddingTop+e.fontSize+e.paddingBottom);t.useBitmapCoordinateSpace((({context:t,horizontalPixelRatio:i,verticalPixelRatio:s})=>{const n=h(this._data);t.fillStyle=n.background;const o=Math.round(l*i),r=Math.round(0*s),a=Math.round(c*i),u=Math.round(d*s),_=Math.round(2*i);if(t.beginPath(),t.moveTo(o,r),t.lineTo(o,u-_),t.arcTo(o,u,o+_,u,_),t.lineTo(a-_,u),t.arcTo(a,u,a,u-_,_),t.lineTo(a,r),t.fill(),n.tickVisible){const o=Math.round(n.coordinate*i),a=r,l=Math.round((a+e.tickLength)*s);t.fillStyle=n.color;const h=Math.max(1,Math.floor(i)),c=Math.floor(.5*i);t.fillRect(o-c,a,h,l-a)}})),t.useMediaCoordinateSpace((({context:t})=>{const i=h(this._data),n=0+e.borderSize+e.tickLength+e.paddingTop+e.fontSize/2;t.font=e.font,t.textAlign="left",t.textBaseline="middle",t.fillStyle=i.color;const o=e.widthCache.yMidCorrection(t,"Apr0");t.translate(l+s,n+o),t.fillText(i.text,0,0)}))}}class q{constructor(t,e,i){this._invalidated=!0,this._renderer=new Z,this._rendererData={visible:!1,background:"#4c525e",color:"white",text:"",width:0,coordinate:NaN,tickVisible:!0},this._crosshair=t,this._model=e,this._valueProvider=i}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer.setData(this._rendererData),this._renderer}_updateImpl(){const t=this._rendererData;t.visible=!1;const e=this._crosshair.options().vertLine;if(!e.labelVisible)return;const i=this._model.timeScale();if(i.isEmpty())return;t.width=i.width();const s=this._valueProvider();if(null===s)return;t.coordinate=s.coordinate;const n=i.indexToTimeScalePoint(this._crosshair.appliedIndex());t.text=i.formatDateTime(h(n)),t.visible=!0;const o=M(e.labelBackgroundColor);t.background=o.background,t.color=o.foreground,t.tickVisible=i.options().ticksVisible}}class Q{constructor(){this._priceScale=null,this._zorder=0}zorder(){return this._zorder}setZorder(t){this._zorder=t}priceScale(){return this._priceScale}setPriceScale(t){this._priceScale=t}labelPaneViews(t){return[]}timeAxisViews(){return[]}visible(){return!0}}class J extends Q{constructor(t,e){super(),this._pane=null,this._price=NaN,this._index=0,this._visible=!0,this._priceAxisViews=new Map,this._subscribed=!1,this._x=NaN,this._y=NaN,this._originX=NaN,this._originY=NaN,this._model=t,this._options=e,this._currentPosPriceProvider=((t,e)=>i=>{const s=e(),n=t();if(i===h(this._pane).defaultPriceScale())return{price:n,coordinate:s};{const t=h(i.firstValue());return{price:i.coordinateToPrice(s,t),coordinate:s}}})((()=>this._price),(()=>this._y));const i=((t,e)=>()=>{const i=this._model.timeScale().indexToTime(t()),s=e();return i&&Number.isFinite(s)?{time:i,coordinate:s}:null})((()=>this._index),(()=>this.appliedX()));this._timeAxisView=new q(this,t,i),this._paneView=new j(this)}options(){return this._options}saveOriginCoord(t,e){this._originX=t,this._originY=e}clearOriginCoord(){this._originX=NaN,this._originY=NaN}originCoordX(){return this._originX}originCoordY(){return this._originY}setPosition(t,e,i){this._subscribed||(this._subscribed=!0),this._visible=!0,this._tryToUpdateViews(t,e,i)}appliedIndex(){return this._index}appliedX(){return this._x}appliedY(){return this._y}visible(){return this._visible}clearPosition(){this._visible=!1,this._setIndexToLastSeriesBarIndex(),this._price=NaN,this._x=NaN,this._y=NaN,this._pane=null,this.clearOriginCoord()}paneViews(t){return null!==this._pane?[this._paneView]:[]}horzLineVisible(t){return t===this._pane&&this._options.horzLine.visible}vertLineVisible(){return this._options.vertLine.visible}priceAxisViews(t,e){this._visible&&this._pane===t||this._priceAxisViews.clear();const i=[];return this._pane===t&&i.push(this._createPriceAxisViewOnDemand(this._priceAxisViews,e,this._currentPosPriceProvider)),i}timeAxisViews(){return this._visible?[this._timeAxisView]:[]}pane(){return this._pane}updateAllViews(){this._paneView.update()}_priceScaleByPane(t){return t&&!t.defaultPriceScale().isEmpty()?t.defaultPriceScale():null}_tryToUpdateViews(t,e,i){this._tryToUpdateData(t,e,i)&&this.updateAllViews()}_tryToUpdateData(t,e,i){const s=this._x,n=this._y,o=this._price,r=this._index,a=this._pane,l=this._priceScaleByPane(i);this._index=t,this._x=isNaN(t)?NaN:this._model.timeScale().indexToCoordinate(t),this._pane=i;const h=null!==l?l.firstValue():null;return null!==l&&null!==h?(this._price=e,this._y=l.priceToCoordinate(e,h)):(this._price=NaN,this._y=NaN),s!==this._x||n!==this._y||r!==this._index||o!==this._price||a!==this._pane}_setIndexToLastSeriesBarIndex(){const t=this._model.serieses().map((t=>t.bars().lastIndex())).filter(o),e=0===t.length?null:Math.max(...t);this._index=null!==e?e:NaN}_createPriceAxisViewOnDemand(t,e,i){let s=t.get(e);return void 0===s&&(s=new G(this,e,i),t.set(e,s)),s}}class tt extends U{constructor(){super(...arguments),this._data=null}setData(t){this._data=t}_drawImpl(t){if(null===this._data)return;const{items:e,visibleRange:i,barWidth:s,lineType:n,lineWidth:o,lineStyle:r}=this._data;if(null===i)return;const a=t.context;a.lineCap="butt",a.lineWidth=o*t.verticalPixelRatio,f(a,r),a.lineJoin="round";const l=this._strokeStyle.bind(this);void 0!==n&&function(t,e,i,s,n,o){function r(t,e){const i=t.context;i.strokeStyle=e,i.stroke()}if(0===e.length||s.from>=e.length||s.to<=0)return;const{context:a,horizontalPixelRatio:l,verticalPixelRatio:h}=t,c=e[s.from];let d=o(t,c),u=c;if(s.to-s.from<2){const e=n/2;a.beginPath();const i={x:c.x-e,y:c.y},s={x:c.x+e,y:c.y};a.moveTo(i.x*l,i.y*h),a.lineTo(s.x*l,s.y*h),r(t,d)}else{const n=(e,i)=>{r(t,d),a.beginPath(),d=e,u=i};let _=u;a.beginPath(),a.moveTo(c.x*l,c.y*h);for(let r=s.from+1;r<s.to;++r){_=e[r];const s=o(t,_);switch(i){case 0:a.lineTo(_.x*l,_.y*h);break;case 1:a.lineTo(_.x*l,e[r-1].y*h),s!==d&&(n(s,_),a.lineTo(_.x*l,e[r-1].y*h)),a.lineTo(_.x*l,_.y*h);break;case 2:{const[t,i]=I(e,r-1,r);a.bezierCurveTo(t.x*l,t.y*h,i.x*l,i.y*h,_.x*l,_.y*h);break}}1!==i&&s!==d&&(n(s,_),a.moveTo(_.x*l,_.y*h))}(u!==_||u===_&&1===i)&&r(t,d)}}(t,e,n,i,s,l)}}class et extends tt{_strokeStyle(t,e){return e.lineColor}}function it(t,e,i,s,n=0,o=e.length){let r=o-n;for(;0<r;){const o=r>>1,a=n+o;s(e[a],i)===t?(n=a+1,r-=o+1):r=o}return n}const st=it.bind(null,!0),nt=it.bind(null,!1);function ot(t,e){return t.time<e}function rt(t,e){return e<t.time}class at{constructor(t,e,i){this._invalidated=!0,this._dataInvalidated=!0,this._optionsInvalidated=!0,this._items=[],this._itemsVisibleRange=null,this._series=t,this._model=e,this._extendedVisibleRange=i}update(t){this._invalidated=!0,"data"===t&&(this._dataInvalidated=!0),"options"===t&&(this._optionsInvalidated=!0)}renderer(){return this._series.visible()?(this._makeValid(),null===this._itemsVisibleRange?null:this._renderer):null}_updateOptions(){}_clearVisibleRange(){this._itemsVisibleRange=null}_makeValid(){this._dataInvalidated&&(this._fillRawPoints(),this._dataInvalidated=!1),this._invalidated&&(this._makeValidImpl(),this._invalidated=!1)}_makeValidImpl(){const t=this._series.priceScale(),e=this._model.timeScale();if(this._clearVisibleRange(),e.isEmpty()||t.isEmpty())return;const i=e.visibleStrictRange();if(null===i)return;if(0===this._series.bars().size())return;const s=this._series.firstValue();null!==s&&(this._itemsVisibleRange=function(t,e,i){const s=e.left(),n=e.right(),o=st(t,s,ot),r=nt(t,n,rt);if(!i)return{from:o,to:r};let a=o,l=r;return o>0&&o<t.length&&t[o].time>=s&&(a=o-1),r>0&&r<t.length&&t[r-1].time<=n&&(l=r+1),{from:a,to:l}}(this._items,i,this._extendedVisibleRange),this._convertToCoordinates(t,e,s.value),this._prepareRendererData())}}class lt extends at{constructor(t,e){super(t,e,!0)}_convertToCoordinates(t,e,i){e.indexesToCoordinates(this._items,r(this._itemsVisibleRange)),t.pointsArrayToCoordinates(this._items,i,r(this._itemsVisibleRange))}_createRawItemBase(t,e){return{time:t,price:e,x:NaN,y:NaN}}_fillRawPoints(){const t=this._series.barColorer();this._items=this._series.bars().rows().map((e=>{const i=e.value[3];return this._createRawItem(e.index,i,t)}))}}class ht extends at{constructor(t,e){super(t,e,!1)}_convertToCoordinates(t,e,i){e.indexesToCoordinates(this._items,r(this._itemsVisibleRange)),t.barPricesToCoordinates(this._items,i,r(this._itemsVisibleRange))}_createDefaultItem(t,e,i){return{time:t,open:e.value[0],high:e.value[1],low:e.value[2],close:e.value[3],x:NaN,openY:NaN,highY:NaN,lowY:NaN,closeY:NaN}}_fillRawPoints(){const t=this._series.barColorer();this._items=this._series.bars().rows().map((e=>this._createRawItem(e.index,e,t)))}}class ct extends U{constructor(){super(...arguments),this._data=null,this._barWidth=0}setData(t){this._data=t}_drawImpl(t){if(null===this._data||0===this._data.bars.length||null===this._data.visibleRange)return;const{horizontalPixelRatio:e}=t;this._barWidth=function(t,e){if(t>=2.5&&t<=4)return Math.floor(3*e);const i=1-.2*Math.atan(Math.max(4,t)-4)/(.5*Math.PI),s=Math.floor(t*i*e),n=Math.floor(t*e),o=Math.min(s,n);return Math.max(Math.floor(e),o)}(this._data.barSpacing,e),this._barWidth>=2&&Math.floor(e)%2!=this._barWidth%2&&this._barWidth--;const i=this._data.bars;this._data.wickVisible&&this._drawWicks(t,i,this._data.visibleRange),this._data.borderVisible&&this._drawBorder(t,i,this._data.visibleRange);const s=this._calculateBorderWidth(e);(!this._data.borderVisible||this._barWidth>2*s)&&this._drawCandles(t,i,this._data.visibleRange)}_drawWicks(t,e,i){if(null===this._data)return;const{context:s,horizontalPixelRatio:n,verticalPixelRatio:o}=t;let r="",a=Math.min(Math.floor(n),Math.floor(this._data.barSpacing*n));a=Math.max(Math.floor(n),Math.min(a,this._barWidth));const l=Math.floor(.5*a);let h=null;for(let t=i.from;t<i.to;t++){const i=e[t];i.barWickColor!==r&&(s.fillStyle=i.barWickColor,r=i.barWickColor);const c=Math.round(Math.min(i.openY,i.closeY)*o),d=Math.round(Math.max(i.openY,i.closeY)*o),u=Math.round(i.highY*o),_=Math.round(i.lowY*o);let p=Math.round(n*i.x)-l;const m=p+a-1;null!==h&&(p=Math.max(h+1,p),p=Math.min(p,m));const g=m-p+1;s.fillRect(p,u,g,c-u),s.fillRect(p,d+1,g,_-d),h=m}}_calculateBorderWidth(t){let e=Math.floor(1*t);this._barWidth<=2*e&&(e=Math.floor(.5*(this._barWidth-1)));const i=Math.max(Math.floor(t),e);return this._barWidth<=2*i?Math.max(Math.floor(t),Math.floor(1*t)):i}_drawBorder(t,e,i){if(null===this._data)return;const{context:s,horizontalPixelRatio:n,verticalPixelRatio:o}=t;let r="";const a=this._calculateBorderWidth(n);let l=null;for(let t=i.from;t<i.to;t++){const i=e[t];i.barBorderColor!==r&&(s.fillStyle=i.barBorderColor,r=i.barBorderColor);let h=Math.round(i.x*n)-Math.floor(.5*this._barWidth);const c=h+this._barWidth-1,d=Math.round(Math.min(i.openY,i.closeY)*o),u=Math.round(Math.max(i.openY,i.closeY)*o);if(null!==l&&(h=Math.max(l+1,h),h=Math.min(h,c)),this._data.barSpacing*n>2*a)T(s,h,d,c-h+1,u-d+1,a);else{const t=c-h+1;s.fillRect(h,d,t,u-d+1)}l=c}}_drawCandles(t,e,i){if(null===this._data)return;const{context:s,horizontalPixelRatio:n,verticalPixelRatio:o}=t;let r="";for(let t=i.from;t<i.to;t++){const i=e[t];let a=Math.round(Math.min(i.openY,i.closeY)*o),l=Math.round(Math.max(i.openY,i.closeY)*o),h=Math.round(i.x*n)-Math.floor(.5*this._barWidth),c=h+this._barWidth-1;if(i.barColor!==r){const t=i.barColor;s.fillStyle=t,r=t}a>l||s.fillRect(h,a,c-h+1,l-a+1)}}}class dt extends ht{constructor(){super(...arguments),this._renderer=new ct}_createRawItem(t,e,i){return Object.assign(Object.assign({},this._createDefaultItem(t,e,i)),i.barStyle(t))}_prepareRendererData(){const t=this._series.options();this._renderer.setData({bars:this._items,barSpacing:this._model.timeScale().barSpacing(),wickVisible:t.wickVisible,borderVisible:t.borderVisible,visibleRange:this._itemsVisibleRange})}}class ut extends lt{constructor(){super(...arguments),this._renderer=new et}_createRawItem(t,e,i){return Object.assign(Object.assign({},this._createRawItemBase(t,e)),i.barStyle(t))}_prepareRendererData(){const t=this._series.options(),e={items:this._items,lineStyle:t.lineStyle,lineType:t.lineVisible?t.lineType:void 0,lineWidth:t.lineWidth,visibleRange:this._itemsVisibleRange,barWidth:this._model.timeScale().barSpacing()};this._renderer.setData(e)}}const _t=/[2-9]/g;class pt{constructor(t=50){this._actualSize=0,this._usageTick=1,this._oldestTick=1,this._tick2Labels={},this._cache=new Map,this._maxSize=t}reset(){this._actualSize=0,this._cache.clear(),this._usageTick=1,this._oldestTick=1,this._tick2Labels={}}measureText(t,e,i){return this._getMetrics(t,e,i).width}yMidCorrection(t,e,i){const s=this._getMetrics(t,e,i);return((s.actualBoundingBoxAscent||0)-(s.actualBoundingBoxDescent||0))/2}_getMetrics(t,e,i){const s=i||_t,n=String(e).replace(s,"0");if(this._cache.has(n))return l(this._cache.get(n)).metrics;if(this._actualSize===this._maxSize){const t=this._tick2Labels[this._oldestTick];delete this._tick2Labels[this._oldestTick],this._cache.delete(t),this._oldestTick++,this._actualSize--}t.save(),t.textBaseline="middle";const o=t.measureText(n);return t.restore(),0===o.width&&e.length||(this._cache.set(n,{metrics:o,tick:this._usageTick}),this._tick2Labels[this._usageTick]=n,this._actualSize++,this._usageTick++),o}}class mt{constructor(t){this._priceAxisViewRenderer=null,this._rendererOptions=null,this._align="right",this._textWidthCache=t}setParams(t,e,i){this._priceAxisViewRenderer=t,this._rendererOptions=e,this._align=i}draw(t){null!==this._rendererOptions&&null!==this._priceAxisViewRenderer&&this._priceAxisViewRenderer.draw(t,this._rendererOptions,this._textWidthCache,this._align)}}class gt{constructor(t,e,i){this._priceAxisView=t,this._textWidthCache=new pt(50),this._dataSource=e,this._chartModel=i,this._fontSize=-1,this._renderer=new mt(this._textWidthCache)}renderer(){const t=this._chartModel.paneForSource(this._dataSource);if(null===t)return null;const e=t.isOverlay(this._dataSource)?t.defaultVisiblePriceScale():this._dataSource.priceScale();if(null===e)return null;const i=t.priceScalePosition(e);if("overlay"===i)return null;const s=this._chartModel.priceAxisRendererOptions();return s.fontSize!==this._fontSize&&(this._fontSize=s.fontSize,this._textWidthCache.reset()),this._renderer.setParams(this._priceAxisView.paneRenderer(),s,i),this._renderer}}class ft extends U{constructor(){super(...arguments),this._data=null}setData(t){this._data=t}hitTest(t,e){var i;if(!(null===(i=this._data)||void 0===i?void 0:i.visible))return null;const{y:s,lineWidth:n,externalId:o}=this._data;return e>=s-n-7&&e<=s+n+7?{hitTestData:this._data,externalId:o}:null}_drawImpl({context:t,bitmapSize:e,horizontalPixelRatio:i,verticalPixelRatio:s}){if(null===this._data)return;if(!1===this._data.visible)return;const n=Math.round(this._data.y*s);n<0||n>e.height||(t.lineCap="butt",t.strokeStyle=this._data.color,t.lineWidth=Math.floor(this._data.lineWidth*i),f(t,this._data.lineStyle),v(t,n,0,e.width))}}class vt{constructor(t){this._lineRendererData={y:0,color:"rgba(0, 0, 0, 0)",lineWidth:1,lineStyle:0,visible:!1},this._lineRenderer=new ft,this._invalidated=!0,this._series=t,this._lineRenderer.setData(this._lineRendererData)}update(){this._invalidated=!0}renderer(){return this._series.visible()?(this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._lineRenderer):null}}class St extends vt{constructor(t){super(t)}_updateImpl(){const t=this._lineRendererData;t.visible=!1;const e=this._series.options();if(!e.priceLineVisible||!this._series.visible())return;const i=this._series.lastValueData(0===e.priceLineSource);i.noData||(t.visible=!0,t.y=i.coordinate,t.color=this._series.priceLineColor(i.color),t.lineWidth=e.priceLineWidth,t.lineStyle=e.priceLineStyle)}}class bt extends X{constructor(t){super(),this._source=t}_updateRendererData(t,e,i){t.visible=!1,e.visible=!1;const s=this._source;if(!s.visible())return;const n=s.options().lastValueVisible,o=""!==s.title(),r=!0,a=s.lastValueData(!1);if(a.noData)return;n&&(t.text=this._axisText(a,n,r),t.visible=0!==t.text.length),e.text=this._paneText(a,n,o,r),e.visible=e.text.length>0;const l=s.priceLineColor(a.color),h=M(l);i.background=h.background,i.coordinate=a.coordinate,e.borderColor=s.model().backgroundColorAtYPercentFromTop(a.coordinate/s.priceScale().height()),t.borderColor=l,t.color=h.foreground,e.color=h.foreground}_paneText(t,e,i,s){let n="";const o=this._source.title();return i&&0!==o.length&&(n+=`${o} `),e&&s&&(n+=this._source.priceScale().isPercentage()?t.formattedPriceAbsolute:t.formattedPricePercentage),n.trim()}_axisText(t,e,i){return e?i?this._source.priceScale().isPercentage()?t.formattedPricePercentage:t.formattedPriceAbsolute:t.text:""}}class wt{constructor(){this._listeners=[]}subscribe(t,e,i){const s={callback:t,linkedObject:e,singleshot:!0===i};this._listeners.push(s)}unsubscribeAll(t){this._listeners=this._listeners.filter((e=>e.linkedObject!==t))}fire(t,e,i){const s=[...this._listeners];this._listeners=this._listeners.filter((t=>!t.singleshot)),s.forEach((s=>s.callback(t,e,i)))}hasListeners(){return this._listeners.length>0}destroy(){this._listeners=[]}}const xt="-apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif";function Ct(t,e,i){return void 0===e&&(e=xt),`${i=void 0!==i?`${i} `:""}${t}px ${e}`}function yt(t){return"left"===t||"right"===t}class Pt{constructor(t){this._invalidatedPanes=new Map,this._timeScaleInvalidations=[],this._globalLevel=t}invalidatePane(t,e){const i=function(t,e){return void 0===t?e:{level:Math.max(t.level,e.level),autoScale:t.autoScale||e.autoScale}}(this._invalidatedPanes.get(t),e);this._invalidatedPanes.set(t,i)}fullInvalidation(){return this._globalLevel}invalidateForPane(t){const e=this._invalidatedPanes.get(t);return void 0===e?{level:this._globalLevel}:{level:Math.max(this._globalLevel,e.level),autoScale:e.autoScale}}setFitContent(){this.stopTimeScaleAnimation(),this._timeScaleInvalidations=[{type:0}]}applyRange(t){this.stopTimeScaleAnimation(),this._timeScaleInvalidations=[{type:1,value:t}]}setTimeScaleAnimation(t){this._removeTimeScaleAnimation(),this._timeScaleInvalidations.push({type:5,value:t})}stopTimeScaleAnimation(){this._removeTimeScaleAnimation(),this._timeScaleInvalidations.push({type:6})}resetTimeScale(){this.stopTimeScaleAnimation(),this._timeScaleInvalidations=[{type:4}]}setBarSpacing(t){this.stopTimeScaleAnimation(),this._timeScaleInvalidations.push({type:2,value:t})}setRightOffset(t){this.stopTimeScaleAnimation(),this._timeScaleInvalidations.push({type:3,value:t})}timeScaleInvalidations(){return this._timeScaleInvalidations}merge(t){for(const e of t._timeScaleInvalidations)this._applyTimeScaleInvalidation(e);this._globalLevel=Math.max(this._globalLevel,t._globalLevel),t._invalidatedPanes.forEach(((t,e)=>{this.invalidatePane(e,t)}))}static light(){return new Pt(2)}static full(){return new Pt(3)}_applyTimeScaleInvalidation(t){switch(t.type){case 0:this.setFitContent();break;case 1:this.applyRange(t.value);break;case 2:this.setBarSpacing(t.value);break;case 3:this.setRightOffset(t.value);break;case 4:this.resetTimeScale();break;case 5:this.setTimeScaleAnimation(t.value);break;case 6:this._removeTimeScaleAnimation()}}_removeTimeScaleAnimation(){const t=this._timeScaleInvalidations.findIndex((t=>5===t.type));-1!==t&&this._timeScaleInvalidations.splice(t,1)}}class Mt{constructor(t,e){this._minValue=t,this._maxValue=e}equals(t){return null!==t&&this._minValue===t._minValue&&this._maxValue===t._maxValue}clone(){return new Mt(this._minValue,this._maxValue)}minValue(){return this._minValue}maxValue(){return this._maxValue}length(){return this._maxValue-this._minValue}isEmpty(){return this._maxValue===this._minValue||Number.isNaN(this._maxValue)||Number.isNaN(this._minValue)}merge(t){function e(t,e,i,s){const n=Number.isFinite(e),o=Number.isFinite(i);return n&&o?t(e,i):n||o?n?e:i:s}return null===t?this:new Mt(e(Math.min,this.minValue(),t.minValue(),-1/0),e(Math.max,this.maxValue(),t.maxValue(),1/0))}scaleAroundCenter(e){if(!t(e))return;if(0==this._maxValue-this._minValue)return;const i=.5*(this._maxValue+this._minValue);let s=this._maxValue-i,n=this._minValue-i;s*=e,n*=e,this._maxValue=i+s,this._minValue=i+n}shift(e){t(e)&&(this._maxValue+=e,this._minValue+=e)}toRaw(){return{minValue:this._minValue,maxValue:this._maxValue}}static fromRaw(t){return null===t?null:new Mt(t.minValue,t.maxValue)}}class Tt{constructor(t,e){this._priceRange=t,this._margins=e||null}priceRange(){return this._priceRange}margins(){return this._margins}toRaw(){return null===this._priceRange?null:{priceRange:this._priceRange.toRaw(),margins:this._margins||void 0}}static fromRaw(t){return null===t?null:new Tt(Mt.fromRaw(t.priceRange),t.margins)}}class kt extends Q{constructor(t){super(),this._model=t}model(){return this._model}}const Et={Bar:(t,e,i,s)=>{var n;const o=e.upColor,r=e.downColor,a=h(t(i,s)),l=c(a.value[0])<=c(a.value[3]);return{barColor:null!==(n=a.color)&&void 0!==n?n:l?o:r}},Candlestick:(t,e,i,s)=>{var n,o,r;const a=e.upColor,l=e.downColor,d=e.borderUpColor,u=e.borderDownColor,_=e.wickUpColor,p=e.wickDownColor,m=h(t(i,s)),g=c(m.value[0])<=c(m.value[3]);return{barColor:null!==(n=m.color)&&void 0!==n?n:g?a:l,barBorderColor:null!==(o=m.borderColor)&&void 0!==o?o:g?d:u,barWickColor:null!==(r=m.wickColor)&&void 0!==r?r:g?_:p}},Custom:(t,e,i,s)=>{var n;return{barColor:null!==(n=h(t(i,s)).color)&&void 0!==n?n:e.color}},Area:(t,e,i,s)=>{var n,o,r,a;const l=h(t(i,s));return{barColor:null!==(n=l.lineColor)&&void 0!==n?n:e.lineColor,lineColor:null!==(o=l.lineColor)&&void 0!==o?o:e.lineColor,topColor:null!==(r=l.topColor)&&void 0!==r?r:e.topColor,bottomColor:null!==(a=l.bottomColor)&&void 0!==a?a:e.bottomColor}},Baseline:(t,e,i,s)=>{var n,o,r,a,l,c;const d=h(t(i,s));return{barColor:d.value[3]>=e.baseValue.price?e.topLineColor:e.bottomLineColor,topLineColor:null!==(n=d.topLineColor)&&void 0!==n?n:e.topLineColor,bottomLineColor:null!==(o=d.bottomLineColor)&&void 0!==o?o:e.bottomLineColor,topFillColor1:null!==(r=d.topFillColor1)&&void 0!==r?r:e.topFillColor1,topFillColor2:null!==(a=d.topFillColor2)&&void 0!==a?a:e.topFillColor2,bottomFillColor1:null!==(l=d.bottomFillColor1)&&void 0!==l?l:e.bottomFillColor1,bottomFillColor2:null!==(c=d.bottomFillColor2)&&void 0!==c?c:e.bottomFillColor2}},Line:(t,e,i,s)=>{var n,o;const r=h(t(i,s));return{barColor:null!==(n=r.color)&&void 0!==n?n:e.color,lineColor:null!==(o=r.color)&&void 0!==o?o:e.color}},Histogram:(t,e,i,s)=>{var n;return{barColor:null!==(n=h(t(i,s)).color)&&void 0!==n?n:e.color}}};class zt{constructor(t){this._findBar=(t,e)=>void 0!==e?e.value:this._series.bars().valueAt(t),this._series=t,this._styleGetter=Et[t.seriesType()]}barStyle(t,e){return this._styleGetter(this._findBar,this._series.options(),t,e)}}const Rt=30;class Bt{constructor(){this._items=[],this._minMaxCache=new Map,this._rowSearchCache=new Map}last(){return this.size()>0?this._items[this._items.length-1]:null}firstIndex(){return this.size()>0?this._indexAt(0):null}lastIndex(){return this.size()>0?this._indexAt(this._items.length-1):null}size(){return this._items.length}isEmpty(){return 0===this.size()}contains(t){return null!==this._search(t,0)}valueAt(t){return this.search(t)}search(t,e=0){const i=this._search(t,e);return null===i?null:Object.assign(Object.assign({},this._valueAt(i)),{index:this._indexAt(i)})}rows(){return this._items}minMaxOnRangeCached(t,e,i){if(this.isEmpty())return null;let s=null;for(const n of i)s=It(s,this._minMaxOnRangeCachedImpl(t,e,n));return s}setData(t){this._rowSearchCache.clear(),this._minMaxCache.clear(),this._items=t}_indexAt(t){return this._items[t].index}_valueAt(t){return this._items[t]}_search(t,e){const i=this._bsearch(t);if(null===i&&0!==e)switch(e){case-1:return this._searchNearestLeft(t);case 1:return this._searchNearestRight(t);default:throw new TypeError("Unknown search mode")}return i}_searchNearestLeft(t){let e=this._lowerbound(t);return e>0&&(e-=1),e!==this._items.length&&this._indexAt(e)<t?e:null}_searchNearestRight(t){const e=this._upperbound(t);return e!==this._items.length&&t<this._indexAt(e)?e:null}_bsearch(t){const e=this._lowerbound(t);return e===this._items.length||t<this._items[e].index?null:e}_lowerbound(t){return st(this._items,t,((t,e)=>t.index<e))}_upperbound(t){return nt(this._items,t,((t,e)=>t.index>e))}_plotMinMax(t,e,i){let s=null;for(let n=t;n<e;n++){const t=this._items[n].value[i];Number.isNaN(t)||(null===s?s={min:t,max:t}:(t<s.min&&(s.min=t),t>s.max&&(s.max=t)))}return s}_minMaxOnRangeCachedImpl(t,e,i){if(this.isEmpty())return null;let s=null;const n=h(this.firstIndex()),o=h(this.lastIndex()),r=Math.max(t,n),a=Math.min(e,o),l=Math.ceil(r/Rt)*Rt,c=Math.max(l,Math.floor(a/Rt)*Rt);{const t=this._lowerbound(r),n=this._upperbound(Math.min(a,l,e));s=It(s,this._plotMinMax(t,n,i))}let d=this._minMaxCache.get(i);void 0===d&&(d=new Map,this._minMaxCache.set(i,d));for(let t=Math.max(l+1,r);t<c;t+=Rt){const e=Math.floor(t/Rt);let n=d.get(e);if(void 0===n){const t=this._lowerbound(e*Rt),s=this._upperbound((e+1)*Rt-1);n=this._plotMinMax(t,s,i),d.set(e,n)}s=It(s,n)}{const t=this._lowerbound(c),e=this._upperbound(a);s=It(s,this._plotMinMax(t,e,i))}return s}}function It(t,e){return null===t?e:null===e?t:{min:Math.min(t.min,e.min),max:Math.max(t.max,e.max)}}function Ot(t){return t.paneViews()}function Vt(t){return t.priceAxisPaneViews()}function Dt(t){return t.timeAxisPaneViews()}class At extends kt{constructor(t,e,i){super(t),this._data=new Bt,this._priceLineView=new St(this),this._customPriceLines=[],this._barColorerCache=null,this._animationTimeoutId=null,this._primitives=[],this._options=e,this._seriesType=i;const s=new bt(this);this._priceAxisViews=[s],this._panePriceAxisView=new gt(s,this,t),this._recreateFormatter(),this._recreatePaneViews()}destroy(){null!==this._animationTimeoutId&&clearTimeout(this._animationTimeoutId)}priceLineColor(t){return this._options.priceLineColor||t}lastValueData(t){const e={noData:!0},i=this.priceScale();if(this.model().timeScale().isEmpty()||i.isEmpty()||this._data.isEmpty())return e;const s=this.model().timeScale().visibleStrictRange(),n=this.firstValue();if(null===s||null===n)return e;let o,r;if(t){const t=this._data.last();if(null===t)return e;o=t,r=t.index}else{const t=this._data.search(s.right(),-1);if(null===t)return e;if(o=this._data.valueAt(t.index),null===o)return e;r=t.index}const a=o.value[3],l=this.barColorer().barStyle(r,{value:o}),h=i.priceToCoordinate(a,n.value);return{noData:!1,price:a,text:i.formatPrice(a,n.value),formattedPriceAbsolute:i.formatPriceAbsolute(a),formattedPricePercentage:i.formatPricePercentage(a,n.value),color:l.barColor,coordinate:h,index:r}}barColorer(){return null!==this._barColorerCache||(this._barColorerCache=new zt(this)),this._barColorerCache}options(){return this._options}applyOptions(t){const e=t.priceScaleId;void 0!==e&&e!==this._options.priceScaleId&&this.model().moveSeriesToScale(this,e),d(this._options,t),void 0!==t.priceFormat&&(this._recreateFormatter(),this.model().fullUpdate()),this.model().updateSource(this),this.model().updateCrosshair(),this._paneView.update("options")}setData(t,e){this._data.setData(t),this._paneView.update("data");const i=this.model().paneForSource(this);this.model().recalculatePane(i),this.model().updateSource(this),this.model().updateCrosshair(),this.model().lightUpdate()}seriesType(){return this._seriesType}firstValue(){const t=this.firstBar();return null===t?null:{value:t.value[3],timePoint:t.time}}firstBar(){const t=this.model().timeScale().visibleStrictRange();if(null===t)return null;const e=t.left();return this._data.search(e,1)}bars(){return this._data}topPaneViews(t){return[]}paneViews(){const t=[];t.push(this._paneView,this._priceLineView);const e=this._customPriceLines.map((t=>t.paneView()));return t.push(...e),t}bottomPaneViews(){return this._extractPaneViews(Ot,"bottom")}pricePaneViews(t){return this._extractPaneViews(Vt,t)}timePaneViews(t){return this._extractPaneViews(Dt,t)}primitiveHitTest(t,e){return this._primitives.map((i=>i.hitTest(t,e))).filter((t=>null!==t))}labelPaneViews(t){return[this._panePriceAxisView,...this._customPriceLines.map((t=>t.labelPaneView()))]}priceAxisViews(t,e){if(e!==this._priceScale&&!this._isOverlay())return[];const i=[...this._priceAxisViews];for(const t of this._customPriceLines)i.push(t.priceAxisView());return this._primitives.forEach((t=>{i.push(...t.priceAxisViews())})),i}timeAxisViews(){const t=[];return this._primitives.forEach((e=>{t.push(...e.timeAxisViews())})),t}autoscaleInfo(t,e){if(void 0!==this._options.autoscaleInfoProvider){const i=this._options.autoscaleInfoProvider((()=>{const i=this._autoscaleInfoImpl(t,e);return null===i?null:i.toRaw()}));return Tt.fromRaw(i)}return this._autoscaleInfoImpl(t,e)}minMove(){return this._options.priceFormat.minMove}formatter(){return this._formatter}updateAllViews(){this._paneView.update();for(const t of this._priceAxisViews)t.update();for(const t of this._customPriceLines)t.update();this._priceLineView.update(),this._primitives.forEach((t=>t.updateAllViews()))}priceScale(){return h(super.priceScale())}title(){return this._options.title}visible(){return this._options.visible}_isOverlay(){return!yt(this.priceScale().id())}_autoscaleInfoImpl(t,i){if(!e(t)||!e(i)||this._data.isEmpty())return null;const s="Line"===this._seriesType||"Area"===this._seriesType||"Baseline"===this._seriesType||"Histogram"===this._seriesType?[3]:[2,1],n=this._data.minMaxOnRangeCached(t,i,s);let o=null!==n?new Mt(n.min,n.max):null;if("Histogram"===this.seriesType()){const t=this._options.base,e=new Mt(t,t);o=null!==o?o.merge(e):e}return this._primitives.forEach((e=>{const s=e.autoscaleInfo(t,i);if(null==s?void 0:s.priceRange){const t=new Mt(s.priceRange.minValue,s.priceRange.maxValue);o=null!==o?o.merge(t):t}})),new Tt(o,null)}_recreateFormatter(){switch(this._options.priceFormat.type){case"custom":this._formatter={format:this._options.priceFormat.formatter};break;case"volume":this._formatter=new A(this._options.priceFormat.precision);break;case"percent":this._formatter=new D(this._options.priceFormat.precision);break;default:{const t=Math.pow(10,this._options.priceFormat.precision);this._formatter=new V(t,this._options.priceFormat.minMove*t)}}null!==this._priceScale&&this._priceScale.updateFormatter()}_recreatePaneViews(){switch(this._seriesType){case"Candlestick":this._paneView=new dt(this,this.model());break;case"Line":this._paneView=new ut(this,this.model());break;default:throw Error("Unknown chart style assigned: "+this._seriesType)}}_extractPaneViews(t,e){return[]}}class Lt extends U{constructor(){super(...arguments),this._data=null}setData(t){this._data=t}_drawImpl({context:t,bitmapSize:e,horizontalPixelRatio:i,verticalPixelRatio:s}){if(null===this._data)return;const n=Math.max(1,Math.floor(i));t.lineWidth=n,function(t,e){t.save(),t.lineWidth%2&&t.translate(.5,.5),e(),t.restore()}(t,(()=>{const o=h(this._data);if(o.vertLinesVisible){t.strokeStyle=o.vertLinesColor,f(t,o.vertLineStyle),t.beginPath();for(const s of o.timeMarks){const o=Math.round(s.coord*i);t.moveTo(o,-n),t.lineTo(o,e.height+n)}t.stroke()}if(o.horzLinesVisible){t.strokeStyle=o.horzLinesColor,f(t,o.horzLineStyle),t.beginPath();for(const i of o.priceMarks){const o=Math.round(i.coord*s);t.moveTo(-n,o),t.lineTo(e.width+n,o)}t.stroke()}}))}}class Wt{constructor(t){this._renderer=new Lt,this._invalidated=!0,this._pane=t}update(){this._invalidated=!0}renderer(){if(this._invalidated){const t=this._pane.model().options().grid,e={horzLinesVisible:t.horzLines.visible,vertLinesVisible:t.vertLines.visible,horzLinesColor:t.horzLines.color,vertLinesColor:t.vertLines.color,horzLineStyle:t.horzLines.style,vertLineStyle:t.vertLines.style,priceMarks:this._pane.defaultPriceScale().marks(),timeMarks:(this._pane.model().timeScale().marks()||[]).map((t=>({coord:t.coord})))};this._renderer.setData(e),this._invalidated=!1}return this._renderer}}class Ft{constructor(t){this._paneView=new Wt(t)}paneView(){return this._paneView}}const Nt={logicalOffset:4,coordOffset:1e-4};function Ht(t,e){const i=100*(t-e)/e;return e<0?-i:i}function Ut(t,e){const i=Ht(t.minValue(),e),s=Ht(t.maxValue(),e);return new Mt(i,s)}function Yt(t,e){const i=100*(t-e)/e+100;return e<0?-i:i}function jt(t,e){const i=Yt(t.minValue(),e),s=Yt(t.maxValue(),e);return new Mt(i,s)}function $t(t,e){const i=Math.abs(t);if(i<1e-15)return 0;const s=Math.log10(i+e.coordOffset)+e.logicalOffset;return t<0?-s:s}function Xt(t,e){const i=Math.abs(t);if(i<1e-15)return 0;const s=Math.pow(10,i-e.logicalOffset)-e.coordOffset;return t<0?-s:s}function Gt(t,e){if(null===t)return null;const i=$t(t.minValue(),e),s=$t(t.maxValue(),e);return new Mt(i,s)}function Kt(t,e){if(null===t)return null;const i=Xt(t.minValue(),e),s=Xt(t.maxValue(),e);return new Mt(i,s)}function Zt(t){if(null===t)return Nt;const e=Math.abs(t.maxValue()-t.minValue());if(e>=1||e<1e-15)return Nt;const i=Math.ceil(Math.abs(Math.log10(e))),s=Nt.logicalOffset+i;return{logicalOffset:s,coordOffset:1/Math.pow(10,s)}}class qt{constructor(t,e){if(this._base=t,this._integralDividers=e,function(t){if(t<0)return!1;for(let e=t;e>1;e/=10)if(e%10!=0)return!1;return!0}(this._base))this._fractionalDividers=[2,2.5,2];else{this._fractionalDividers=[];for(let t=this._base;1!==t;){if(t%2==0)this._fractionalDividers.push(2),t/=2;else{if(t%5!=0)throw new Error("unexpected base");this._fractionalDividers.push(2,2.5),t/=5}if(this._fractionalDividers.length>100)throw new Error("something wrong with base")}}}tickSpan(t,e,i){const s=0===this._base?0:1/this._base;let n=Math.pow(10,Math.max(0,Math.ceil(Math.log10(t-e)))),o=0,r=this._integralDividers[0];for(;;){const t=m(n,s,1e-14)&&n>s+1e-14,e=m(n,i*r,1e-14),a=m(n,1,1e-14);if(!(t&&e&&a))break;n/=r,r=this._integralDividers[++o%this._integralDividers.length]}if(n<=s+1e-14&&(n=s),n=Math.max(1,n),this._fractionalDividers.length>0&&(a=n,1,1e-14,Math.abs(a-1)<1e-14))for(o=0,r=this._fractionalDividers[0];m(n,i*r,1e-14)&&n>s+1e-14;)n/=r,r=this._fractionalDividers[++o%this._fractionalDividers.length];var a;return n}}class Qt{constructor(t,e,i,s){this._marks=[],this._priceScale=t,this._base=e,this._coordinateToLogicalFunc=i,this._logicalToCoordinateFunc=s}tickSpan(t,e){if(t<e)throw new Error("high < low");const i=this._priceScale.height(),s=(t-e)*this._tickMarkHeight()/i,n=new qt(this._base,[2,2.5,2]),o=new qt(this._base,[2,2,2.5]),r=new qt(this._base,[2.5,2,2]),a=[];return a.push(n.tickSpan(t,e,s),o.tickSpan(t,e,s),r.tickSpan(t,e,s)),function(t){if(t.length<1)throw Error("array is empty");let e=t[0];for(let i=1;i<t.length;++i)t[i]<e&&(e=t[i]);return e}(a)}rebuildTickMarks(){const t=this._priceScale,e=t.firstValue();if(null===e)return void(this._marks=[]);const i=t.height(),s=this._coordinateToLogicalFunc(i-1,e),n=this._coordinateToLogicalFunc(0,e),o=this._priceScale.options().entireTextOnly?this._fontHeight()/2:0,r=o,a=i-1-o,l=Math.max(s,n),h=Math.min(s,n);if(l===h)return void(this._marks=[]);let c=this.tickSpan(l,h),d=l%c;d+=d<0?c:0;const u=l>=h?1:-1;let _=null,p=0;for(let i=l-d;i>h;i-=c){const s=this._logicalToCoordinateFunc(i,e,!0);null!==_&&Math.abs(s-_)<this._tickMarkHeight()||s<r||s>a||(p<this._marks.length?(this._marks[p].coord=s,this._marks[p].label=t.formatLogical(i)):this._marks.push({coord:s,label:t.formatLogical(i)}),p++,_=s,t.isLog()&&(c=this.tickSpan(i*u,h)))}this._marks.length=p}marks(){return this._marks}_fontHeight(){return this._priceScale.fontSize()}_tickMarkHeight(){return Math.ceil(2.5*this._fontHeight())}}function Jt(t){return t.slice().sort(((t,e)=>h(t.zorder())-h(e.zorder())))}const te=new D,ee=new V(100,1);class ie{constructor(t,e,i,s){this._height=0,this._internalHeightCache=null,this._priceRange=null,this._priceRangeSnapshot=null,this._invalidatedForRange={isValid:!1,visibleBars:null},this._marginAbove=0,this._marginBelow=0,this._onMarksChanged=new wt,this._modeChanged=new wt,this._dataSources=[],this._cachedOrderedSources=null,this._marksCache=null,this._scaleStartPoint=null,this._scrollStartPoint=null,this._formatter=ee,this._logFormula=Zt(null),this._id=t,this._options=e,this._layoutOptions=i,this._localizationOptions=s,this._markBuilder=new Qt(this,100,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this))}id(){return this._id}options(){return this._options}applyOptions(t){if(d(this._options,t),this.updateFormatter(),void 0!==t.mode&&this.setMode({mode:t.mode}),void 0!==t.scaleMargins){const e=l(t.scaleMargins.top),i=l(t.scaleMargins.bottom);if(e<0||e>1)throw new Error(`Invalid top margin - expect value between 0 and 1, given=${e}`);if(i<0||i>1)throw new Error(`Invalid bottom margin - expect value between 0 and 1, given=${i}`);if(e+i>1)throw new Error(`Invalid margins - sum of margins must be less than 1, given=${e+i}`);this._invalidateInternalHeightCache(),this._marksCache=null}}isAutoScale(){return this._options.autoScale}isLog(){return 1===this._options.mode}isPercentage(){return 2===this._options.mode}isIndexedTo100(){return 3===this._options.mode}mode(){return{autoScale:this._options.autoScale,isInverted:this._options.invertScale,mode:this._options.mode}}setMode(t){const e=this.mode();let i=null;void 0!==t.autoScale&&(this._options.autoScale=t.autoScale),void 0!==t.mode&&(this._options.mode=t.mode,2!==t.mode&&3!==t.mode||(this._options.autoScale=!0),this._invalidatedForRange.isValid=!1),1===e.mode&&t.mode!==e.mode&&(function(t,e){if(null===t)return!1;const i=Xt(t.minValue(),e),s=Xt(t.maxValue(),e);return isFinite(i)&&isFinite(s)}(this._priceRange,this._logFormula)?(i=Kt(this._priceRange,this._logFormula),null!==i&&this.setPriceRange(i)):this._options.autoScale=!0),1===t.mode&&t.mode!==e.mode&&(i=Gt(this._priceRange,this._logFormula),null!==i&&this.setPriceRange(i));const s=e.mode!==this._options.mode;s&&(2===e.mode||this.isPercentage())&&this.updateFormatter(),s&&(3===e.mode||this.isIndexedTo100())&&this.updateFormatter(),void 0!==t.isInverted&&e.isInverted!==t.isInverted&&(this._options.invertScale=t.isInverted,this._onIsInvertedChanged()),this._modeChanged.fire(e,this.mode())}modeChanged(){return this._modeChanged}fontSize(){return this._layoutOptions.fontSize}height(){return this._height}setHeight(t){this._height!==t&&(this._height=t,this._invalidateInternalHeightCache(),this._marksCache=null)}internalHeight(){if(this._internalHeightCache)return this._internalHeightCache;const t=this.height()-this._topMarginPx()-this._bottomMarginPx();return this._internalHeightCache=t,t}priceRange(){return this._makeSureItIsValid(),this._priceRange}setPriceRange(t,e){const i=this._priceRange;(e||null===i&&null!==t||null!==i&&!i.equals(t))&&(this._marksCache=null,this._priceRange=t)}isEmpty(){return this._makeSureItIsValid(),0===this._height||!this._priceRange||this._priceRange.isEmpty()}invertedCoordinate(t){return this.isInverted()?t:this.height()-1-t}priceToCoordinate(t,e){return this.isPercentage()?t=Ht(t,e):this.isIndexedTo100()&&(t=Yt(t,e)),this._logicalToCoordinate(t,e)}pointsArrayToCoordinates(t,e,i){this._makeSureItIsValid();const s=this._bottomMarginPx(),n=h(this.priceRange()),o=n.minValue(),r=n.maxValue(),a=this.internalHeight()-1,l=this.isInverted(),c=a/(r-o),d=void 0===i?0:i.from,u=void 0===i?t.length:i.to,_=this._getCoordinateTransformer();for(let i=d;i<u;i++){const n=t[i],r=n.price;if(isNaN(r))continue;let a=r;null!==_&&(a=_(n.price,e));const h=s+c*(a-o);n.y=l?h:this._height-1-h}}barPricesToCoordinates(t,e,i){this._makeSureItIsValid();const s=this._bottomMarginPx(),n=h(this.priceRange()),o=n.minValue(),r=n.maxValue(),a=this.internalHeight()-1,l=this.isInverted(),c=a/(r-o),d=void 0===i?0:i.from,u=void 0===i?t.length:i.to,_=this._getCoordinateTransformer();for(let i=d;i<u;i++){const n=t[i];let r=n.open,a=n.high,h=n.low,d=n.close;null!==_&&(r=_(n.open,e),a=_(n.high,e),h=_(n.low,e),d=_(n.close,e));let u=s+c*(r-o),p=l?u:this._height-1-u;n.openY=p,u=s+c*(a-o),p=l?u:this._height-1-u,n.highY=p,u=s+c*(h-o),p=l?u:this._height-1-u,n.lowY=p,u=s+c*(d-o),p=l?u:this._height-1-u,n.closeY=p}}coordinateToPrice(t,e){const i=this._coordinateToLogical(t,e);return this.logicalToPrice(i,e)}logicalToPrice(t,e){let i=t;return this.isPercentage()?i=function(t,e){return e<0&&(t=-t),t/100*e+e}(i,e):this.isIndexedTo100()&&(i=function(t,e){return t-=100,e<0&&(t=-t),t/100*e+e}(i,e)),i}dataSources(){return this._dataSources}orderedSources(){if(this._cachedOrderedSources)return this._cachedOrderedSources;let t=[];for(let e=0;e<this._dataSources.length;e++){const i=this._dataSources[e];null===i.zorder()&&i.setZorder(e+1),t.push(i)}return t=Jt(t),this._cachedOrderedSources=t,this._cachedOrderedSources}addDataSource(t){-1===this._dataSources.indexOf(t)&&(this._dataSources.push(t),this.updateFormatter(),this.invalidateSourcesCache())}removeDataSource(t){const e=this._dataSources.indexOf(t);if(-1===e)throw new Error("source is not attached to scale");this._dataSources.splice(e,1),0===this._dataSources.length&&(this.setMode({autoScale:!0}),this.setPriceRange(null)),this.updateFormatter(),this.invalidateSourcesCache()}firstValue(){let t=null;for(const e of this._dataSources){const i=e.firstValue();null!==i&&(null===t||i.timePoint<t.timePoint)&&(t=i)}return null===t?null:t.value}isInverted(){return this._options.invertScale}marks(){const t=null===this.firstValue();if(null!==this._marksCache&&(t||this._marksCache.firstValueIsNull===t))return this._marksCache.marks;this._markBuilder.rebuildTickMarks();const e=this._markBuilder.marks();return this._marksCache={marks:e,firstValueIsNull:t},this._onMarksChanged.fire(),e}onMarksChanged(){return this._onMarksChanged}startScale(t){this.isPercentage()||this.isIndexedTo100()||null===this._scaleStartPoint&&null===this._priceRangeSnapshot&&(this.isEmpty()||(this._scaleStartPoint=this._height-t,this._priceRangeSnapshot=h(this.priceRange()).clone()))}scaleTo(t){if(this.isPercentage()||this.isIndexedTo100())return;if(null===this._scaleStartPoint)return;this.setMode({autoScale:!1}),(t=this._height-t)<0&&(t=0);let e=(this._scaleStartPoint+.2*(this._height-1))/(t+.2*(this._height-1));const i=h(this._priceRangeSnapshot).clone();e=Math.max(e,.1),i.scaleAroundCenter(e),this.setPriceRange(i)}endScale(){this.isPercentage()||this.isIndexedTo100()||(this._scaleStartPoint=null,this._priceRangeSnapshot=null)}startScroll(t){this.isAutoScale()||null===this._scrollStartPoint&&null===this._priceRangeSnapshot&&(this.isEmpty()||(this._scrollStartPoint=t,this._priceRangeSnapshot=h(this.priceRange()).clone()))}scrollTo(t){if(this.isAutoScale())return;if(null===this._scrollStartPoint)return;const e=h(this.priceRange()).length()/(this.internalHeight()-1);let i=t-this._scrollStartPoint;this.isInverted()&&(i*=-1);const s=i*e,n=h(this._priceRangeSnapshot).clone();n.shift(s),this.setPriceRange(n,!0),this._marksCache=null}endScroll(){this.isAutoScale()||null!==this._scrollStartPoint&&(this._scrollStartPoint=null,this._priceRangeSnapshot=null)}formatter(){return this._formatter||this.updateFormatter(),this._formatter}formatPrice(t,e){switch(this._options.mode){case 2:return this._formatPercentage(Ht(t,e));case 3:return this.formatter().format(Yt(t,e));default:return this._formatPrice(t)}}formatLogical(t){switch(this._options.mode){case 2:return this._formatPercentage(t);case 3:return this.formatter().format(t);default:return this._formatPrice(t)}}formatPriceAbsolute(t){return this._formatPrice(t,h(this._formatterSource()).formatter())}formatPricePercentage(t,e){return t=Ht(t,e),this._formatPercentage(t,te)}sourcesForAutoScale(){return this._dataSources}recalculatePriceRange(t){this._invalidatedForRange={visibleBars:t,isValid:!1}}updateAllViews(){this._dataSources.forEach((t=>t.updateAllViews()))}updateFormatter(){this._marksCache=null;const t=this._formatterSource();let e=100;null!==t&&(e=Math.round(1/t.minMove())),this._formatter=ee,this.isPercentage()?(this._formatter=te,e=100):this.isIndexedTo100()?(this._formatter=new V(100,1),e=100):null!==t&&(this._formatter=t.formatter()),this._markBuilder=new Qt(this,e,this._coordinateToLogical.bind(this),this._logicalToCoordinate.bind(this)),this._markBuilder.rebuildTickMarks()}invalidateSourcesCache(){this._cachedOrderedSources=null}_formatterSource(){return this._dataSources[0]||null}_topMarginPx(){return this.isInverted()?this._options.scaleMargins.bottom*this.height()+this._marginBelow:this._options.scaleMargins.top*this.height()+this._marginAbove}_bottomMarginPx(){return this.isInverted()?this._options.scaleMargins.top*this.height()+this._marginAbove:this._options.scaleMargins.bottom*this.height()+this._marginBelow}_makeSureItIsValid(){this._invalidatedForRange.isValid||(this._invalidatedForRange.isValid=!0,this._recalculatePriceRangeImpl())}_invalidateInternalHeightCache(){this._internalHeightCache=null}_logicalToCoordinate(t,e){if(this._makeSureItIsValid(),this.isEmpty())return 0;t=this.isLog()&&t?$t(t,this._logFormula):t;const i=h(this.priceRange()),s=this._bottomMarginPx()+(this.internalHeight()-1)*(t-i.minValue())/i.length();return this.invertedCoordinate(s)}_coordinateToLogical(t,e){if(this._makeSureItIsValid(),this.isEmpty())return 0;const i=this.invertedCoordinate(t),s=h(this.priceRange()),n=s.minValue()+s.length()*((i-this._bottomMarginPx())/(this.internalHeight()-1));return this.isLog()?Xt(n,this._logFormula):n}_onIsInvertedChanged(){this._marksCache=null,this._markBuilder.rebuildTickMarks()}_recalculatePriceRangeImpl(){const t=this._invalidatedForRange.visibleBars;if(null===t)return;let e=null;const i=this.sourcesForAutoScale();let s=0,n=0;for(const o of i){if(!o.visible())continue;const i=o.firstValue();if(null===i)continue;const r=o.autoscaleInfo(t.left(),t.right());let a=r&&r.priceRange();if(null!==a){switch(this._options.mode){case 1:a=Gt(a,this._logFormula);break;case 2:a=Ut(a,i.value);break;case 3:a=jt(a,i.value)}if(e=null===e?a:e.merge(h(a)),null!==r){const t=r.margins();null!==t&&(s=Math.max(s,t.above),n=Math.max(s,t.below))}}}if(s===this._marginAbove&&n===this._marginBelow||(this._marginAbove=s,this._marginBelow=n,this._marksCache=null,this._invalidateInternalHeightCache()),null!==e){if(e.minValue()===e.maxValue()){const t=this._formatterSource(),i=5*(null===t||this.isPercentage()||this.isIndexedTo100()?1:t.minMove());this.isLog()&&(e=Kt(e,this._logFormula)),e=new Mt(e.minValue()-i,e.maxValue()+i),this.isLog()&&(e=Gt(e,this._logFormula))}if(this.isLog()){const t=Kt(e,this._logFormula),i=Zt(t);if(o=i,r=this._logFormula,o.logicalOffset!==r.logicalOffset||o.coordOffset!==r.coordOffset){const s=null!==this._priceRangeSnapshot?Kt(this._priceRangeSnapshot,this._logFormula):null;this._logFormula=i,e=Gt(t,i),null!==s&&(this._priceRangeSnapshot=Gt(s,i))}}this.setPriceRange(e)}else null===this._priceRange&&(this.setPriceRange(new Mt(-.5,.5)),this._logFormula=Zt(null));var o,r;this._invalidatedForRange.isValid=!0}_getCoordinateTransformer(){return this.isPercentage()?Ht:this.isIndexedTo100()?Yt:this.isLog()?t=>$t(t,this._logFormula):null}_formatValue(t,e,i){return void 0===e?(void 0===i&&(i=this.formatter()),i.format(t)):e(t)}_formatPrice(t,e){return this._formatValue(t,this._localizationOptions.priceFormatter,e)}_formatPercentage(t,e){return this._formatValue(t,this._localizationOptions.percentageFormatter,e)}}class se{constructor(t,e){this._dataSources=[],this._overlaySourcesByScaleId=new Map,this._height=0,this._width=0,this._stretchFactor=1e3,this._cachedOrderedSources=null,this._destroyed=new wt,this._timeScale=t,this._model=e,this._grid=new Ft(this);const i=e.options();this._leftPriceScale=this._createPriceScale("left",i.leftPriceScale),this._rightPriceScale=this._createPriceScale("right",i.rightPriceScale),this._leftPriceScale.modeChanged().subscribe(this._onPriceScaleModeChanged.bind(this,this._leftPriceScale),this),this._rightPriceScale.modeChanged().subscribe(this._onPriceScaleModeChanged.bind(this,this._rightPriceScale),this),this.applyScaleOptions(i)}applyScaleOptions(t){if(t.leftPriceScale&&this._leftPriceScale.applyOptions(t.leftPriceScale),t.rightPriceScale&&this._rightPriceScale.applyOptions(t.rightPriceScale),t.localization&&(this._leftPriceScale.updateFormatter(),this._rightPriceScale.updateFormatter()),t.overlayPriceScales){const e=Array.from(this._overlaySourcesByScaleId.values());for(const i of e){const e=h(i[0].priceScale());e.applyOptions(t.overlayPriceScales),t.localization&&e.updateFormatter()}}}priceScaleById(t){switch(t){case"left":return this._leftPriceScale;case"right":return this._rightPriceScale}return this._overlaySourcesByScaleId.has(t)?l(this._overlaySourcesByScaleId.get(t))[0].priceScale():null}destroy(){this.model().priceScalesOptionsChanged().unsubscribeAll(this),this._leftPriceScale.modeChanged().unsubscribeAll(this),this._rightPriceScale.modeChanged().unsubscribeAll(this),this._dataSources.forEach((t=>{t.destroy&&t.destroy()})),this._destroyed.fire()}stretchFactor(){return this._stretchFactor}setStretchFactor(t){this._stretchFactor=t}model(){return this._model}width(){return this._width}height(){return this._height}setWidth(t){this._width=t,this.updateAllSources()}setHeight(t){this._height=t,this._leftPriceScale.setHeight(t),this._rightPriceScale.setHeight(t),this._dataSources.forEach((e=>{if(this.isOverlay(e)){const i=e.priceScale();null!==i&&i.setHeight(t)}})),this.updateAllSources()}dataSources(){return this._dataSources}isOverlay(t){const e=t.priceScale();return null===e||this._leftPriceScale!==e&&this._rightPriceScale!==e}addDataSource(t,e,i){const s=void 0!==i?i:this._getZOrderMinMax().maxZOrder+1;this._insertDataSource(t,e,s)}removeDataSource(t){const e=this._dataSources.indexOf(t);a(-1!==e,"removeDataSource: invalid data source"),this._dataSources.splice(e,1);const i=h(t.priceScale()).id();if(this._overlaySourcesByScaleId.has(i)){const e=l(this._overlaySourcesByScaleId.get(i)),s=e.indexOf(t);-1!==s&&(e.splice(s,1),0===e.length&&this._overlaySourcesByScaleId.delete(i))}const s=t.priceScale();s&&s.dataSources().indexOf(t)>=0&&s.removeDataSource(t),null!==s&&(s.invalidateSourcesCache(),this.recalculatePriceScale(s)),this._cachedOrderedSources=null}priceScalePosition(t){return t===this._leftPriceScale?"left":t===this._rightPriceScale?"right":"overlay"}leftPriceScale(){return this._leftPriceScale}rightPriceScale(){return this._rightPriceScale}startScalePrice(t,e){t.startScale(e)}scalePriceTo(t,e){t.scaleTo(e),this.updateAllSources()}endScalePrice(t){t.endScale()}startScrollPrice(t,e){t.startScroll(e)}scrollPriceTo(t,e){t.scrollTo(e),this.updateAllSources()}endScrollPrice(t){t.endScroll()}updateAllSources(){this._dataSources.forEach((t=>{t.updateAllViews()}))}defaultPriceScale(){let t=null;return this._model.options().rightPriceScale.visible&&0!==this._rightPriceScale.dataSources().length?t=this._rightPriceScale:this._model.options().leftPriceScale.visible&&0!==this._leftPriceScale.dataSources().length?t=this._leftPriceScale:0!==this._dataSources.length&&(t=this._dataSources[0].priceScale()),null===t&&(t=this._rightPriceScale),t}defaultVisiblePriceScale(){let t=null;return this._model.options().rightPriceScale.visible?t=this._rightPriceScale:this._model.options().leftPriceScale.visible&&(t=this._leftPriceScale),t}recalculatePriceScale(t){null!==t&&t.isAutoScale()&&this._recalculatePriceScaleImpl(t)}resetPriceScale(t){const e=this._timeScale.visibleStrictRange();t.setMode({autoScale:!0}),null!==e&&t.recalculatePriceRange(e),this.updateAllSources()}momentaryAutoScale(){this._recalculatePriceScaleImpl(this._leftPriceScale),this._recalculatePriceScaleImpl(this._rightPriceScale)}recalculate(){this.recalculatePriceScale(this._leftPriceScale),this.recalculatePriceScale(this._rightPriceScale),this._dataSources.forEach((t=>{this.isOverlay(t)&&this.recalculatePriceScale(t.priceScale())})),this.updateAllSources(),this._model.lightUpdate()}orderedSources(){return null===this._cachedOrderedSources&&(this._cachedOrderedSources=Jt(this._dataSources)),this._cachedOrderedSources}onDestroyed(){return this._destroyed}grid(){return this._grid}_recalculatePriceScaleImpl(t){const e=t.sourcesForAutoScale();if(e&&e.length>0&&!this._timeScale.isEmpty()){const e=this._timeScale.visibleStrictRange();null!==e&&t.recalculatePriceRange(e)}t.updateAllViews()}_getZOrderMinMax(){const t=this.orderedSources();if(0===t.length)return{minZOrder:0,maxZOrder:0};let e=0,i=0;for(let s=0;s<t.length;s++){const n=t[s].zorder();null!==n&&(n<e&&(e=n),n>i&&(i=n))}return{minZOrder:e,maxZOrder:i}}_insertDataSource(t,e,i){let s=this.priceScaleById(e);if(null===s&&(s=this._createPriceScale(e,this._model.options().overlayPriceScales)),this._dataSources.push(t),!yt(e)){const i=this._overlaySourcesByScaleId.get(e)||[];i.push(t),this._overlaySourcesByScaleId.set(e,i)}s.addDataSource(t),t.setPriceScale(s),t.setZorder(i),this.recalculatePriceScale(s),this._cachedOrderedSources=null}_onPriceScaleModeChanged(t,e,i){e.mode!==i.mode&&this._recalculatePriceScaleImpl(t)}_createPriceScale(t,e){const i=Object.assign({visible:!0,autoScale:!0},n(e)),s=new ie(t,i,this._model.options().layout,this._model.options().localization);return s.setHeight(this.height()),s}}class ne{constructor(t,e){a(t<=e,"right should be >= left"),this._left=t,this._right=e}left(){return this._left}right(){return this._right}count(){return this._right-this._left+1}contains(t){return this._left<=t&&t<=this._right}equals(t){return this._left===t.left()&&this._right===t.right()}}class oe{constructor(){this._marksByWeight=new Map,this._cache=null,this._uniformDistribution=!1}setUniformDistribution(t){this._uniformDistribution=t,this._cache=null}setTimeScalePoints(t,e){this._removeMarksSinceIndex(e),this._cache=null;for(let i=e;i<t.length;++i){const e=t[i];let s=this._marksByWeight.get(e.timeWeight);void 0===s&&(s=[],this._marksByWeight.set(e.timeWeight,s)),s.push({index:i,time:e.time,weight:e.timeWeight,originalTime:e.originalTime})}}build(t,e){const i=Math.ceil(e/t);return null!==this._cache&&this._cache.maxIndexesPerMark===i||(this._cache={marks:this._buildMarksImpl(i),maxIndexesPerMark:i}),this._cache.marks}_removeMarksSinceIndex(t){if(0===t)return void this._marksByWeight.clear();const e=[];this._marksByWeight.forEach(((i,s)=>{t<=i[0].index?e.push(s):i.splice(st(i,t,(e=>e.index<t)),1/0)}));for(const t of e)this._marksByWeight.delete(t)}_buildMarksImpl(t){let e=[];for(const i of Array.from(this._marksByWeight.keys()).sort(((t,e)=>e-t))){if(!this._marksByWeight.get(i))continue;const s=e;e=[];const n=s.length;let o=0;const r=l(this._marksByWeight.get(i)),a=r.length;let h=1/0,c=-1/0;for(let i=0;i<a;i++){const a=r[i],l=a.index;for(;o<n;){const t=s[o],i=t.index;if(!(i<l)){h=i;break}o++,e.push(t),c=i,h=1/0}if(h-l>=t&&l-c>=t)e.push(a),c=l;else if(this._uniformDistribution)return s}for(;o<n;o++)e.push(s[o])}return e}}class re{constructor(t){this._logicalRange=t}strictRange(){return null===this._logicalRange?null:new ne(Math.floor(this._logicalRange.left()),Math.ceil(this._logicalRange.right()))}logicalRange(){return this._logicalRange}static invalid(){return new re(null)}}function ae(t,e){return t.weight>e.weight?t:e}class le{constructor(t,e,i,s){this._width=0,this._baseIndexOrNull=null,this._points=[],this._scrollStartPoint=null,this._scaleStartPoint=null,this._tickMarks=new oe,this._visibleRange=re.invalid(),this._visibleRangeInvalidated=!0,this._visibleBarsChanged=new wt,this._logicalRangeChanged=new wt,this._optionsApplied=new wt,this._commonTransitionStartState=null,this._timeMarksCache=null,this._labels=[],this._options=e,this._localizationOptions=i,this._rightOffset=e.rightOffset,this._barSpacing=e.barSpacing,this._model=t,this._horzScaleBehavior=s,this._updateDateTimeFormatter(),this._tickMarks.setUniformDistribution(e.uniformDistribution)}options(){return this._options}applyLocalizationOptions(t){d(this._localizationOptions,t),this._invalidateTickMarks(),this._updateDateTimeFormatter()}applyOptions(t,e){var i;d(this._options,t),this._options.fixLeftEdge&&this._doFixLeftEdge(),this._options.fixRightEdge&&this._doFixRightEdge(),void 0!==t.barSpacing&&this._model.setBarSpacing(t.barSpacing),void 0!==t.rightOffset&&this._model.setRightOffset(t.rightOffset),void 0!==t.minBarSpacing&&this._model.setBarSpacing(null!==(i=t.barSpacing)&&void 0!==i?i:this._barSpacing),this._invalidateTickMarks(),this._updateDateTimeFormatter(),this._optionsApplied.fire()}indexToTime(t){var e,i;return null!==(i=null===(e=this._points[t])||void 0===e?void 0:e.time)&&void 0!==i?i:null}indexToTimeScalePoint(t){var e;return null!==(e=this._points[t])&&void 0!==e?e:null}timeToIndex(t,e){if(this._points.length<1)return null;if(this._horzScaleBehavior.key(t)>this._horzScaleBehavior.key(this._points[this._points.length-1].time))return e?this._points.length-1:null;const i=st(this._points,this._horzScaleBehavior.key(t),((t,e)=>this._horzScaleBehavior.key(t.time)<e));return this._horzScaleBehavior.key(t)<this._horzScaleBehavior.key(this._points[i].time)?e?i:null:i}isEmpty(){return 0===this._width||0===this._points.length||null===this._baseIndexOrNull}visibleStrictRange(){return this._updateVisibleRange(),this._visibleRange.strictRange()}visibleLogicalRange(){return this._updateVisibleRange(),this._visibleRange.logicalRange()}logicalRangeForTimeRange(t){return{from:h(this.timeToIndex(t.from,!0)),to:h(this.timeToIndex(t.to,!0))}}width(){return this._width}setWidth(t){if(!isFinite(t)||t<=0)return;if(this._width===t)return;const e=this.visibleLogicalRange(),i=this._width;if(this._width=t,this._visibleRangeInvalidated=!0,this._options.lockVisibleTimeRangeOnResize&&0!==i&&(this._barSpacing=this._barSpacing*t/i),this._options.fixLeftEdge&&null!==e&&e.left()<=0){const e=i-t;this._rightOffset-=Math.round(e/this._barSpacing)+1,this._visibleRangeInvalidated=!0}this._correctBarSpacing(),this._correctOffset()}indexToCoordinate(t){if(this.isEmpty()||!e(t))return 0;const i=this.baseIndex()+this._rightOffset-t;return this._width-(i+.5)*this._barSpacing-1}indexesToCoordinates(t,e){const i=this.baseIndex(),s=void 0===e?0:e.from,n=void 0===e?t.length:e.to;for(let e=s;e<n;e++){const s=t[e].time,n=i+this._rightOffset-s;t[e].x=this._width-(n+.5)*this._barSpacing-1}}coordinateToIndex(t){return Math.ceil(this._coordinateToFloatIndex(t))}setRightOffset(t){this._visibleRangeInvalidated=!0,this._rightOffset=t,this._correctOffset(),this._model.recalculateAllPanes(),this._model.lightUpdate()}barSpacing(){return this._barSpacing}setBarSpacing(t){this._setBarSpacing(t),this._correctOffset(),this._model.recalculateAllPanes(),this._model.lightUpdate()}rightOffset(){return this._rightOffset}marks(){if(this.isEmpty())return null;if(null!==this._timeMarksCache)return this._timeMarksCache;const t=this._barSpacing,e=5*(this._model.options().layout.fontSize+4)/8*(this._options.tickMarkMaxCharacterLength||8),i=Math.round(e/t),s=h(this.visibleStrictRange()),n=Math.max(s.left(),s.left()-i),o=Math.max(s.right(),s.right()-i),r=this._tickMarks.build(t,e),a=this._firstIndex()+i,l=this._lastIndex()-i,c=this._isAllScalingAndScrollingDisabled(),d=this._options.fixLeftEdge||c,u=this._options.fixRightEdge||c;let _=0;for(const t of r){if(!(n<=t.index&&t.index<=o))continue;let i;_<this._labels.length?(i=this._labels[_],i.coord=this.indexToCoordinate(t.index),i.label=this._formatLabel(t),i.weight=t.weight):(i={needAlignCoordinate:!1,coord:this.indexToCoordinate(t.index),label:this._formatLabel(t),weight:t.weight},this._labels.push(i)),this._barSpacing>e/2&&!c?i.needAlignCoordinate=!1:i.needAlignCoordinate=d&&t.index<=a||u&&t.index>=l,_++}return this._labels.length=_,this._timeMarksCache=this._labels,this._labels}restoreDefault(){this._visibleRangeInvalidated=!0,this.setBarSpacing(this._options.barSpacing),this.setRightOffset(this._options.rightOffset)}setBaseIndex(t){this._visibleRangeInvalidated=!0,this._baseIndexOrNull=t,this._correctOffset(),this._doFixLeftEdge()}zoom(t,e){const i=this._coordinateToFloatIndex(t),s=this.barSpacing(),n=s+e*(s/10);this.setBarSpacing(n),this._options.rightBarStaysOnScroll||this.setRightOffset(this.rightOffset()+(i-this._coordinateToFloatIndex(t)))}startScale(t){this._scrollStartPoint&&this.endScroll(),null===this._scaleStartPoint&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scaleStartPoint=t,this._saveCommonTransitionsStartState()))}scaleTo(t){if(null===this._commonTransitionStartState)return;const e=p(this._width-t,0,this._width),i=p(this._width-h(this._scaleStartPoint),0,this._width);0!==e&&0!==i&&this.setBarSpacing(this._commonTransitionStartState.barSpacing*e/i)}endScale(){null!==this._scaleStartPoint&&(this._scaleStartPoint=null,this._clearCommonTransitionsStartState())}startScroll(t){null===this._scrollStartPoint&&null===this._commonTransitionStartState&&(this.isEmpty()||(this._scrollStartPoint=t,this._saveCommonTransitionsStartState()))}scrollTo(t){if(null===this._scrollStartPoint)return;const e=(this._scrollStartPoint-t)/this.barSpacing();this._rightOffset=h(this._commonTransitionStartState).rightOffset+e,this._visibleRangeInvalidated=!0,this._correctOffset()}endScroll(){null!==this._scrollStartPoint&&(this._scrollStartPoint=null,this._clearCommonTransitionsStartState())}scrollToRealTime(){this.scrollToOffsetAnimated(this._options.rightOffset)}scrollToOffsetAnimated(t,e=400){if(!isFinite(t))throw new RangeError("offset is required and must be finite number");if(!isFinite(e)||e<=0)throw new RangeError("animationDuration (optional) must be finite positive number");const i=this._rightOffset,s=performance.now();this._model.setTimeScaleAnimation({finished:t=>(t-s)/e>=1,getPosition:n=>{const o=(n-s)/e;return o>=1?t:i+(t-i)*o}})}update(t,e){this._visibleRangeInvalidated=!0,this._points=t,this._tickMarks.setTimeScalePoints(t,e),this._correctOffset()}optionsApplied(){return this._optionsApplied}baseIndex(){return this._baseIndexOrNull||0}setVisibleRange(t){const e=t.count();this._setBarSpacing(this._width/e),this._rightOffset=t.right()-this.baseIndex(),this._correctOffset(),this._visibleRangeInvalidated=!0,this._model.recalculateAllPanes(),this._model.lightUpdate()}fitContent(){const t=this._firstIndex(),e=this._lastIndex();null!==t&&null!==e&&this.setVisibleRange(new ne(t,e+this._options.rightOffset))}setLogicalRange(t){const e=new ne(t.from,t.to);this.setVisibleRange(e)}formatDateTime(t){return void 0!==this._localizationOptions.timeFormatter?this._localizationOptions.timeFormatter(t.originalTime):this._horzScaleBehavior.formatHorzItem(t.time)}_isAllScalingAndScrollingDisabled(){const{handleScroll:t,handleScale:e}=this._model.options();return!(t.horzTouchDrag||t.mouseWheel||t.pressedMouseMove||t.vertTouchDrag||e.axisPressedMouseMove.time||e.mouseWheel||e.pinch)}_firstIndex(){return 0===this._points.length?null:0}_lastIndex(){return 0===this._points.length?null:this._points.length-1}_rightOffsetForCoordinate(t){return(this._width-1-t)/this._barSpacing}_coordinateToFloatIndex(t){const e=this._rightOffsetForCoordinate(t),i=this.baseIndex()+this._rightOffset-e;return Math.round(1e6*i)/1e6}_setBarSpacing(t){const e=this._barSpacing;this._barSpacing=t,this._correctBarSpacing(),e!==this._barSpacing&&(this._visibleRangeInvalidated=!0,this._resetTimeMarksCache())}_updateVisibleRange(){if(!this._visibleRangeInvalidated)return;if(this._visibleRangeInvalidated=!1,this.isEmpty())return void this._setVisibleRange(re.invalid());const t=this.baseIndex(),e=this._width/this._barSpacing,i=this._rightOffset+t,s=new ne(i-e+1,i);this._setVisibleRange(new re(s))}_correctBarSpacing(){const t=this._minBarSpacing();if(this._barSpacing<t&&(this._barSpacing=t,this._visibleRangeInvalidated=!0),0!==this._width){const t=.5*this._width;this._barSpacing>t&&(this._barSpacing=t,this._visibleRangeInvalidated=!0)}}_minBarSpacing(){return this._options.fixLeftEdge&&this._options.fixRightEdge&&0!==this._points.length?this._width/this._points.length:this._options.minBarSpacing}_correctOffset(){const t=this._maxRightOffset();this._rightOffset>t&&(this._rightOffset=t,this._visibleRangeInvalidated=!0);const e=this._minRightOffset();null!==e&&this._rightOffset<e&&(this._rightOffset=e,this._visibleRangeInvalidated=!0)}_minRightOffset(){const t=this._firstIndex(),e=this._baseIndexOrNull;return null===t||null===e?null:t-e-1+(this._options.fixLeftEdge?this._width/this._barSpacing:Math.min(2,this._points.length))}_maxRightOffset(){return this._options.fixRightEdge?0:this._width/this._barSpacing-Math.min(2,this._points.length)}_saveCommonTransitionsStartState(){this._commonTransitionStartState={barSpacing:this.barSpacing(),rightOffset:this.rightOffset()}}_clearCommonTransitionsStartState(){this._commonTransitionStartState=null}_formatLabel(t){return this._formatLabelImpl(t)}_formatLabelImpl(t){return this._horzScaleBehavior.formatTickmark(t,this._localizationOptions)}_setVisibleRange(t){const e=this._visibleRange;this._visibleRange=t,g(e.strictRange(),this._visibleRange.strictRange())||this._visibleBarsChanged.fire(),g(e.logicalRange(),this._visibleRange.logicalRange())||this._logicalRangeChanged.fire(),this._resetTimeMarksCache()}_resetTimeMarksCache(){this._timeMarksCache=null}_invalidateTickMarks(){this._resetTimeMarksCache()}_updateDateTimeFormatter(){this._horzScaleBehavior.updateFormatter(this._localizationOptions)}_doFixLeftEdge(){if(!this._options.fixLeftEdge)return;const t=this._firstIndex();if(null===t)return;const e=this.visibleStrictRange();if(null===e)return;const i=e.left()-t;if(i<0){const t=this._rightOffset-i-1;this.setRightOffset(t)}this._correctBarSpacing()}_doFixRightEdge(){this._correctOffset(),this._correctBarSpacing()}}class he{constructor(t){this._rendererOptions={borderSize:1,tickLength:5,fontSize:NaN,font:"",fontFamily:"",color:"",paneBackgroundColor:"",paddingBottom:0,paddingInner:0,paddingOuter:0,paddingTop:0,baselineOffset:0},this._chartModel=t}options(){const t=this._rendererOptions,e=this._fontSize(),i=this._fontFamily();return t.fontSize===e&&t.fontFamily===i||(t.fontSize=e,t.fontFamily=i,t.font=Ct(e,i),t.paddingTop=2.5/12*e,t.paddingBottom=t.paddingTop,t.paddingInner=e/12*t.tickLength,t.paddingOuter=e/12*t.tickLength,t.baselineOffset=0),t.color=this._textColor(),t.paneBackgroundColor=this._paneBackgroundColor(),this._rendererOptions}_textColor(){return this._chartModel.options().layout.textColor}_paneBackgroundColor(){return this._chartModel.backgroundTopColor()}_fontSize(){return this._chartModel.options().layout.fontSize}_fontFamily(){return this._chartModel.options().layout.fontFamily}}class ce{constructor(t,e,i){this._panes=[],this._serieses=[],this._width=0,this._hoveredSource=null,this._priceScalesOptionsChanged=new wt,this._crosshairMoved=new wt,this._gradientColorsCache=null,this._invalidateHandler=t,this._options=e,this._horzScaleBehavior=i,this._rendererOptionsProvider=new he(this),this._timeScale=new le(this,e.timeScale,this._options.localization,i),this._crosshair=new J(this,e.crosshair),this.createPane(),this._panes[0].setStretchFactor(2e3),this._backgroundTopColor=this._getBackgroundColor(0),this._backgroundBottomColor=this._getBackgroundColor(1)}fullUpdate(){this._invalidate(Pt.full())}lightUpdate(){this._invalidate(Pt.light())}cursorUpdate(){this._invalidate(new Pt(1))}updateSource(t){const e=this._invalidationMaskForSource(t);this._invalidate(e)}hoveredSource(){return this._hoveredSource}setHoveredSource(t){const e=this._hoveredSource;this._hoveredSource=t,null!==e&&this.updateSource(e.source),null!==t&&this.updateSource(t.source)}options(){return this._options}applyOptions(t){d(this._options,t),this._panes.forEach((e=>e.applyScaleOptions(t))),void 0!==t.timeScale&&this._timeScale.applyOptions(t.timeScale),void 0!==t.localization&&this._timeScale.applyLocalizationOptions(t.localization),(t.leftPriceScale||t.rightPriceScale)&&this._priceScalesOptionsChanged.fire(),this._backgroundTopColor=this._getBackgroundColor(0),this._backgroundBottomColor=this._getBackgroundColor(1),this.fullUpdate()}applyPriceScaleOptions(t,e){if("left"===t)return void this.applyOptions({leftPriceScale:e});if("right"===t)return void this.applyOptions({rightPriceScale:e});const i=this.findPriceScale(t);if(null===i)throw new Error(`Trying to apply price scale options with incorrect ID: ${t}`);i.priceScale.applyOptions(e),this._priceScalesOptionsChanged.fire()}findPriceScale(t){for(const e of this._panes){const i=e.priceScaleById(t);if(null!==i)return{pane:e,priceScale:i}}return null}timeScale(){return this._timeScale}panes(){return this._panes}crosshairSource(){return this._crosshair}crosshairMoved(){return this._crosshairMoved}setPaneHeight(t,e){t.setHeight(e),this.recalculateAllPanes()}setWidth(t){this._width=t,this._timeScale.setWidth(this._width),this._panes.forEach((e=>e.setWidth(t))),this.recalculateAllPanes()}createPane(t){const e=new se(this._timeScale,this);void 0!==t?this._panes.splice(t,0,e):this._panes.push(e);const i=void 0===t?this._panes.length-1:t,s=Pt.full();return s.invalidatePane(i,{level:0,autoScale:!0}),this._invalidate(s),e}startScalePrice(t,e,i){t.startScalePrice(e,i)}scalePriceTo(t,e,i){t.scalePriceTo(e,i),this.updateCrosshair(),this._invalidate(this._paneInvalidationMask(t,2))}endScalePrice(t,e){t.endScalePrice(e),this._invalidate(this._paneInvalidationMask(t,2))}startScrollPrice(t,e,i){e.isAutoScale()||t.startScrollPrice(e,i)}scrollPriceTo(t,e,i){e.isAutoScale()||(t.scrollPriceTo(e,i),this.updateCrosshair(),this._invalidate(this._paneInvalidationMask(t,2)))}endScrollPrice(t,e){e.isAutoScale()||(t.endScrollPrice(e),this._invalidate(this._paneInvalidationMask(t,2)))}resetPriceScale(t,e){t.resetPriceScale(e),this._invalidate(this._paneInvalidationMask(t,2))}startScaleTime(t){this._timeScale.startScale(t)}zoomTime(t,e){const i=this.timeScale();if(i.isEmpty()||0===e)return;const s=i.width();t=Math.max(1,Math.min(t,s)),i.zoom(t,e),this.recalculateAllPanes()}scrollChart(t){this.startScrollTime(0),this.scrollTimeTo(t),this.endScrollTime()}scaleTimeTo(t){this._timeScale.scaleTo(t),this.recalculateAllPanes()}endScaleTime(){this._timeScale.endScale(),this.lightUpdate()}startScrollTime(t){this._timeScale.startScroll(t)}scrollTimeTo(t){this._timeScale.scrollTo(t),this.recalculateAllPanes()}endScrollTime(){this._timeScale.endScroll(),this.lightUpdate()}serieses(){return this._serieses}setAndSaveCurrentPosition(t,e,i,s,n){this._crosshair.saveOriginCoord(t,e);let o=NaN,r=this._timeScale.coordinateToIndex(t);const a=this._timeScale.visibleStrictRange();null!==a&&(r=Math.min(Math.max(a.left(),r),a.right()));const l=s.defaultPriceScale(),h=l.firstValue();null!==h&&(o=l.coordinateToPrice(e,h)),this._crosshair.setPosition(r,o,s),this.cursorUpdate(),n||this._crosshairMoved.fire(this._crosshair.appliedIndex(),{x:t,y:e},i)}clearCurrentPosition(t){this.crosshairSource().clearPosition(),this.cursorUpdate(),t||this._crosshairMoved.fire(null,null,null)}updateCrosshair(){const t=this._crosshair.pane();if(null!==t){const e=this._crosshair.originCoordX(),i=this._crosshair.originCoordY();this.setAndSaveCurrentPosition(e,i,null,t)}this._crosshair.updateAllViews()}updateTimeScale(t,e,i){const s=this._timeScale.indexToTime(0);void 0!==e&&void 0!==i&&this._timeScale.update(e,i);const n=this._timeScale.indexToTime(0),o=this._timeScale.baseIndex(),r=this._timeScale.visibleStrictRange();if(null!==r&&null!==s&&null!==n){const e=r.contains(o),a=this._horzScaleBehavior.key(s)>this._horzScaleBehavior.key(n),l=null!==t&&t>o&&!a,h=this._timeScale.options().allowShiftVisibleRangeOnWhitespaceReplacement,c=e&&(!(void 0===i)||h)&&this._timeScale.options().shiftVisibleRangeOnNewBar;if(l&&!c){const e=t-o;this._timeScale.setRightOffset(this._timeScale.rightOffset()-e)}}this._timeScale.setBaseIndex(t)}recalculatePane(t){null!==t&&t.recalculate()}paneForSource(t){const e=this._panes.find((e=>e.orderedSources().includes(t)));return void 0===e?null:e}recalculateAllPanes(){this._panes.forEach((t=>t.recalculate())),this.updateCrosshair()}destroy(){this._panes.forEach((t=>t.destroy())),this._panes.length=0,this._options.localization.priceFormatter=void 0,this._options.localization.percentageFormatter=void 0,this._options.localization.timeFormatter=void 0}rendererOptionsProvider(){return this._rendererOptionsProvider}priceAxisRendererOptions(){return this._rendererOptionsProvider.options()}priceScalesOptionsChanged(){return this._priceScalesOptionsChanged}createSeries(t,e){const i=this._panes[0],s=this._createSeries(e,t,i);return this._serieses.push(s),1===this._serieses.length?this.fullUpdate():this.lightUpdate(),s}moveSeriesToScale(t,e){const i=h(this.paneForSource(t));i.removeDataSource(t);const s=this.findPriceScale(e);if(null===s){const s=t.zorder();i.addDataSource(t,e,s)}else{const n=s.pane===i?t.zorder():void 0;s.pane.addDataSource(t,e,n)}}fitContent(){const t=Pt.light();t.setFitContent(),this._invalidate(t)}setTargetLogicalRange(t){const e=Pt.light();e.applyRange(t),this._invalidate(e)}resetTimeScale(){const t=Pt.light();t.resetTimeScale(),this._invalidate(t)}setBarSpacing(t){const e=Pt.light();e.setBarSpacing(t),this._invalidate(e)}setRightOffset(t){const e=Pt.light();e.setRightOffset(t),this._invalidate(e)}setTimeScaleAnimation(t){const e=Pt.light();e.setTimeScaleAnimation(t),this._invalidate(e)}stopTimeScaleAnimation(){const t=Pt.light();t.stopTimeScaleAnimation(),this._invalidate(t)}defaultVisiblePriceScaleId(){return this._options.rightPriceScale.visible?"right":"left"}backgroundBottomColor(){return this._backgroundBottomColor}backgroundTopColor(){return this._backgroundTopColor}backgroundColorAtYPercentFromTop(t){const e=this._backgroundBottomColor,i=this._backgroundTopColor;if(e===i)return e;if(t=Math.max(0,Math.min(100,Math.round(100*t))),null===this._gradientColorsCache||this._gradientColorsCache.topColor!==i||this._gradientColorsCache.bottomColor!==e)this._gradientColorsCache={topColor:i,bottomColor:e,colors:new Map};else{const e=this._gradientColorsCache.colors.get(t);if(void 0!==e)return e}const s=function(t,e,i){const[s,n,o,r]=P(t),[a,l,h,c]=P(e),d=[S(s+i*(a-s)),S(n+i*(l-n)),S(o+i*(h-o)),b(r+i*(c-r))];return`rgba(${d[0]}, ${d[1]}, ${d[2]}, ${d[3]})`}(i,e,t/100);return this._gradientColorsCache.colors.set(t,s),s}_paneInvalidationMask(t,e){const i=new Pt(e);if(null!==t){const s=this._panes.indexOf(t);i.invalidatePane(s,{level:e})}return i}_invalidationMaskForSource(t,e){return void 0===e&&(e=2),this._paneInvalidationMask(this.paneForSource(t),e)}_invalidate(t){this._invalidateHandler&&this._invalidateHandler(t),this._panes.forEach((t=>t.grid().paneView().update()))}_createSeries(t,e,i){const s=new At(this,t,e),n=this.defaultVisiblePriceScaleId();return i.addDataSource(s,n),yt(n)||s.applyOptions(t),s}_getBackgroundColor(t){const e=this._options.layout;return"gradient"===e.background.type?0===t?e.background.topColor:e.background.bottomColor:e.background.color}}function de(e){return!t(e)&&!i(e)}function ue(e){return t(e)}function _e(t){return 60*t*60*1e3}function pe(t){return 60*t*1e3}const me=[{divisor:(1,1e3),weight:10},{divisor:pe(1),weight:20},{divisor:pe(5),weight:21},{divisor:pe(30),weight:22},{divisor:_e(1),weight:30},{divisor:_e(3),weight:31},{divisor:_e(6),weight:32},{divisor:_e(12),weight:33}];function ge(t,e){if(t.getUTCFullYear()!==e.getUTCFullYear())return 70;if(t.getUTCMonth()!==e.getUTCMonth())return 60;if(t.getUTCDate()!==e.getUTCDate())return 50;for(let i=me.length-1;i>=0;--i)if(Math.floor(e.getTime()/me[i].divisor)!==Math.floor(t.getTime()/me[i].divisor))return me[i].weight;return 0}function fe(t){let e=t;if(i(t)&&(e=be(t)),!de(e))throw new Error("time must be of type BusinessDay");const s=new Date(Date.UTC(e.year,e.month-1,e.day,0,0,0,0));return{timestamp:Math.round(s.getTime()/1e3),businessDay:e}}function ve(t){if(!ue(t))throw new Error("time must be of type isUTCTimestamp");return{timestamp:t}}const Se=/^\d\d\d\d-\d\d-\d\d$/;function be(t){if(!Se.test(t))throw new Error(`Invalid date string=${t}, expected format=yyyy-mm-dd`);const e=new Date(t);if(isNaN(e.getTime()))throw new Error(`Invalid date string=${t}, expected format=yyyy-mm-dd`);return{day:e.getUTCDate(),month:e.getUTCMonth()+1,year:e.getUTCFullYear()}}class we{options(){return this._options}setOptions(t){this._options=t,this.updateFormatter(t.localization)}createConverterToInternalObj(t){return h(function(t){return 0===t.length?null:de(t[0].time)||i(t[0].time)?fe:ve}(t))}key(t){return"object"==typeof t&&"timestamp"in t?t.timestamp:this.key(this.convertHorzItemToInternal(t))}cacheKey(t){const e=t;return void 0===e.businessDay?new Date(1e3*e.timestamp).getTime():new Date(Date.UTC(e.businessDay.year,e.businessDay.month-1,e.businessDay.day)).getTime()}convertHorzItemToInternal(t){return ue(e=t)?ve(e):de(e)?fe(e):fe(be(e));var e}updateFormatter(t){if(!this._options)return;const e=t.dateFormat;this._options.timeScale.timeVisible?this._dateTimeFormatter=new H({dateFormat:e,timeFormat:this._options.timeScale.secondsVisible?"%h:%m:%s":"%h:%m",dateTimeSeparator:"   ",locale:t.locale}):this._dateTimeFormatter=new W(e,t.locale)}formatHorzItem(t){return this._dateTimeFormatter.format(new Date(1e3*t.timestamp))}formatTickmark(t,e){const i=function(t,e,i){switch(t){case 0:case 10:return e?i?4:3:2;case 20:case 21:case 22:case 30:case 31:case 32:case 33:return e?3:2;case 50:return 2;case 60:return 1;case 70:return 0}}(t.weight,this._options.timeScale.timeVisible,this._options.timeScale.secondsVisible);return function(t,e,i){const s={};switch(e){case 0:s.year="numeric";break;case 1:s.month="short";break;case 2:s.day="numeric";break;case 3:s.hour12=!1,s.hour="2-digit",s.minute="2-digit";break;case 4:s.hour12=!1,s.hour="2-digit",s.minute="2-digit",s.second="2-digit"}const n=void 0===t.businessDay?new Date(1e3*t.timestamp):new Date(Date.UTC(t.businessDay.year,t.businessDay.month-1,t.businessDay.day));return new Date(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds(),n.getUTCMilliseconds()).toLocaleString(i,s)}(t.time,i,e.locale)}maxTickMarkWeight(t){let e=t.reduce(ae,t[0]).weight;return e>30&&e<50&&(e=30),e}fillWeightsForPoints(t,e){!function(t,e=0){if(0===t.length)return;let i=0===e?null:t[e-1].time.timestamp,s=null!==i?new Date(1e3*i):null,n=0;for(let o=e;o<t.length;++o){const e=t[o],r=new Date(1e3*e.time.timestamp);null!==s&&(e.timeWeight=ge(r,s)),n+=e.time.timestamp-(i||e.time.timestamp),i=e.time.timestamp,s=r}if(0===e&&t.length>1){const e=Math.ceil(n/(t.length-1)),i=new Date(1e3*(t[0].time.timestamp-e));t[0].timeWeight=ge(new Date(1e3*t[0].time.timestamp),i)}}(t,e)}static applyDefaults(t){const e=window.navigator.languages[0];return d({localization:{dateFormat:"dd MMM 'yy",priceFormatter:Intl.NumberFormat(e,{style:"currency",currency:"RUB"}).format}},t)}}function xe(t){var e=t.width,i=t.height;if(e<0)throw new Error("Negative width is not allowed for Size");if(i<0)throw new Error("Negative height is not allowed for Size");return{width:e,height:i}}function Ce(t,e){return t.width===e.width&&t.height===e.height}const ye=function(){function t(t){this._resolutionMediaQueryList=null,this._observers=[],this._window=t,this._installResolutionListener()}return Object.defineProperty(t.prototype,"value",{get:function(){return this._window.devicePixelRatio},enumerable:!1,configurable:!0}),t.prototype.subscribe=function(t){var e=this,i={next:t};return this._observers.push(i),{unsubscribe:function(){e._observers=e._observers.filter((function(t){return t!==i}))}}},t.prototype._installResolutionListener=function(){if(null!==this._resolutionMediaQueryList)throw new Error("Resolution listener is already installed");var t=this._window.devicePixelRatio;this._resolutionMediaQueryList=this._window.matchMedia("all and (resolution: ".concat(t,"dppx)")),this._resolutionMediaQueryList.addListener(this._resolutionListener)},t}(),Pe=function(){function t(t,e,i){var s;this._canvasElement=null,this._bitmapSizeChangedListeners=[],this._suggestedBitmapSize=null,this._suggestedBitmapSizeChangedListeners=[],this._devicePixelRatioObservable=null,this._canvasElementResizeObserver=null,this._canvasElement=t,this._canvasElementClientSize=xe({width:this._canvasElement.clientWidth,height:this._canvasElement.clientHeight}),this._transformBitmapSize=null!=e?e:function(t){return t},this._allowResizeObserver=null===(s=null==i?void 0:i.allowResizeObserver)||void 0===s||s,this._chooseAndInitObserver()}return t.prototype.dispose=function(){var t,e;if(null===this._canvasElement)throw new Error("Object is disposed");null===(t=this._canvasElementResizeObserver)||void 0===t||t.disconnect(),this._canvasElementResizeObserver=null,null===(e=this._devicePixelRatioObservable)||void 0===e||e.dispose(),this._devicePixelRatioObservable=null,this._suggestedBitmapSizeChangedListeners.length=0,this._bitmapSizeChangedListeners.length=0,this._canvasElement=null},Object.defineProperty(t.prototype,"canvasElement",{get:function(){if(null===this._canvasElement)throw new Error("Object is disposed");return this._canvasElement},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canvasElementClientSize",{get:function(){return this._canvasElementClientSize},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bitmapSize",{get:function(){return xe({width:this.canvasElement.width,height:this.canvasElement.height})},enumerable:!1,configurable:!0}),t.prototype.resizeCanvasElement=function(t){this._canvasElementClientSize=xe(t),this.canvasElement.style.width="".concat(this._canvasElementClientSize.width,"px"),this.canvasElement.style.height="".concat(this._canvasElementClientSize.height,"px"),this._invalidateBitmapSize()},Object.defineProperty(t.prototype,"suggestedBitmapSize",{get:function(){return this._suggestedBitmapSize},enumerable:!1,configurable:!0}),t.prototype.subscribeSuggestedBitmapSizeChanged=function(t){this._suggestedBitmapSizeChangedListeners.push(t)},t.prototype.unsubscribeSuggestedBitmapSizeChanged=function(t){this._suggestedBitmapSizeChangedListeners=this._suggestedBitmapSizeChangedListeners.filter((function(e){return e!==t}))},t.prototype.applySuggestedBitmapSize=function(){if(null!==this._suggestedBitmapSize){var t=this._suggestedBitmapSize;this._suggestedBitmapSize=null,this._resizeBitmap(t),this._emitSuggestedBitmapSizeChanged(t,this._suggestedBitmapSize)}},t.prototype._resizeBitmap=function(t){var e=this.bitmapSize;Ce(e,t)||(this.canvasElement.width=t.width,this.canvasElement.height=t.height,this._emitBitmapSizeChanged(e,t))},t.prototype._emitBitmapSizeChanged=function(t,e){var i=this;this._bitmapSizeChangedListeners.forEach((function(s){return s.call(i,t,e)}))},t.prototype._suggestNewBitmapSize=function(t){var e=this._suggestedBitmapSize,i=xe(this._transformBitmapSize(t,this._canvasElementClientSize)),s=Ce(this.bitmapSize,i)?null:i;null===e&&null===s||null!==e&&null!==s&&Ce(e,s)||(this._suggestedBitmapSize=s,this._emitSuggestedBitmapSizeChanged(e,s))},t.prototype._emitSuggestedBitmapSizeChanged=function(t,e){var i=this;this._suggestedBitmapSizeChangedListeners.forEach((function(s){return s.call(i,t,e)}))},t.prototype._chooseAndInitObserver=function(){var t=this;this._allowResizeObserver?new Promise((function(t){var e=new ResizeObserver((function(i){t(i.every((function(t){return"devicePixelContentBoxSize"in t}))),e.disconnect()}));e.observe(document.body,{box:"device-pixel-content-box"})})).catch((function(){return!1})).then((function(e){return e?t._initResizeObserver():t._initDevicePixelRatioObservable()})):this._initDevicePixelRatioObservable()},t.prototype._initDevicePixelRatioObservable=function(){var t=this;if(null!==this._canvasElement){var e=Me(this._canvasElement);if(null===e)throw new Error("No window is associated with the canvas");this._devicePixelRatioObservable=function(t){return new ye(t)}(e),this._devicePixelRatioObservable.subscribe((function(){return t._invalidateBitmapSize()})),this._invalidateBitmapSize()}},t.prototype._invalidateBitmapSize=function(){var t,e;if(null!==this._canvasElement){var i=Me(this._canvasElement);if(null!==i){var s=null!==(e=null===(t=this._devicePixelRatioObservable)||void 0===t?void 0:t.value)&&void 0!==e?e:i.devicePixelRatio,n=this._canvasElement.getClientRects(),o=void 0!==n[0]?function(t,e){return xe({width:Math.round(t.left*e+t.width*e)-Math.round(t.left*e),height:Math.round(t.top*e+t.height*e)-Math.round(t.top*e)})}(n[0],s):xe({width:this._canvasElementClientSize.width*s,height:this._canvasElementClientSize.height*s});this._suggestNewBitmapSize(o)}}},t.prototype._initResizeObserver=function(){var t=this;null!==this._canvasElement&&(this._canvasElementResizeObserver=new ResizeObserver((function(e){var i=e.find((function(e){return e.target===t._canvasElement}));if(i&&i.devicePixelContentBoxSize&&i.devicePixelContentBoxSize[0]){var s=i.devicePixelContentBoxSize[0],n=xe({width:s.inlineSize,height:s.blockSize});t._suggestNewBitmapSize(n)}})),this._canvasElementResizeObserver.observe(this._canvasElement,{box:"device-pixel-content-box"}))},t}();function Me(t){return t.ownerDocument.defaultView}var Te=function(){function t(t,e,i){if(0===e.width||0===e.height)throw new TypeError("Rendering target could only be created on a media with positive width and height");if(this._mediaSize=e,0===i.width||0===i.height)throw new TypeError("Rendering target could only be created using a bitmap with positive integer width and height");this._bitmapSize=i,this._context=t}return t.prototype.useMediaCoordinateSpace=function(t){try{return this._context.save(),this._context.setTransform(1,0,0,1,0,0),this._context.scale(this._horizontalPixelRatio,this._verticalPixelRatio),t({context:this._context,mediaSize:this._mediaSize})}finally{this._context.restore()}},t.prototype.useBitmapCoordinateSpace=function(t){try{return this._context.save(),this._context.setTransform(1,0,0,1,0,0),t({context:this._context,mediaSize:this._mediaSize,bitmapSize:this._bitmapSize,horizontalPixelRatio:this._horizontalPixelRatio,verticalPixelRatio:this._verticalPixelRatio})}finally{this._context.restore()}},Object.defineProperty(t.prototype,"_horizontalPixelRatio",{get:function(){return this._bitmapSize.width/this._mediaSize.width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_verticalPixelRatio",{get:function(){return this._bitmapSize.height/this._mediaSize.height},enumerable:!1,configurable:!0}),t}();function ke(t,e){var i=t.canvasElementClientSize;if(0===i.width||0===i.height)return null;var s=t.bitmapSize;if(0===s.width||0===s.height)return null;var n=t.canvasElement.getContext("2d",e);return null===n?null:new Te(n,i,s)}const Ee="undefined"!=typeof window;function ze(){return!!Ee&&window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1}function Re(){return!!Ee&&/iPhone|iPad|iPod/.test(window.navigator.platform)}function Be(t){return t+t%2}function Ie(t,e){return t.position-e.position}function Oe(t,e,i){const s=(t.position-e.position)/(t.time-e.time);return Math.sign(s)*Math.min(Math.abs(s),i)}class Ve{constructor(t,e,i,s){this._position1=null,this._position2=null,this._position3=null,this._position4=null,this._animationStartPosition=null,this._durationMsecs=0,this._speedPxPerMsec=0,this._minSpeed=t,this._maxSpeed=e,this._dumpingCoeff=i,this._minMove=s}addPosition(t,e){if(null!==this._position1){if(this._position1.time===e)return void(this._position1.position=t);if(Math.abs(this._position1.position-t)<this._minMove)return}this._position4=this._position3,this._position3=this._position2,this._position2=this._position1,this._position1={time:e,position:t}}start(t,e){if(null===this._position1||null===this._position2)return;if(e-this._position1.time>50)return;let i=0;const s=Oe(this._position1,this._position2,this._maxSpeed),n=Ie(this._position1,this._position2),o=[s],r=[n];if(i+=n,null!==this._position3){const t=Oe(this._position2,this._position3,this._maxSpeed);if(Math.sign(t)===Math.sign(s)){const e=Ie(this._position2,this._position3);if(o.push(t),r.push(e),i+=e,null!==this._position4){const t=Oe(this._position3,this._position4,this._maxSpeed);if(Math.sign(t)===Math.sign(s)){const e=Ie(this._position3,this._position4);o.push(t),r.push(e),i+=e}}}}let a=0;for(let t=0;t<o.length;++t)a+=r[t]/i*o[t];Math.abs(a)<this._minSpeed||(this._animationStartPosition={position:t,time:e},this._speedPxPerMsec=a,this._durationMsecs=function(t,e){const i=Math.log(e);return Math.log(-t/i)/i}(Math.abs(a),this._dumpingCoeff))}getPosition(t){const e=h(this._animationStartPosition),i=t-e.time;return e.position+this._speedPxPerMsec*(Math.pow(this._dumpingCoeff,i)-1)/Math.log(this._dumpingCoeff)}finished(t){return null===this._animationStartPosition||this._progressDuration(t)===this._durationMsecs}_progressDuration(t){const e=t-h(this._animationStartPosition).time;return Math.min(e,this._durationMsecs)}}function De(t,e){const i=h(t.ownerDocument).createElement("canvas");t.appendChild(i);const s=function(t,e){if("device-pixel-content-box"===e.type)return new Pe(t,e.transform,e.options);throw new Error("Unsupported binding target")}(i,{type:"device-pixel-content-box",options:{allowResizeObserver:!1},transform:(t,e)=>({width:Math.max(t.width,e.width),height:Math.max(t.height,e.height)})});return s.resizeCanvasElement(e),s}function Ae(t){var e;t.width=1,t.height=1,null===(e=t.getContext("2d"))||void 0===e||e.clearRect(0,0,1,1)}function Le(t,e,i,s){t.drawBackground&&t.drawBackground(e,i,s)}function We(t,e,i,s){t.draw(e,i,s)}function Fe(t,e,i,s){const n=t(i,s);for(const t of n){const i=t.renderer();null!==i&&e(i)}}class Ne{constructor(t,e,i){this._clickCount=0,this._clickTimeoutId=null,this._clickPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY},this._tapCount=0,this._tapTimeoutId=null,this._tapPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY},this._longTapTimeoutId=null,this._longTapActive=!1,this._mouseMoveStartPosition=null,this._touchMoveStartPosition=null,this._touchMoveExceededManhattanDistance=!1,this._cancelClick=!1,this._cancelTap=!1,this._unsubscribeOutsideMouseEvents=null,this._unsubscribeOutsideTouchEvents=null,this._unsubscribeMobileSafariEvents=null,this._unsubscribeMousemove=null,this._unsubscribeRootMouseEvents=null,this._unsubscribeRootTouchEvents=null,this._startPinchMiddlePoint=null,this._startPinchDistance=0,this._pinchPrevented=!1,this._preventTouchDragProcess=!1,this._mousePressed=!1,this._lastTouchEventTimeStamp=0,this._activeTouchId=null,this._acceptMouseLeave=!Re(),this._onFirefoxOutsideMouseUp=t=>{this._mouseUpHandler(t)},this._target=t,this._handler=e,this._options=i,this._init()}destroy(){null!==this._unsubscribeOutsideMouseEvents&&(this._unsubscribeOutsideMouseEvents(),this._unsubscribeOutsideMouseEvents=null),null!==this._unsubscribeOutsideTouchEvents&&(this._unsubscribeOutsideTouchEvents(),this._unsubscribeOutsideTouchEvents=null),null!==this._unsubscribeMousemove&&(this._unsubscribeMousemove(),this._unsubscribeMousemove=null),null!==this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null),null!==this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null),null!==this._unsubscribeMobileSafariEvents&&(this._unsubscribeMobileSafariEvents(),this._unsubscribeMobileSafariEvents=null),this._clearLongTapTimeout(),this._resetClickTimeout()}_mouseEnterHandler(t){this._unsubscribeMousemove&&this._unsubscribeMousemove();const e=this._mouseMoveHandler.bind(this);if(this._unsubscribeMousemove=()=>{this._target.removeEventListener("mousemove",e)},this._target.addEventListener("mousemove",e),this._firesTouchEvents(t))return;const i=this._makeCompatEvent(t);this._processMouseEvent(i,this._handler.mouseEnterEvent),this._acceptMouseLeave=!0}_resetClickTimeout(){null!==this._clickTimeoutId&&clearTimeout(this._clickTimeoutId),this._clickCount=0,this._clickTimeoutId=null,this._clickPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY}}_resetTapTimeout(){null!==this._tapTimeoutId&&clearTimeout(this._tapTimeoutId),this._tapCount=0,this._tapTimeoutId=null,this._tapPosition={x:Number.NEGATIVE_INFINITY,y:Number.POSITIVE_INFINITY}}_mouseMoveHandler(t){if(this._mousePressed||null!==this._touchMoveStartPosition)return;if(this._firesTouchEvents(t))return;const e=this._makeCompatEvent(t);this._processMouseEvent(e,this._handler.mouseMoveEvent),this._acceptMouseLeave=!0}_touchMoveHandler(t){const e=$e(t.changedTouches,h(this._activeTouchId));if(null===e)return;if(this._lastTouchEventTimeStamp=je(t),null!==this._startPinchMiddlePoint)return;if(this._preventTouchDragProcess)return;this._pinchPrevented=!0;const i=this._touchMouseMoveWithDownInfo(Ye(e),h(this._touchMoveStartPosition)),{xOffset:s,yOffset:n,manhattanDistance:o}=i;if(this._touchMoveExceededManhattanDistance||!(o<5)){if(!this._touchMoveExceededManhattanDistance){const t=.5*s,e=n>=t&&!this._options.treatVertTouchDragAsPageScroll(),i=t>n&&!this._options.treatHorzTouchDragAsPageScroll();e||i||(this._preventTouchDragProcess=!0),this._touchMoveExceededManhattanDistance=!0,this._cancelTap=!0,this._clearLongTapTimeout(),this._resetTapTimeout()}if(!this._preventTouchDragProcess){const i=this._makeCompatEvent(t,e);this._processTouchEvent(i,this._handler.touchMoveEvent),Ue(t)}}}_mouseMoveWithDownHandler(t){if(0!==t.button)return;const e=this._touchMouseMoveWithDownInfo(Ye(t),h(this._mouseMoveStartPosition)),{manhattanDistance:i}=e;if(i>=5&&(this._cancelClick=!0,this._resetClickTimeout()),this._cancelClick){const e=this._makeCompatEvent(t);this._processMouseEvent(e,this._handler.pressedMouseMoveEvent)}}_touchMouseMoveWithDownInfo(t,e){const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);return{xOffset:i,yOffset:s,manhattanDistance:i+s}}_touchEndHandler(t){let e=$e(t.changedTouches,h(this._activeTouchId));if(null===e&&0===t.touches.length&&(e=t.changedTouches[0]),null===e)return;this._activeTouchId=null,this._lastTouchEventTimeStamp=je(t),this._clearLongTapTimeout(),this._touchMoveStartPosition=null,this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null);const i=this._makeCompatEvent(t,e);if(this._processTouchEvent(i,this._handler.touchEndEvent),++this._tapCount,this._tapTimeoutId&&this._tapCount>1){const{manhattanDistance:t}=this._touchMouseMoveWithDownInfo(Ye(e),this._tapPosition);this._resetTapTimeout()}else this._cancelTap||(this._processTouchEvent(i,this._handler.tapEvent),this._handler.tapEvent&&Ue(t));0===this._tapCount&&Ue(t),0===t.touches.length&&this._longTapActive&&(this._longTapActive=!1,Ue(t))}_mouseUpHandler(t){if(0!==t.button)return;const e=this._makeCompatEvent(t);if(this._mouseMoveStartPosition=null,this._mousePressed=!1,this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null),ze()&&this._target.ownerDocument.documentElement.removeEventListener("mouseleave",this._onFirefoxOutsideMouseUp),!this._firesTouchEvents(t))if(this._processMouseEvent(e,this._handler.mouseUpEvent),++this._clickCount,this._clickTimeoutId&&this._clickCount>1){const{manhattanDistance:e}=this._touchMouseMoveWithDownInfo(Ye(t),this._clickPosition);this._resetClickTimeout()}else this._cancelClick||this._processMouseEvent(e,this._handler.mouseClickEvent)}_clearLongTapTimeout(){null!==this._longTapTimeoutId&&(clearTimeout(this._longTapTimeoutId),this._longTapTimeoutId=null)}_touchStartHandler(t){if(null!==this._activeTouchId)return;const e=t.changedTouches[0];this._activeTouchId=e.identifier,this._lastTouchEventTimeStamp=je(t);const i=this._target.ownerDocument.documentElement;this._cancelTap=!1,this._touchMoveExceededManhattanDistance=!1,this._preventTouchDragProcess=!1,this._touchMoveStartPosition=Ye(e),this._unsubscribeRootTouchEvents&&(this._unsubscribeRootTouchEvents(),this._unsubscribeRootTouchEvents=null);{const e=this._touchMoveHandler.bind(this),s=this._touchEndHandler.bind(this);this._unsubscribeRootTouchEvents=()=>{i.removeEventListener("touchmove",e),i.removeEventListener("touchend",s)},i.addEventListener("touchmove",e,{passive:!1}),i.addEventListener("touchend",s,{passive:!1}),this._clearLongTapTimeout(),this._longTapTimeoutId=setTimeout(this._longTapHandler.bind(this,t),240)}const s=this._makeCompatEvent(t,e);this._processTouchEvent(s,this._handler.touchStartEvent),this._tapTimeoutId||(this._tapCount=0,this._tapTimeoutId=setTimeout(this._resetTapTimeout.bind(this),500),this._tapPosition=Ye(e))}_mouseDownHandler(t){if(0!==t.button)return;const e=this._target.ownerDocument.documentElement;ze()&&e.addEventListener("mouseleave",this._onFirefoxOutsideMouseUp),this._cancelClick=!1,this._mouseMoveStartPosition=Ye(t),this._unsubscribeRootMouseEvents&&(this._unsubscribeRootMouseEvents(),this._unsubscribeRootMouseEvents=null);{const t=this._mouseMoveWithDownHandler.bind(this),i=this._mouseUpHandler.bind(this);this._unsubscribeRootMouseEvents=()=>{e.removeEventListener("mousemove",t),e.removeEventListener("mouseup",i)},e.addEventListener("mousemove",t),e.addEventListener("mouseup",i)}if(this._mousePressed=!0,this._firesTouchEvents(t))return;const i=this._makeCompatEvent(t);this._processMouseEvent(i,this._handler.mouseDownEvent),this._clickTimeoutId||(this._clickCount=0,this._clickTimeoutId=setTimeout(this._resetClickTimeout.bind(this),500),this._clickPosition=Ye(t))}_init(){this._target.addEventListener("mouseenter",this._mouseEnterHandler.bind(this)),this._target.addEventListener("touchcancel",this._clearLongTapTimeout.bind(this));{const t=this._target.ownerDocument,e=t=>{this._handler.mouseDownOutsideEvent&&(t.composed&&this._target.contains(t.composedPath()[0])||t.target&&this._target.contains(t.target)||this._handler.mouseDownOutsideEvent())};this._unsubscribeOutsideTouchEvents=()=>{t.removeEventListener("touchstart",e)},this._unsubscribeOutsideMouseEvents=()=>{t.removeEventListener("mousedown",e)},t.addEventListener("mousedown",e),t.addEventListener("touchstart",e,{passive:!0})}var t;this._target.addEventListener("mouseleave",this._mouseLeaveHandler.bind(this)),this._target.addEventListener("touchstart",this._touchStartHandler.bind(this),{passive:!0}),t=this._target,Ee&&void 0!==window.chrome&&t.addEventListener("mousedown",(t=>{if(1===t.button)return t.preventDefault(),!1})),this._target.addEventListener("mousedown",this._mouseDownHandler.bind(this)),this._initPinch(),this._target.addEventListener("touchmove",(()=>{}),{passive:!1})}_initPinch(){void 0===this._handler.pinchStartEvent&&void 0===this._handler.pinchEvent&&void 0===this._handler.pinchEndEvent||(this._target.addEventListener("touchstart",(t=>this._checkPinchState(t.touches)),{passive:!0}),this._target.addEventListener("touchmove",(t=>{if(2===t.touches.length&&null!==this._startPinchMiddlePoint&&void 0!==this._handler.pinchEvent){const e=He(t.touches[0],t.touches[1])/this._startPinchDistance;this._handler.pinchEvent(this._startPinchMiddlePoint,e),Ue(t)}}),{passive:!1}),this._target.addEventListener("touchend",(t=>{this._checkPinchState(t.touches)})))}_checkPinchState(t){1===t.length&&(this._pinchPrevented=!1),2!==t.length||this._pinchPrevented||this._longTapActive?this._stopPinch():this._startPinch(t)}_startPinch(t){const e=this._target.getBoundingClientRect()||{left:0,top:0};this._startPinchMiddlePoint={x:(t[0].clientX-e.left+(t[1].clientX-e.left))/2,y:(t[0].clientY-e.top+(t[1].clientY-e.top))/2},this._startPinchDistance=He(t[0],t[1]),void 0!==this._handler.pinchStartEvent&&this._handler.pinchStartEvent(),this._clearLongTapTimeout()}_stopPinch(){null!==this._startPinchMiddlePoint&&(this._startPinchMiddlePoint=null,void 0!==this._handler.pinchEndEvent&&this._handler.pinchEndEvent())}_mouseLeaveHandler(t){if(this._unsubscribeMousemove&&this._unsubscribeMousemove(),this._firesTouchEvents(t))return;if(!this._acceptMouseLeave)return;const e=this._makeCompatEvent(t);this._processMouseEvent(e,this._handler.mouseLeaveEvent),this._acceptMouseLeave=!Re()}_longTapHandler(t){const e=$e(t.touches,h(this._activeTouchId));if(null===e)return;const i=this._makeCompatEvent(t,e);this._processTouchEvent(i,this._handler.longTapEvent),this._cancelTap=!0,this._longTapActive=!0}_firesTouchEvents(t){return t.sourceCapabilities&&void 0!==t.sourceCapabilities.firesTouchEvents?t.sourceCapabilities.firesTouchEvents:je(t)<this._lastTouchEventTimeStamp+500}_processTouchEvent(t,e){e&&e.call(this._handler,t)}_processMouseEvent(t,e){e&&e.call(this._handler,t)}_makeCompatEvent(t,e){const i=e||t,s=this._target.getBoundingClientRect()||{left:0,top:0};return{clientX:i.clientX,clientY:i.clientY,pageX:i.pageX,pageY:i.pageY,screenX:i.screenX,screenY:i.screenY,localX:i.clientX-s.left,localY:i.clientY-s.top,ctrlKey:t.ctrlKey,altKey:t.altKey,shiftKey:t.shiftKey,metaKey:t.metaKey,isTouch:!t.type.startsWith("mouse")&&"contextmenu"!==t.type&&"click"!==t.type,srcType:t.type,target:i.target,view:t.view,preventDefault:()=>{"touchstart"!==t.type&&Ue(t)}}}}function He(t,e){const i=t.clientX-e.clientX,s=t.clientY-e.clientY;return Math.sqrt(i*i+s*s)}function Ue(t){t.cancelable&&t.preventDefault()}function Ye(t){return{x:t.pageX,y:t.pageY}}function je(t){return t.timeStamp||performance.now()}function $e(t,e){for(let i=0;i<t.length;++i)if(t[i].identifier===e)return t[i];return null}function Xe(t){return{source:t.source,object:{externalId:t.hit.externalId},cursorStyle:t.hit.cursorStyle}}function Ge(t,e,i){for(const s of t){const t=s.renderer();if(null!==t&&t.hitTest){const n=t.hitTest(e,i);if(null!==n)return{view:s,object:n}}}return null}function Ke(t,e){return i=>{var s,n,o,r;return(null!==(n=null===(s=i.priceScale())||void 0===s?void 0:s.id())&&void 0!==n?n:"")!==e?[]:null!==(r=null===(o=i.pricePaneViews)||void 0===o?void 0:o.call(i,t))&&void 0!==r?r:[]}}class Ze{constructor(t,e,i,s){this._priceScale=null,this._size=null,this._mousedown=!1,this._widthCache=new pt(200),this._font=null,this._prevOptimalWidth=0,this._isSettingSize=!1,this._canvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._pane.chart().model().lightUpdate()},this._topCanvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._pane.chart().model().lightUpdate()},this._pane=t,this._options=e,this._layoutOptions=e.layout,this._rendererOptionsProvider=i,this._isLeft="left"===s,this._sourcePaneViews=Ke("normal",s),this._sourceTopPaneViews=Ke("top",s),this._sourceBottomPaneViews=Ke("bottom",s),this._cell=document.createElement("div"),this._cell.style.height="100%",this._cell.style.overflow="hidden",this._cell.style.width="25px",this._cell.style.left="0",this._cell.style.position="relative",this._canvasBinding=De(this._cell,xe({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler);const n=this._canvasBinding.canvasElement;n.style.position="absolute",n.style.zIndex="1",n.style.left="0",n.style.top="0",this._topCanvasBinding=De(this._cell,xe({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler);const o=this._topCanvasBinding.canvasElement;o.style.position="absolute",o.style.zIndex="2",o.style.left="0",o.style.top="0";const r={mouseDownEvent:this._mouseDownEvent.bind(this),touchStartEvent:this._mouseDownEvent.bind(this),pressedMouseMoveEvent:this._pressedMouseMoveEvent.bind(this),touchMoveEvent:this._pressedMouseMoveEvent.bind(this),mouseDownOutsideEvent:this._mouseDownOutsideEvent.bind(this),mouseUpEvent:this._mouseUpEvent.bind(this),touchEndEvent:this._mouseUpEvent.bind(this),mouseEnterEvent:this._mouseEnterEvent.bind(this),mouseLeaveEvent:this._mouseLeaveEvent.bind(this)};this._mouseEventHandler=new Ne(this._topCanvasBinding.canvasElement,r,{treatVertTouchDragAsPageScroll:()=>!this._options.handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:()=>!0})}destroy(){this._mouseEventHandler.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler),Ae(this._topCanvasBinding.canvasElement),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Ae(this._canvasBinding.canvasElement),this._canvasBinding.dispose(),null!==this._priceScale&&this._priceScale.onMarksChanged().unsubscribeAll(this),this._priceScale=null}getElement(){return this._cell}fontSize(){return this._layoutOptions.fontSize}rendererOptions(){const t=this._rendererOptionsProvider.options();return this._font!==t.font&&(this._widthCache.reset(),this._font=t.font),t}optimalWidth(){if(null===this._priceScale)return 0;let t=0;const e=this.rendererOptions(),i=h(this._canvasBinding.canvasElement.getContext("2d"));i.save();const s=this._priceScale.marks();i.font=this._baseFont(),s.length>0&&(t=Math.max(this._widthCache.measureText(i,s[0].label),this._widthCache.measureText(i,s[s.length-1].label)));const n=this._backLabels();for(let e=n.length;e--;){const s=this._widthCache.measureText(i,n[e].text());s>t&&(t=s)}const o=this._priceScale.firstValue();if(null!==o&&null!==this._size){const e=this._priceScale.coordinateToPrice(1,o),s=this._priceScale.coordinateToPrice(this._size.height-2,o);t=Math.max(t,this._widthCache.measureText(i,this._priceScale.formatPrice(Math.floor(Math.min(e,s))+.11111111111111,o)),this._widthCache.measureText(i,this._priceScale.formatPrice(Math.ceil(Math.max(e,s))-.11111111111111,o)))}i.restore();const r=t||34;return Be(Math.ceil(e.borderSize+e.tickLength+e.paddingInner+e.paddingOuter+5+r))}setSize(t){null!==this._size&&Ce(this._size,t)||(this._size=t,this._isSettingSize=!0,this._canvasBinding.resizeCanvasElement(t),this._topCanvasBinding.resizeCanvasElement(t),this._isSettingSize=!1,this._cell.style.width=`${t.width}px`,this._cell.style.height=`${t.height}px`)}getWidth(){return h(this._size).width}setPriceScale(t){this._priceScale!==t&&(null!==this._priceScale&&this._priceScale.onMarksChanged().unsubscribeAll(this),this._priceScale=t,t.onMarksChanged().subscribe(this._onMarksChanged.bind(this),this))}priceScale(){return this._priceScale}reset(){const t=this._pane.state();this._pane.chart().model().resetPriceScale(t,h(this.priceScale()))}paint(t){if(null===this._size)return;if(1!==t){this._alignLabels(),this._canvasBinding.applySuggestedBitmapSize();const t=ke(this._canvasBinding);null!==t&&(t.useBitmapCoordinateSpace((t=>{this._drawBackground(t),this._drawBorder(t)})),this._pane.drawAdditionalSources(t,this._sourceBottomPaneViews),this._drawTickMarks(t),this._pane.drawAdditionalSources(t,this._sourcePaneViews),this._drawBackLabels(t))}this._topCanvasBinding.applySuggestedBitmapSize();const e=ke(this._topCanvasBinding);null!==e&&(e.useBitmapCoordinateSpace((({context:t,bitmapSize:e})=>{t.clearRect(0,0,e.width,e.height)})),this._drawCrosshairLabel(e),this._pane.drawAdditionalSources(e,this._sourceTopPaneViews))}getBitmapSize(){return this._canvasBinding.bitmapSize}drawBitmap(t,e,i){const s=this.getBitmapSize();s.width>0&&s.height>0&&t.drawImage(this._canvasBinding.canvasElement,e,i)}update(){var t;null===(t=this._priceScale)||void 0===t||t.marks()}_mouseDownEvent(t){if(null===this._priceScale||this._priceScale.isEmpty()||!this._options.handleScale.axisPressedMouseMove.price)return;const e=this._pane.chart().model(),i=this._pane.state();this._mousedown=!0,e.startScalePrice(i,this._priceScale,t.localY)}_pressedMouseMoveEvent(t){if(null===this._priceScale||!this._options.handleScale.axisPressedMouseMove.price)return;const e=this._pane.chart().model(),i=this._pane.state(),s=this._priceScale;e.scalePriceTo(i,s,t.localY)}_mouseDownOutsideEvent(){if(null===this._priceScale||!this._options.handleScale.axisPressedMouseMove.price)return;const t=this._pane.chart().model(),e=this._pane.state(),i=this._priceScale;this._mousedown&&(this._mousedown=!1,t.endScalePrice(e,i))}_mouseUpEvent(t){if(null===this._priceScale||!this._options.handleScale.axisPressedMouseMove.price)return;const e=this._pane.chart().model(),i=this._pane.state();this._mousedown=!1,e.endScalePrice(i,this._priceScale)}_mouseEnterEvent(t){null!==this._priceScale&&(!this._pane.chart().model().options().handleScale.axisPressedMouseMove.price||this._priceScale.isPercentage()||this._priceScale.isIndexedTo100()||this._setCursor(1))}_mouseLeaveEvent(t){this._setCursor(0)}_backLabels(){const t=[],e=null===this._priceScale?void 0:this._priceScale;return(i=>{for(let s=0;s<i.length;++s){const n=i[s].priceAxisViews(this._pane.state(),e);for(let e=0;e<n.length;e++)t.push(n[e])}})(this._pane.state().orderedSources()),t}_drawBackground({context:t,bitmapSize:e}){const{width:i,height:s}=e,n=this._pane.state().model(),o=n.backgroundTopColor(),r=n.backgroundBottomColor();o===r?k(t,0,0,i,s,o):B(t,0,0,i,s,o,r)}_drawBorder({context:t,bitmapSize:e,horizontalPixelRatio:i}){if(null===this._size||null===this._priceScale||!this._priceScale.options().borderVisible)return;t.fillStyle=this._priceScale.options().borderColor;const s=Math.max(1,Math.floor(this.rendererOptions().borderSize*i));let n;n=this._isLeft?e.width-s:0,t.fillRect(n,0,s,e.height)}_drawTickMarks(t){if(null===this._size||null===this._priceScale)return;const e=this._priceScale.marks(),i=this._priceScale.options(),s=this.rendererOptions(),n=this._isLeft?this._size.width-s.tickLength:0;i.borderVisible&&i.ticksVisible&&t.useBitmapCoordinateSpace((({context:t,horizontalPixelRatio:o,verticalPixelRatio:r})=>{t.fillStyle=i.borderColor;const a=Math.max(1,Math.floor(r)),l=Math.floor(.5*r),h=Math.round(s.tickLength*o);t.beginPath();for(const i of e)t.rect(Math.floor(n*o),Math.round(i.coord*r)-l,h,a);t.fill()})),t.useMediaCoordinateSpace((({context:t})=>{var o;t.font=this._baseFont(),t.fillStyle=null!==(o=i.textColor)&&void 0!==o?o:this._layoutOptions.textColor,t.textAlign=this._isLeft?"right":"left",t.textBaseline="middle";const r=this._isLeft?Math.round(n-s.paddingInner):Math.round(n+s.tickLength+s.paddingInner),a=e.map((e=>this._widthCache.yMidCorrection(t,e.label)));for(let i=e.length;i--;){const s=e[i];t.fillText(s.label,r,s.coord+a[i])}}))}_alignLabels(){if(null===this._size||null===this._priceScale)return;let t=this._size.height/2;const e=[],i=this._priceScale.orderedSources().slice(),s=this._pane.state(),n=this.rendererOptions();this._priceScale===s.defaultVisiblePriceScale()&&this._pane.state().orderedSources().forEach((t=>{s.isOverlay(t)&&i.push(t)}));const o=this._priceScale.dataSources()[0],r=this._priceScale;i.forEach((i=>{const n=i.priceAxisViews(s,r);n.forEach((t=>{t.setFixedCoordinate(null),t.isVisible()&&e.push(t)})),o===i&&n.length>0&&(t=n[0].coordinate())})),e.forEach((t=>t.setFixedCoordinate(t.coordinate()))),this._priceScale.options().alignLabels&&this._fixLabelOverlap(e,n,t)}_fixLabelOverlap(t,e,i){if(null===this._size)return;const s=t.filter((t=>t.coordinate()<=i)),n=t.filter((t=>t.coordinate()>i));s.sort(((t,e)=>e.coordinate()-t.coordinate())),s.length&&n.length&&n.push(s[0]),n.sort(((t,e)=>t.coordinate()-e.coordinate()));for(const i of t){const t=Math.floor(i.height(e)/2),s=i.coordinate();s>-t&&s<t&&i.setFixedCoordinate(t),s>this._size.height-t&&s<this._size.height+t&&i.setFixedCoordinate(this._size.height-t)}for(let t=1;t<s.length;t++){const i=s[t],n=s[t-1],o=n.height(e,!1),r=i.coordinate(),a=n.getFixedCoordinate();r>a-o&&i.setFixedCoordinate(a-o)}for(let t=1;t<n.length;t++){const i=n[t],s=n[t-1],o=s.height(e,!0),r=i.coordinate(),a=s.getFixedCoordinate();r<a+o&&i.setFixedCoordinate(a+o)}}_drawBackLabels(t){if(null===this._size)return;const e=this._backLabels(),i=this.rendererOptions(),s=this._isLeft?"right":"left";e.forEach((e=>{e.isAxisLabelVisible()&&e.renderer(h(this._priceScale)).draw(t,i,this._widthCache,s)}))}_drawCrosshairLabel(t){if(null===this._size||null===this._priceScale)return;const e=this._pane.chart().model(),i=[],s=this._pane.state(),n=e.crosshairSource().priceAxisViews(s,this._priceScale);n.length&&i.push(n);const o=this.rendererOptions(),r=this._isLeft?"right":"left";i.forEach((e=>{e.forEach((e=>{e.renderer(h(this._priceScale)).draw(t,o,this._widthCache,r)}))}))}_setCursor(t){this._cell.style.cursor=1===t?"ns-resize":"default"}_onMarksChanged(){const t=this.optimalWidth();this._prevOptimalWidth<t&&this._pane.chart().model().fullUpdate(),this._prevOptimalWidth=t}_baseFont(){return Ct(this._layoutOptions.fontSize,this._layoutOptions.fontFamily)}}function qe(t,e){var i,s;return null!==(s=null===(i=t.bottomPaneViews)||void 0===i?void 0:i.call(t,e))&&void 0!==s?s:[]}function Qe(t,e){var i,s;return null!==(s=null===(i=t.paneViews)||void 0===i?void 0:i.call(t,e))&&void 0!==s?s:[]}function Je(t,e){var i,s;return null!==(s=null===(i=t.labelPaneViews)||void 0===i?void 0:i.call(t,e))&&void 0!==s?s:[]}function ti(t,e){var i,s;return null!==(s=null===(i=t.topPaneViews)||void 0===i?void 0:i.call(t,e))&&void 0!==s?s:[]}class ei{constructor(t,e){this._size=xe({width:0,height:0}),this._leftPriceAxisWidget=null,this._rightPriceAxisWidget=null,this._startScrollingPos=null,this._isScrolling=!1,this._clicked=new wt,this._prevPinchScale=0,this._longTap=!1,this._startTrackPoint=null,this._exitTrackingModeOnNextTry=!1,this._initCrosshairPosition=null,this._scrollXAnimation=null,this._isSettingSize=!1,this._canvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||null===this._state||this._model().lightUpdate()},this._topCanvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||null===this._state||this._model().lightUpdate()},this._chart=t,this._state=e,this._state.onDestroyed().subscribe(this._onStateDestroyed.bind(this),this,!0),this._paneCell=document.createElement("td"),this._paneCell.style.padding="0",this._paneCell.style.position="relative";const i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.style.position="relative",i.style.overflow="hidden",this._leftAxisCell=document.createElement("td"),this._leftAxisCell.style.padding="0",this._rightAxisCell=document.createElement("td"),this._rightAxisCell.style.padding="0",this._paneCell.appendChild(i),this._canvasBinding=De(i,xe({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler);const s=this._canvasBinding.canvasElement;s.style.position="absolute",s.style.zIndex="1",s.style.left="0",s.style.top="0",this._topCanvasBinding=De(i,xe({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler);const n=this._topCanvasBinding.canvasElement;n.style.position="absolute",n.style.zIndex="2",n.style.left="0",n.style.top="0",this._rowElement=document.createElement("tr"),this._rowElement.appendChild(this._leftAxisCell),this._rowElement.appendChild(this._paneCell),this._rowElement.appendChild(this._rightAxisCell),this.updatePriceAxisWidgetsStates(),this._mouseEventHandler=new Ne(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:()=>null===this._startTrackPoint&&!this._chart.options().handleScroll.vertTouchDrag,treatHorzTouchDragAsPageScroll:()=>null===this._startTrackPoint&&!this._chart.options().handleScroll.horzTouchDrag})}destroy(){null!==this._leftPriceAxisWidget&&this._leftPriceAxisWidget.destroy(),null!==this._rightPriceAxisWidget&&this._rightPriceAxisWidget.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler),Ae(this._topCanvasBinding.canvasElement),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Ae(this._canvasBinding.canvasElement),this._canvasBinding.dispose(),null!==this._state&&this._state.onDestroyed().unsubscribeAll(this),this._mouseEventHandler.destroy()}state(){return h(this._state)}setState(t){null!==this._state&&this._state.onDestroyed().unsubscribeAll(this),this._state=t,null!==this._state&&this._state.onDestroyed().subscribe(ei.prototype._onStateDestroyed.bind(this),this,!0),this.updatePriceAxisWidgetsStates()}chart(){return this._chart}getElement(){return this._rowElement}updatePriceAxisWidgetsStates(){if(null!==this._state&&(this._recreatePriceAxisWidgets(),0!==this._model().serieses().length)){if(null!==this._leftPriceAxisWidget){const t=this._state.leftPriceScale();this._leftPriceAxisWidget.setPriceScale(h(t))}if(null!==this._rightPriceAxisWidget){const t=this._state.rightPriceScale();this._rightPriceAxisWidget.setPriceScale(h(t))}}}updatePriceAxisWidgets(){null!==this._leftPriceAxisWidget&&this._leftPriceAxisWidget.update(),null!==this._rightPriceAxisWidget&&this._rightPriceAxisWidget.update()}stretchFactor(){return null!==this._state?this._state.stretchFactor():0}setStretchFactor(t){this._state&&this._state.setStretchFactor(t)}mouseEnterEvent(t){if(!this._state)return;this._onMouseEvent();const e=t.localX,i=t.localY;this._setCrosshairPosition(e,i,t)}mouseDownEvent(t){this._onMouseEvent(),this._mouseTouchDownEvent(),this._setCrosshairPosition(t.localX,t.localY,t)}mouseMoveEvent(t){var e;if(!this._state)return;this._onMouseEvent();const i=t.localX,s=t.localY;this._setCrosshairPosition(i,s,t);const n=this.hitTest(i,s);this._chart.setCursorStyle(null!==(e=null==n?void 0:n.cursorStyle)&&void 0!==e?e:null),this._model().setHoveredSource(n&&{source:n.source,object:n.object})}mouseClickEvent(t){null!==this._state&&(this._onMouseEvent(),this._fireClickedDelegate(t))}pressedMouseMoveEvent(t){this._onMouseEvent(),this._pressedMouseTouchMoveEvent(t),this._setCrosshairPosition(t.localX,t.localY,t)}mouseUpEvent(t){null!==this._state&&(this._onMouseEvent(),this._longTap=!1,this._endScroll(t))}tapEvent(t){null!==this._state&&this._fireClickedDelegate(t)}longTapEvent(t){if(this._longTap=!0,null===this._startTrackPoint){const e={x:t.localX,y:t.localY};this._startTrackingMode(e,e,t)}}mouseLeaveEvent(t){null!==this._state&&(this._onMouseEvent(),this._state.model().setHoveredSource(null),this._clearCrosshairPosition())}clicked(){return this._clicked}pinchStartEvent(){this._prevPinchScale=1,this._model().stopTimeScaleAnimation()}pinchEvent(t,e){if(!this._chart.options().handleScale.pinch)return;const i=5*(e-this._prevPinchScale);this._prevPinchScale=e,this._model().zoomTime(t.x,i)}touchStartEvent(t){this._longTap=!1,this._exitTrackingModeOnNextTry=null!==this._startTrackPoint,this._mouseTouchDownEvent();const e=this._model().crosshairSource();null!==this._startTrackPoint&&e.visible()&&(this._initCrosshairPosition={x:e.appliedX(),y:e.appliedY()},this._startTrackPoint={x:t.localX,y:t.localY})}touchMoveEvent(t){if(null===this._state)return;const e=t.localX,i=t.localY;if(null===this._startTrackPoint)this._pressedMouseTouchMoveEvent(t);else{this._exitTrackingModeOnNextTry=!1;const s=h(this._initCrosshairPosition),n=s.x+(e-this._startTrackPoint.x),o=s.y+(i-this._startTrackPoint.y);this._setCrosshairPosition(n,o,t)}}touchEndEvent(t){0===this.chart().options().trackingMode.exitMode&&(this._exitTrackingModeOnNextTry=!0),this._tryExitTrackingMode(),this._endScroll(t)}hitTest(t,e){const i=this._state;return null===i?null:function(t,e,i){const s=t.orderedSources(),n=function(t,e,i){var s,n;let o,r;for(const h of t){const t=null!==(n=null===(s=h.primitiveHitTest)||void 0===s?void 0:s.call(h,e,i))&&void 0!==n?n:[];for(const e of t)a=e.zOrder,(!(l=null==o?void 0:o.zOrder)||"top"===a&&"top"!==l||"normal"===a&&"bottom"===l)&&(o=e,r=h)}var a,l;return o&&r?{hit:o,source:r}:null}(s,e,i);if("top"===(null==n?void 0:n.hit.zOrder))return Xe(n);for(const o of s){if(n&&n.source===o&&"bottom"!==n.hit.zOrder&&!n.hit.isBackground)return Xe(n);const s=Ge(o.paneViews(t),e,i);if(null!==s)return{source:o,view:s.view,object:s.object};if(n&&n.source===o&&"bottom"!==n.hit.zOrder&&n.hit.isBackground)return Xe(n)}return(null==n?void 0:n.hit)?Xe(n):null}(i,t,e)}setPriceAxisSize(t,e){h("left"===e?this._leftPriceAxisWidget:this._rightPriceAxisWidget).setSize(xe({width:t,height:this._size.height}))}getSize(){return this._size}setSize(t){Ce(this._size,t)||(this._size=t,this._isSettingSize=!0,this._canvasBinding.resizeCanvasElement(t),this._topCanvasBinding.resizeCanvasElement(t),this._isSettingSize=!1,this._paneCell.style.width=t.width+"px",this._paneCell.style.height=t.height+"px")}recalculatePriceScales(){const t=h(this._state);t.recalculatePriceScale(t.leftPriceScale()),t.recalculatePriceScale(t.rightPriceScale());for(const e of t.dataSources())if(t.isOverlay(e)){const i=e.priceScale();null!==i&&t.recalculatePriceScale(i),e.updateAllViews()}}paint(t){if(0===t)return;if(null===this._state)return;if(t>1&&this.recalculatePriceScales(),null!==this._leftPriceAxisWidget&&this._leftPriceAxisWidget.paint(t),null!==this._rightPriceAxisWidget&&this._rightPriceAxisWidget.paint(t),1!==t){this._canvasBinding.applySuggestedBitmapSize();const t=ke(this._canvasBinding);null!==t&&(t.useBitmapCoordinateSpace((t=>{this._drawBackground(t)})),this._state&&(this._drawSources(t,qe),this._drawGrid(t),this._drawSources(t,Qe),this._drawSources(t,Je)))}this._topCanvasBinding.applySuggestedBitmapSize();const e=ke(this._topCanvasBinding);null!==e&&(e.useBitmapCoordinateSpace((({context:t,bitmapSize:e})=>{t.clearRect(0,0,e.width,e.height)})),this._drawCrosshair(e),this._drawSources(e,ti))}leftPriceAxisWidget(){return this._leftPriceAxisWidget}rightPriceAxisWidget(){return this._rightPriceAxisWidget}drawAdditionalSources(t,e){this._drawSources(t,e)}_onStateDestroyed(){null!==this._state&&this._state.onDestroyed().unsubscribeAll(this),this._state=null}_fireClickedDelegate(t){this._fireMouseClickDelegate(this._clicked,t)}_fireMouseClickDelegate(t,e){const i=e.localX,s=e.localY;t.hasListeners()&&t.fire(this._model().timeScale().coordinateToIndex(i),{x:i,y:s},e)}_drawBackground({context:t,bitmapSize:e}){const{width:i,height:s}=e,n=this._model(),o=n.backgroundTopColor(),r=n.backgroundBottomColor();o===r?k(t,0,0,i,s,r):B(t,0,0,i,s,o,r)}_drawGrid(t){const e=h(this._state).grid().paneView().renderer();null!==e&&e.draw(t,!1)}_drawCrosshair(t){this._drawSourceImpl(t,Qe,We,this._model().crosshairSource())}_drawSources(t,e){const i=h(this._state).orderedSources();for(const s of i)this._drawSourceImpl(t,e,Le,s);for(const s of i)this._drawSourceImpl(t,e,We,s)}_drawSourceImpl(t,e,i,s){const n=h(this._state),o=n.model().hoveredSource(),r=null!==o&&o.source===s,a=null!==o&&r&&void 0!==o.object?o.object.hitTestData:void 0;Fe(e,(e=>i(e,t,r,a)),s,n)}_recreatePriceAxisWidgets(){if(null===this._state)return;const t=this._chart,e=this._state.leftPriceScale().options().visible,i=this._state.rightPriceScale().options().visible;e||null===this._leftPriceAxisWidget||(this._leftAxisCell.removeChild(this._leftPriceAxisWidget.getElement()),this._leftPriceAxisWidget.destroy(),this._leftPriceAxisWidget=null),i||null===this._rightPriceAxisWidget||(this._rightAxisCell.removeChild(this._rightPriceAxisWidget.getElement()),this._rightPriceAxisWidget.destroy(),this._rightPriceAxisWidget=null);const s=t.model().rendererOptionsProvider();e&&null===this._leftPriceAxisWidget&&(this._leftPriceAxisWidget=new Ze(this,t.options(),s,"left"),this._leftAxisCell.appendChild(this._leftPriceAxisWidget.getElement())),i&&null===this._rightPriceAxisWidget&&(this._rightPriceAxisWidget=new Ze(this,t.options(),s,"right"),this._rightAxisCell.appendChild(this._rightPriceAxisWidget.getElement()))}_preventScroll(t){return t.isTouch&&this._longTap||null!==this._startTrackPoint}_correctXCoord(t){return Math.max(0,Math.min(t,this._size.width-1))}_correctYCoord(t){return Math.max(0,Math.min(t,this._size.height-1))}_setCrosshairPosition(t,e,i){this._model().setAndSaveCurrentPosition(this._correctXCoord(t),this._correctYCoord(e),i,h(this._state))}_clearCrosshairPosition(){this._model().clearCurrentPosition()}_tryExitTrackingMode(){this._exitTrackingModeOnNextTry&&(this._startTrackPoint=null,this._clearCrosshairPosition())}_startTrackingMode(t,e,i){this._startTrackPoint=t,this._exitTrackingModeOnNextTry=!1,this._setCrosshairPosition(e.x,e.y,i);const s=this._model().crosshairSource();this._initCrosshairPosition={x:s.appliedX(),y:s.appliedY()}}_model(){return this._chart.model()}_endScroll(t){if(!this._isScrolling)return;const e=this._model(),i=this.state();if(e.endScrollPrice(i,i.defaultPriceScale()),this._startScrollingPos=null,this._isScrolling=!1,e.endScrollTime(),null!==this._scrollXAnimation){const t=performance.now(),i=e.timeScale();this._scrollXAnimation.start(i.rightOffset(),t),this._scrollXAnimation.finished(t)||e.setTimeScaleAnimation(this._scrollXAnimation)}}_onMouseEvent(){this._startTrackPoint=null}_mouseTouchDownEvent(){if(this._state){if(this._model().stopTimeScaleAnimation(),document.activeElement!==document.body&&document.activeElement!==document.documentElement)h(document.activeElement).blur();else{const t=document.getSelection();null!==t&&t.removeAllRanges()}this._state.defaultPriceScale().isEmpty()||this._model().timeScale().isEmpty()}}_pressedMouseTouchMoveEvent(t){if(null===this._state)return;const e=this._model(),i=e.timeScale();if(i.isEmpty())return;const s=this._chart.options(),n=s.handleScroll,o=s.kineticScroll;if((!n.pressedMouseMove||t.isTouch)&&(!n.horzTouchDrag&&!n.vertTouchDrag||!t.isTouch))return;const r=this._state.defaultPriceScale(),a=performance.now();if(null!==this._startScrollingPos||this._preventScroll(t)||(this._startScrollingPos={x:t.clientX,y:t.clientY,timestamp:a,localX:t.localX,localY:t.localY}),null!==this._startScrollingPos&&!this._isScrolling&&(this._startScrollingPos.x!==t.clientX||this._startScrollingPos.y!==t.clientY)){if(t.isTouch&&o.touch||!t.isTouch&&o.mouse){const t=i.barSpacing();this._scrollXAnimation=new Ve(.2/t,7/t,.997,15/t),this._scrollXAnimation.addPosition(i.rightOffset(),this._startScrollingPos.timestamp)}else this._scrollXAnimation=null;r.isEmpty()||e.startScrollPrice(this._state,r,t.localY),e.startScrollTime(t.localX),this._isScrolling=!0}this._isScrolling&&(r.isEmpty()||e.scrollPriceTo(this._state,r,t.localY),e.scrollTimeTo(t.localX),null!==this._scrollXAnimation&&this._scrollXAnimation.addPosition(i.rightOffset(),a))}}class ii{constructor(t,e,i,s,n){this._invalidated=!0,this._size=xe({width:0,height:0}),this._canvasSuggestedBitmapSizeChangedHandler=()=>this.paint(3),this._isLeft="left"===t,this._rendererOptionsProvider=i.rendererOptionsProvider,this._options=e,this._borderVisible=s,this._bottomColor=n,this._cell=document.createElement("div"),this._cell.style.width="25px",this._cell.style.height="100%",this._cell.style.overflow="hidden",this._canvasBinding=De(this._cell,xe({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler)}destroy(){this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Ae(this._canvasBinding.canvasElement),this._canvasBinding.dispose()}getElement(){return this._cell}getSize(){return this._size}setSize(t){Ce(this._size,t)||(this._size=t,this._canvasBinding.resizeCanvasElement(t),this._cell.style.width=`${t.width}px`,this._cell.style.height=`${t.height}px`,this._invalidated=!0)}paint(t){if(t<3&&!this._invalidated)return;if(0===this._size.width||0===this._size.height)return;this._invalidated=!1,this._canvasBinding.applySuggestedBitmapSize();const e=ke(this._canvasBinding);null!==e&&e.useBitmapCoordinateSpace((t=>{this._drawBackground(t),this._drawBorder(t)}))}_drawBorder({context:t,bitmapSize:e,horizontalPixelRatio:i,verticalPixelRatio:s}){if(!this._borderVisible())return;t.fillStyle=this._options.timeScale.borderColor;const n=Math.floor(this._rendererOptionsProvider.options().borderSize*i),o=Math.floor(this._rendererOptionsProvider.options().borderSize*s),r=this._isLeft?e.width-n:0;t.fillRect(r,0,n,o)}_drawBackground({context:t,bitmapSize:e}){k(t,0,0,e.width,e.height,this._bottomColor())}}function si(t){return e=>{var i,s;return null!==(s=null===(i=e.timePaneViews)||void 0===i?void 0:i.call(e,t))&&void 0!==s?s:[]}}const ni=si("normal"),oi=si("top"),ri=si("bottom");class ai{constructor(t,e){this._leftStub=null,this._rightStub=null,this._rendererOptions=null,this._mouseDown=!1,this._size=xe({width:0,height:0}),this._sizeChanged=new wt,this._widthCache=new pt(5),this._isSettingSize=!1,this._canvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._chart.model().lightUpdate()},this._topCanvasSuggestedBitmapSizeChangedHandler=()=>{this._isSettingSize||this._chart.model().lightUpdate()},this._chart=t,this._horzScaleBehavior=e,this._options=t.options().layout,this._element=document.createElement("tr"),this._leftStubCell=document.createElement("td"),this._leftStubCell.style.padding="0",this._rightStubCell=document.createElement("td"),this._rightStubCell.style.padding="0",this._cell=document.createElement("td"),this._cell.style.height="25px",this._cell.style.padding="0",this._dv=document.createElement("div"),this._dv.style.width="100%",this._dv.style.height="100%",this._dv.style.position="relative",this._dv.style.overflow="hidden",this._cell.appendChild(this._dv),this._canvasBinding=De(this._dv,xe({width:16,height:16})),this._canvasBinding.subscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler);const i=this._canvasBinding.canvasElement;i.style.position="absolute",i.style.zIndex="1",i.style.left="0",i.style.top="0",this._topCanvasBinding=De(this._dv,xe({width:16,height:16})),this._topCanvasBinding.subscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler);const s=this._topCanvasBinding.canvasElement;s.style.position="absolute",s.style.zIndex="2",s.style.left="0",s.style.top="0",this._element.appendChild(this._leftStubCell),this._element.appendChild(this._cell),this._element.appendChild(this._rightStubCell),this._recreateStubs(),this._chart.model().priceScalesOptionsChanged().subscribe(this._recreateStubs.bind(this),this),this._mouseEventHandler=new Ne(this._topCanvasBinding.canvasElement,this,{treatVertTouchDragAsPageScroll:()=>!0,treatHorzTouchDragAsPageScroll:()=>!this._chart.options().handleScroll.horzTouchDrag})}destroy(){this._mouseEventHandler.destroy(),null!==this._leftStub&&this._leftStub.destroy(),null!==this._rightStub&&this._rightStub.destroy(),this._topCanvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._topCanvasSuggestedBitmapSizeChangedHandler),Ae(this._topCanvasBinding.canvasElement),this._topCanvasBinding.dispose(),this._canvasBinding.unsubscribeSuggestedBitmapSizeChanged(this._canvasSuggestedBitmapSizeChangedHandler),Ae(this._canvasBinding.canvasElement),this._canvasBinding.dispose()}getElement(){return this._element}mouseDownEvent(t){if(this._mouseDown)return;this._mouseDown=!0;const e=this._chart.model();!e.timeScale().isEmpty()&&this._chart.options().handleScale.axisPressedMouseMove.time&&e.startScaleTime(t.localX)}touchStartEvent(t){this.mouseDownEvent(t)}mouseDownOutsideEvent(){const t=this._chart.model();!t.timeScale().isEmpty()&&this._mouseDown&&(this._mouseDown=!1,this._chart.options().handleScale.axisPressedMouseMove.time&&t.endScaleTime())}pressedMouseMoveEvent(t){const e=this._chart.model();!e.timeScale().isEmpty()&&this._chart.options().handleScale.axisPressedMouseMove.time&&e.scaleTimeTo(t.localX)}touchMoveEvent(t){this.pressedMouseMoveEvent(t)}mouseUpEvent(){this._mouseDown=!1;const t=this._chart.model();t.timeScale().isEmpty()&&!this._chart.options().handleScale.axisPressedMouseMove.time||t.endScaleTime()}touchEndEvent(){this.mouseUpEvent()}mouseEnterEvent(){this._chart.model().options().handleScale.axisPressedMouseMove.time&&this._setCursor(1)}mouseLeaveEvent(){this._setCursor(0)}getSize(){return this._size}setSizes(t,e,i){Ce(this._size,t)||(this._size=t,this._isSettingSize=!0,this._canvasBinding.resizeCanvasElement(t),this._topCanvasBinding.resizeCanvasElement(t),this._isSettingSize=!1,this._cell.style.width=`${t.width}px`,this._cell.style.height=`${t.height}px`,this._sizeChanged.fire(t)),null!==this._leftStub&&this._leftStub.setSize(xe({width:e,height:t.height})),null!==this._rightStub&&this._rightStub.setSize(xe({width:i,height:t.height}))}optimalHeight(){const t=this._getRendererOptions();return Math.ceil(t.borderSize+t.tickLength+t.fontSize+t.paddingTop+t.paddingBottom+t.labelBottomOffset)}update(){this._chart.model().timeScale().marks()}paint(t){if(0===t)return;if(1!==t){this._canvasBinding.applySuggestedBitmapSize();const e=ke(this._canvasBinding);null!==e&&(e.useBitmapCoordinateSpace((t=>{this._drawBackground(t),this._drawBorder(t),this._drawAdditionalSources(e,ri)})),this._drawTickMarks(e),this._drawAdditionalSources(e,ni)),null!==this._leftStub&&this._leftStub.paint(t),null!==this._rightStub&&this._rightStub.paint(t)}this._topCanvasBinding.applySuggestedBitmapSize();const e=ke(this._topCanvasBinding);null!==e&&(e.useBitmapCoordinateSpace((({context:t,bitmapSize:e})=>{t.clearRect(0,0,e.width,e.height)})),this._drawLabels([...this._chart.model().serieses(),this._chart.model().crosshairSource()],e),this._drawAdditionalSources(e,oi))}_drawAdditionalSources(t,e){const i=this._chart.model().serieses();for(const s of i)Fe(e,(e=>Le(e,t,!1,void 0)),s,void 0);for(const s of i)Fe(e,(e=>We(e,t,!1,void 0)),s,void 0)}_drawBackground({context:t,bitmapSize:e}){k(t,0,0,e.width,e.height,this._chart.model().backgroundBottomColor())}_drawBorder({context:t,bitmapSize:e,verticalPixelRatio:i}){if(this._chart.options().timeScale.borderVisible){t.fillStyle=this._lineColor();const s=Math.max(1,Math.floor(this._getRendererOptions().borderSize*i));t.fillRect(0,0,e.width,s)}}_drawTickMarks(t){const e=this._chart.model().timeScale(),i=e.marks();if(!i||0===i.length)return;const s=this._horzScaleBehavior.maxTickMarkWeight(i),n=this._getRendererOptions(),o=e.options();o.borderVisible&&o.ticksVisible&&t.useBitmapCoordinateSpace((({context:t,horizontalPixelRatio:e,verticalPixelRatio:s})=>{t.strokeStyle=this._lineColor(),t.fillStyle=this._lineColor();const o=Math.max(1,Math.floor(e)),r=Math.floor(.5*e);t.beginPath();const a=Math.round(n.tickLength*s);for(let s=i.length;s--;){const n=Math.round(i[s].coord*e);t.rect(n-r,0,o,a)}t.fill()})),t.useMediaCoordinateSpace((({context:t})=>{const e=n.borderSize+n.tickLength+n.paddingTop+n.fontSize/2;t.textAlign="center",t.textBaseline="middle",t.fillStyle=this._textColor(),t.font=this._baseFont();for(const n of i)if(n.weight<s){const i=n.needAlignCoordinate?this._alignTickMarkLabelCoordinate(t,n.coord,n.label):n.coord;t.fillText(n.label,i,e)}this._chart.options().timeScale.allowBoldLabels&&(t.font=this._baseBoldFont());for(const n of i)if(n.weight>=s){const i=n.needAlignCoordinate?this._alignTickMarkLabelCoordinate(t,n.coord,n.label):n.coord;t.fillText(n.label,i,e)}}))}_alignTickMarkLabelCoordinate(t,e,i){const s=this._widthCache.measureText(t,i),n=s/2,o=Math.floor(e-n)+.5;return o<0?e+=Math.abs(0-o):o+s>this._size.width&&(e-=Math.abs(this._size.width-(o+s))),e}_drawLabels(t,e){const i=this._getRendererOptions();for(const s of t)for(const t of s.timeAxisViews())t.renderer().draw(e,i)}_lineColor(){return this._chart.options().timeScale.borderColor}_textColor(){return this._options.textColor}_fontSize(){return this._options.fontSize}_baseFont(){return Ct(this._fontSize(),this._options.fontFamily)}_baseBoldFont(){return Ct(this._fontSize(),this._options.fontFamily,"bold")}_getRendererOptions(){null===this._rendererOptions&&(this._rendererOptions={borderSize:1,baselineOffset:NaN,paddingTop:NaN,paddingBottom:NaN,paddingHorizontal:NaN,tickLength:5,fontSize:NaN,font:"",widthCache:new pt,labelBottomOffset:0});const t=this._rendererOptions,e=this._baseFont();if(t.font!==e){const i=this._fontSize();t.fontSize=i,t.font=e,t.paddingTop=3*i/12,t.paddingBottom=3*i/12,t.paddingHorizontal=9*i/12,t.baselineOffset=0,t.labelBottomOffset=4*i/12,t.widthCache.reset()}return this._rendererOptions}_setCursor(t){this._cell.style.cursor=1===t?"ew-resize":"default"}_recreateStubs(){const t=this._chart.model(),e=t.options();e.leftPriceScale.visible||null===this._leftStub||(this._leftStubCell.removeChild(this._leftStub.getElement()),this._leftStub.destroy(),this._leftStub=null),e.rightPriceScale.visible||null===this._rightStub||(this._rightStubCell.removeChild(this._rightStub.getElement()),this._rightStub.destroy(),this._rightStub=null);const i={rendererOptionsProvider:this._chart.model().rendererOptionsProvider()},s=()=>e.leftPriceScale.borderVisible&&t.timeScale().options().borderVisible,n=()=>t.backgroundBottomColor();e.leftPriceScale.visible&&null===this._leftStub&&(this._leftStub=new ii("left",e,i,s,n),this._leftStubCell.appendChild(this._leftStub.getElement())),e.rightPriceScale.visible&&null===this._rightStub&&(this._rightStub=new ii("right",e,i,s,n),this._rightStubCell.appendChild(this._rightStub.getElement()))}}const li=!!Ee&&!!navigator.userAgentData&&navigator.userAgentData.brands.some((t=>t.brand.includes("Chromium")))&&!!Ee&&((null===(hi=null===navigator||void 0===navigator?void 0:navigator.userAgentData)||void 0===hi?void 0:hi.platform)?"Windows"===navigator.userAgentData.platform:navigator.userAgent.toLowerCase().indexOf("win")>=0);var hi;class ci{constructor(t,e,i){this._paneWidgets=[],this._drawRafId=0,this._height=0,this._width=0,this._leftPriceAxisWidth=0,this._rightPriceAxisWidth=0,this._invalidateMask=null,this._drawPlanned=!1,this._clicked=new wt,this._crosshairMoved=new wt,this._observer=null,this._cursorStyleOverride=null,this._options=e,this._horzScaleBehavior=i,this._element=document.createElement("div"),this._element.classList.add("tv-lightweight-charts"),this._element.style.overflow="hidden",this._element.style.direction="ltr",this._element.style.width="100%",this._element.style.height="100%",this._tableElement=document.createElement("table"),this._tableElement.setAttribute("cellspacing","0"),this._element.appendChild(this._tableElement),this._onWheelBound=this._onMousewheel.bind(this),di(this._options)&&this._setMouseWheelEventListener(!0),this._model=new ce(this._invalidateHandler.bind(this),this._options,i),this.model().crosshairMoved().subscribe(this._onPaneWidgetCrosshairMoved.bind(this),this),this._timeAxisWidget=new ai(this,this._horzScaleBehavior),this._tableElement.appendChild(this._timeAxisWidget.getElement());const s=e.autoSize&&this._installObserver();let n=this._options.width,o=this._options.height;if(s||0===n||0===o){const e=t.getBoundingClientRect();n=n||e.width,o=o||e.height}this.resize(n,o),this._syncGuiWithModel(),t.appendChild(this._element),this._updateTimeAxisVisibility(),this._model.timeScale().optionsApplied().subscribe(this._model.fullUpdate.bind(this._model),this),this._model.priceScalesOptionsChanged().subscribe(this._model.fullUpdate.bind(this._model),this)}model(){return this._model}options(){return this._options}timeAxisWidget(){return this._timeAxisWidget}destroy(){this._setMouseWheelEventListener(!1),0!==this._drawRafId&&window.cancelAnimationFrame(this._drawRafId),this._model.crosshairMoved().unsubscribeAll(this),this._model.timeScale().optionsApplied().unsubscribeAll(this),this._model.priceScalesOptionsChanged().unsubscribeAll(this),this._model.destroy();for(const t of this._paneWidgets)this._tableElement.removeChild(t.getElement()),t.clicked().unsubscribeAll(this),t.destroy();this._paneWidgets=[],h(this._timeAxisWidget).destroy(),null!==this._element.parentElement&&this._element.parentElement.removeChild(this._element),this._crosshairMoved.destroy(),this._clicked.destroy()}resize(t,e,i=!1){if(this._height===e&&this._width===t)return;const s=function(t){const e=Math.floor(t.width),i=Math.floor(t.height);return xe({width:e-e%2,height:i-i%2})}(xe({width:t,height:e}));this._height=s.height,this._width=s.width;const n=this._height+"px",o=this._width+"px";h(this._element).style.height=n,h(this._element).style.width=o,this._tableElement.style.height=n,this._tableElement.style.width=o,i?this._drawImpl(Pt.full(),performance.now()):this._model.fullUpdate()}paint(t){void 0===t&&(t=Pt.full());for(let e=0;e<this._paneWidgets.length;e++)this._paneWidgets[e].paint(t.invalidateForPane(e).level);this._options.timeScale.visible&&this._timeAxisWidget.paint(t.fullInvalidation())}applyOptions(t){const e=di(this._options);this._model.applyOptions(t);const i=di(this._options);i!==e&&this._setMouseWheelEventListener(i),this._updateTimeAxisVisibility(),this._applyAutoSizeOptions(t)}clicked(){return this._clicked}crosshairMoved(){return this._crosshairMoved}getPriceAxisWidth(t){return("left"!==t||this._isLeftAxisVisible())&&("right"!==t||this._isRightAxisVisible())?0===this._paneWidgets.length?0:h("left"===t?this._paneWidgets[0].leftPriceAxisWidget():this._paneWidgets[0].rightPriceAxisWidget()).getWidth():0}element(){return this._element}setCursorStyle(t){this._cursorStyleOverride=t,this._cursorStyleOverride?this.element().style.setProperty("cursor",t):this.element().style.removeProperty("cursor")}_applyAutoSizeOptions(t){t.autoSize&&!this._observer&&this._installObserver(),t.autoSize||void 0===t.width&&void 0===t.height||this.resize(t.width||this._width,t.height||this._height)}_adjustSizeImpl(){let t=0,e=0,i=0;for(const s of this._paneWidgets)this._isLeftAxisVisible()&&(e=Math.max(e,h(s.leftPriceAxisWidget()).optimalWidth(),this._options.leftPriceScale.minimumWidth)),this._isRightAxisVisible()&&(i=Math.max(i,h(s.rightPriceAxisWidget()).optimalWidth(),this._options.rightPriceScale.minimumWidth)),t+=s.stretchFactor();e=Be(e),i=Be(i);const s=this._width,n=this._height,o=Math.max(s-e-i,0),r=this._options.timeScale.visible;let a=r?Math.max(this._timeAxisWidget.optimalHeight(),this._options.timeScale.minimumHeight):0;var l;a=(l=a)+l%2;const c=0+a,d=n<c?0:n-c,u=d/t;let _=0;for(let t=0;t<this._paneWidgets.length;++t){const s=this._paneWidgets[t];s.setState(this._model.panes()[t]);let n=0,r=0;r=t===this._paneWidgets.length-1?d-_:Math.round(s.stretchFactor()*u),n=Math.max(r,2),_+=n,s.setSize(xe({width:o,height:n})),this._isLeftAxisVisible()&&s.setPriceAxisSize(e,"left"),this._isRightAxisVisible()&&s.setPriceAxisSize(i,"right"),s.state()&&this._model.setPaneHeight(s.state(),n)}this._timeAxisWidget.setSizes(xe({width:r?o:0,height:a}),r?e:0,r?i:0),this._model.setWidth(o),this._leftPriceAxisWidth!==e&&(this._leftPriceAxisWidth=e),this._rightPriceAxisWidth!==i&&(this._rightPriceAxisWidth=i)}_setMouseWheelEventListener(t){t?this._element.addEventListener("wheel",this._onWheelBound,{passive:!1}):this._element.removeEventListener("wheel",this._onWheelBound)}_determineWheelSpeedAdjustment(t){switch(t.deltaMode){case t.DOM_DELTA_PAGE:return 120;case t.DOM_DELTA_LINE:return 32}return li?1/window.devicePixelRatio:1}_onMousewheel(t){if(!(0!==t.deltaX&&this._options.handleScroll.mouseWheel||0!==t.deltaY&&this._options.handleScale.mouseWheel))return;const e=this._determineWheelSpeedAdjustment(t),i=e*t.deltaX/100,s=-e*t.deltaY/100;if(t.cancelable&&t.preventDefault(),0!==s&&this._options.handleScale.mouseWheel){const e=Math.sign(s)*Math.min(1,Math.abs(s)),i=t.clientX-this._element.getBoundingClientRect().left;this.model().zoomTime(i,e)}0!==i&&this._options.handleScroll.mouseWheel&&this.model().scrollChart(-80*i)}_drawImpl(t,e){var i;const s=t.fullInvalidation();3===s&&this._updateGui(),3!==s&&2!==s||(this._applyMomentaryAutoScale(t),this._applyTimeScaleInvalidations(t,e),this._timeAxisWidget.update(),this._paneWidgets.forEach((t=>{t.updatePriceAxisWidgets()})),3===(null===(i=this._invalidateMask)||void 0===i?void 0:i.fullInvalidation())&&(this._invalidateMask.merge(t),this._updateGui(),this._applyMomentaryAutoScale(this._invalidateMask),this._applyTimeScaleInvalidations(this._invalidateMask,e),t=this._invalidateMask,this._invalidateMask=null)),this.paint(t)}_applyTimeScaleInvalidations(t,e){for(const i of t.timeScaleInvalidations())this._applyTimeScaleInvalidation(i,e)}_applyMomentaryAutoScale(t){const e=this._model.panes();for(let i=0;i<e.length;i++)t.invalidateForPane(i).autoScale&&e[i].momentaryAutoScale()}_applyTimeScaleInvalidation(t,e){const i=this._model.timeScale();switch(t.type){case 0:i.fitContent();break;case 1:i.setLogicalRange(t.value);break;case 2:i.setBarSpacing(t.value);break;case 3:i.setRightOffset(t.value);break;case 4:i.restoreDefault();break;case 5:t.value.finished(e)||i.setRightOffset(t.value.getPosition(e))}}_invalidateHandler(t){null!==this._invalidateMask?this._invalidateMask.merge(t):this._invalidateMask=t,this._drawPlanned||(this._drawPlanned=!0,this._drawRafId=window.requestAnimationFrame((t=>{if(this._drawPlanned=!1,this._drawRafId=0,null!==this._invalidateMask){const e=this._invalidateMask;this._invalidateMask=null,this._drawImpl(e,t);for(const i of e.timeScaleInvalidations())if(5===i.type&&!i.value.finished(t)){this.model().setTimeScaleAnimation(i.value);break}}})))}_updateGui(){this._syncGuiWithModel()}_syncGuiWithModel(){const t=this._model.panes(),e=t.length,i=this._paneWidgets.length;for(let t=e;t<i;t++){const t=l(this._paneWidgets.pop());this._tableElement.removeChild(t.getElement()),t.clicked().unsubscribeAll(this),t.destroy()}for(let s=i;s<e;s++){const e=new ei(this,t[s]);e.clicked().subscribe(this._onPaneWidgetClicked.bind(this),this),this._paneWidgets.push(e),this._tableElement.insertBefore(e.getElement(),this._timeAxisWidget.getElement())}for(let i=0;i<e;i++){const e=t[i],s=this._paneWidgets[i];s.state()!==e?s.setState(e):s.updatePriceAxisWidgetsStates()}this._updateTimeAxisVisibility(),this._adjustSizeImpl()}_getMouseEventParamsImpl(t,e,i){var s;const n=new Map;let o;if(null!==t&&this._model.serieses().forEach((e=>{const i=e.bars().search(t);null!==i&&n.set(e,i)})),null!==t){const e=null===(s=this._model.timeScale().indexToTimeScalePoint(t))||void 0===s?void 0:s.originalTime;void 0!==e&&(o=e)}const r=this.model().hoveredSource(),a=null!==r&&r.source instanceof At?r.source:void 0,l=null!==r&&void 0!==r.object?r.object.externalId:void 0;return{originalTime:o,index:null!=t?t:void 0,point:null!=e?e:void 0,hoveredSeries:a,seriesData:n,hoveredObject:l,touchMouseEventData:null!=i?i:void 0}}_onPaneWidgetClicked(t,e,i){this._clicked.fire((()=>this._getMouseEventParamsImpl(t,e,i)))}_onPaneWidgetCrosshairMoved(t,e,i){this._crosshairMoved.fire((()=>this._getMouseEventParamsImpl(t,e,i)))}_updateTimeAxisVisibility(){this._timeAxisWidget.getElement().style.display=this._options.timeScale.visible?"":"none"}_isLeftAxisVisible(){return this._paneWidgets[0].state().leftPriceScale().options().visible}_isRightAxisVisible(){return this._paneWidgets[0].state().rightPriceScale().options().visible}}function di(t){return Boolean(t.handleScroll.mouseWheel||t.handleScale.mouseWheel)}function ui(t){return void 0!==t.open||void 0!==t.value}function _i(t,e,i,s){const n=i.value,o={index:e,time:t,value:[n,n,n,n],originalTime:s};return void 0!==i.color&&(o.color=i.color),o}function pi(t,e,i,s){const n=i.value,o={index:e,time:t,value:[n,n,n,n],originalTime:s};return void 0!==i.lineColor&&(o.lineColor=i.lineColor),void 0!==i.topColor&&(o.topColor=i.topColor),void 0!==i.bottomColor&&(o.bottomColor=i.bottomColor),o}function mi(t,e,i,s){const n=i.value,o={index:e,time:t,value:[n,n,n,n],originalTime:s};return void 0!==i.topLineColor&&(o.topLineColor=i.topLineColor),void 0!==i.bottomLineColor&&(o.bottomLineColor=i.bottomLineColor),void 0!==i.topFillColor1&&(o.topFillColor1=i.topFillColor1),void 0!==i.topFillColor2&&(o.topFillColor2=i.topFillColor2),void 0!==i.bottomFillColor1&&(o.bottomFillColor1=i.bottomFillColor1),void 0!==i.bottomFillColor2&&(o.bottomFillColor2=i.bottomFillColor2),o}function gi(t,e,i,s){const n={index:e,time:t,value:[i.open,i.high,i.low,i.close],originalTime:s};return void 0!==i.color&&(n.color=i.color),n}function fi(t,e,i,s){const n={index:e,time:t,value:[i.open,i.high,i.low,i.close],originalTime:s};return void 0!==i.color&&(n.color=i.color),void 0!==i.borderColor&&(n.borderColor=i.borderColor),void 0!==i.wickColor&&(n.wickColor=i.wickColor),n}function vi(t,e,i,s,n){const o=l(n)(i),r=Math.max(...o),a=Math.min(...o),h=o[o.length-1],c=[h,r,a,h],d=i,{color:u}=d;return{index:e,time:t,value:c,originalTime:s,data:function(t,e){let i,s;const n={};for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(n[s]=t[s]);for(null!=t&&"function"==typeof Object.getOwnPropertySymbols&&(i=0),s=Object.getOwnPropertySymbols(t);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(t,s[i])&&(n[s[i]]=t[s[i]]);return n}(d,["time","color"]),color:u}}function Si(t){return void 0!==t.value}function bi(t,e){return void 0!==e.customValues&&(t.customValues=e.customValues),t}function wi(t){return(e,i,s,n,o,r)=>function(t,e){return e?e(t):function(t){return void 0===t.open&&void 0===t.value}(t)}(s,r)?bi({time:e,index:i,originalTime:n},s):bi(t(e,i,s,n,o),s)}function xi(t,e){if(void 0!==t&&0!==t.length)return{firstTime:e.key(t[0].time),lastTime:e.key(t[t.length-1].time)}}function Ci(t){let e;return t.forEach((t=>{void 0===e&&(e=t.originalTime)})),l(e)}class yi{constructor(t){this._pointDataByTimePoint=new Map,this._seriesRowsBySeries=new Map,this._seriesLastTimePoint=new Map,this._sortedTimePoints=[],this._horzScaleBehavior=t}destroy(){this._pointDataByTimePoint.clear(),this._seriesRowsBySeries.clear(),this._seriesLastTimePoint.clear(),this._sortedTimePoints=[]}setSeriesData(t,e){let i=0!==this._pointDataByTimePoint.size,s=!1;const n=this._seriesRowsBySeries.get(t);if(void 0!==n)if(1===this._seriesRowsBySeries.size)i=!1,s=!0,this._pointDataByTimePoint.clear();else for(const e of this._sortedTimePoints)e.pointData.mapping.delete(t)&&(s=!0);let o=[];if(0!==e.length){const i=e.map((t=>t.time)),n=this._horzScaleBehavior.createConverterToInternalObj(e),a=(r=t.seriesType(),{Candlestick:wi(fi),Bar:wi(gi),Area:wi(pi),Baseline:wi(mi),Histogram:wi(_i),Line:wi(_i),Custom:wi(vi)}[r]),l=void 0,h=void 0;o=e.map(((e,o)=>{const r=n(e.time),c=this._horzScaleBehavior.key(r);let d=this._pointDataByTimePoint.get(c);var u;void 0===d&&(u=r,d={index:0,mapping:new Map,timePoint:u},this._pointDataByTimePoint.set(c,d),s=!0);const _=a(r,d.index,e,i[o],l,h);return d.mapping.set(t,_),_}))}var r;i&&this._cleanupPointsData(),this._setRowsToSeries(t,o);let a=-1;if(s){const t=[];this._pointDataByTimePoint.forEach((e=>{t.push({timeWeight:0,time:e.timePoint,pointData:e,originalTime:Ci(e.mapping)})})),t.sort(((t,e)=>this._horzScaleBehavior.key(t.time)-this._horzScaleBehavior.key(e.time))),a=this._replaceTimeScalePoints(t)}return this._getUpdateResponse(t,a,function(t,e,i){const s=xi(t,i),n=xi(e,i);if(void 0!==s&&void 0!==n)return{lastBarUpdatedOrNewBarsAddedToTheRight:s.lastTime>=n.lastTime&&s.firstTime>=n.firstTime}}(this._seriesRowsBySeries.get(t),n,this._horzScaleBehavior))}_setRowsToSeries(t,e){0!==e.length?(this._seriesRowsBySeries.set(t,e.filter(Si)),this._seriesLastTimePoint.set(t,e[e.length-1].time)):(this._seriesRowsBySeries.delete(t),this._seriesLastTimePoint.delete(t))}_cleanupPointsData(){for(const t of this._sortedTimePoints)0===t.pointData.mapping.size&&this._pointDataByTimePoint.delete(this._horzScaleBehavior.key(t.time))}_replaceTimeScalePoints(t){let e=-1;for(let i=0;i<this._sortedTimePoints.length&&i<t.length;++i){const s=this._sortedTimePoints[i],n=t[i];if(this._horzScaleBehavior.key(s.time)!==this._horzScaleBehavior.key(n.time)){e=i;break}n.timeWeight=s.timeWeight,Pi(n.pointData,i)}if(-1===e&&this._sortedTimePoints.length!==t.length&&(e=Math.min(this._sortedTimePoints.length,t.length)),-1===e)return-1;for(let i=e;i<t.length;++i)Pi(t[i].pointData,i);return this._horzScaleBehavior.fillWeightsForPoints(t,e),this._sortedTimePoints=t,e}_getBaseIndex(){if(0===this._seriesRowsBySeries.size)return null;let t=0;return this._seriesRowsBySeries.forEach((e=>{0!==e.length&&(t=Math.max(t,e[e.length-1].index))})),t}_getUpdateResponse(t,e,i){const s={series:new Map,timeScale:{baseIndex:this._getBaseIndex()}};if(-1!==e)this._seriesRowsBySeries.forEach(((e,n)=>{s.series.set(n,{data:e,info:n===t?i:void 0})})),this._seriesRowsBySeries.has(t)||s.series.set(t,{data:[],info:i}),s.timeScale.points=this._sortedTimePoints,s.timeScale.firstChangedPointIndex=e;else{const e=this._seriesRowsBySeries.get(t);s.series.set(t,{data:e||[],info:i})}return s}}function Pi(t,e){t.index=e,t.mapping.forEach((t=>{t.index=e}))}function Mi(t){const e={value:t.value[3],time:t.originalTime};return void 0!==t.customValues&&(e.customValues=t.customValues),e}function Ti(t){const e=Mi(t);return void 0!==t.color&&(e.color=t.color),e}function ki(t){const e=Mi(t);return void 0!==t.lineColor&&(e.lineColor=t.lineColor),void 0!==t.topColor&&(e.topColor=t.topColor),void 0!==t.bottomColor&&(e.bottomColor=t.bottomColor),e}function Ei(t){const e=Mi(t);return void 0!==t.topLineColor&&(e.topLineColor=t.topLineColor),void 0!==t.bottomLineColor&&(e.bottomLineColor=t.bottomLineColor),void 0!==t.topFillColor1&&(e.topFillColor1=t.topFillColor1),void 0!==t.topFillColor2&&(e.topFillColor2=t.topFillColor2),void 0!==t.bottomFillColor1&&(e.bottomFillColor1=t.bottomFillColor1),void 0!==t.bottomFillColor2&&(e.bottomFillColor2=t.bottomFillColor2),e}function zi(t){const e={open:t.value[0],high:t.value[1],low:t.value[2],close:t.value[3],time:t.originalTime};return void 0!==t.customValues&&(e.customValues=t.customValues),e}function Ri(t){const e=zi(t);return void 0!==t.color&&(e.color=t.color),e}function Bi(t){const e=zi(t),{color:i,borderColor:s,wickColor:n}=t;return void 0!==i&&(e.color=i),void 0!==s&&(e.borderColor=s),void 0!==n&&(e.wickColor=n),e}function Ii(t){const e=t.originalTime;return Object.assign(Object.assign({},t.data),{time:e})}const Oi={vertLine:{color:"#9598A1",width:1,style:3,visible:!0,labelVisible:!0,labelBackgroundColor:"#131722"},horzLine:{color:"#9598A1",width:1,style:3,visible:!0,labelVisible:!0,labelBackgroundColor:"#131722"},mode:0},Vi={vertLines:{color:"#D6DCDE",style:0,visible:!0},horzLines:{color:"#D6DCDE",style:0,visible:!0}},Di={background:{type:"solid",color:"#FFFFFF"},textColor:"#191919",fontSize:12,fontFamily:xt},Ai={autoScale:!0,mode:0,invertScale:!1,alignLabels:!0,borderVisible:!0,borderColor:"#2B2B43",entireTextOnly:!1,visible:!1,ticksVisible:!1,scaleMargins:{bottom:.1,top:.2},minimumWidth:0},Li={rightOffset:0,barSpacing:6,minBarSpacing:.5,fixLeftEdge:!1,fixRightEdge:!1,lockVisibleTimeRangeOnResize:!1,rightBarStaysOnScroll:!1,borderVisible:!0,borderColor:"#2B2B43",visible:!0,timeVisible:!1,secondsVisible:!0,shiftVisibleRangeOnNewBar:!0,allowShiftVisibleRangeOnWhitespaceReplacement:!1,ticksVisible:!1,uniformDistribution:!1,minimumHeight:0,allowBoldLabels:!0};function Wi(){return{width:0,height:0,autoSize:!1,layout:Di,crosshair:Oi,grid:Vi,overlayPriceScales:Object.assign({},Ai),leftPriceScale:Object.assign(Object.assign({},Ai),{visible:!1}),rightPriceScale:Object.assign(Object.assign({},Ai),{visible:!0}),timeScale:Li,localization:{locale:Ee?navigator.language:"",dateFormat:"dd MMM 'yy"},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!0},handleScale:{axisPressedMouseMove:{time:!0,price:!0},mouseWheel:!0,pinch:!0},kineticScroll:{mouse:!1,touch:!0},trackingMode:{exitMode:1}}}class Fi{constructor(t,e){this._chartWidget=t,this._priceScaleId=e}applyOptions(t){this._chartWidget.model().applyPriceScaleOptions(this._priceScaleId,t)}options(){return this._priceScale().options()}width(){return yt(this._priceScaleId)?this._chartWidget.getPriceAxisWidth(this._priceScaleId):0}_priceScale(){return h(this._chartWidget.model().findPriceScale(this._priceScaleId)).priceScale}}function Ni(t,e){e.forEach(function(t){switch(t){case"Candlestick":return Hi.bind(null,t);case"Line":return Ui.bind(null,t)}}(t))}function Hi(t,e){ui(e)&&(a("number"==typeof e.open,`${t} series item data value of open must be a number, got=${typeof e.open}, value=${e.open}`),a("number"==typeof e.high,`${t} series item data value of high must be a number, got=${typeof e.high}, value=${e.high}`),a("number"==typeof e.low,`${t} series item data value of low must be a number, got=${typeof e.low}, value=${e.low}`),a("number"==typeof e.close,`${t} series item data value of close must be a number, got=${typeof e.close}, value=${e.close}`))}function Ui(t,e){ui(e)&&a("number"==typeof e.value,`${t} series item data value must be a number, got=${typeof e.value}, value=${e.value}`)}class Yi{constructor(t,e,i,s,n){this._dataChangedDelegate=new wt,this._series=t,this._dataUpdatesConsumer=e,this._horzScaleBehavior=n}destroy(){this._dataChangedDelegate.destroy()}priceFormatter(){return this._series.formatter()}setData(t){!function(t,e,i=!1){if(0===t.length)return;let s=e.key(t[0].time);for(let n=1;n<t.length;++n){const o=e.key(t[n].time);a(i?s<=o:s<o,`data must be asc ordered by time, index=${n}, time=${o}, prev time=${s}`),s=o}}(t,this._horzScaleBehavior),Ni(this._series.seriesType(),t),this._dataUpdatesConsumer.applyNewData(this._series,t),this._onDataChanged("full")}applyOptions(t){this._series.applyOptions(t)}options(){return n(this._series.options())}_onDataChanged(t){this._dataChangedDelegate.hasListeners()&&this._dataChangedDelegate.fire(t)}}class ji{constructor(t,e,i){this._timeRangeChanged=new wt,this._logicalRangeChanged=new wt,this._sizeChanged=new wt,this._model=t,this._timeScale=t.timeScale(),this._timeAxisWidget=e,this._horzScaleBehavior=i}destroy(){this._timeRangeChanged.destroy(),this._logicalRangeChanged.destroy(),this._sizeChanged.destroy()}scrollToRealTime(){this._timeScale.scrollToRealTime()}setVisibleRange(t){const e={from:this._horzScaleBehavior.convertHorzItemToInternal(t.from),to:this._horzScaleBehavior.convertHorzItemToInternal(t.to)},i=this._timeScale.logicalRangeForTimeRange(e);this._model.setTargetLogicalRange(i)}width(){return this._timeAxisWidget.getSize().width}height(){return this._timeAxisWidget.getSize().height}applyOptions(t){this._timeScale.applyOptions(t)}options(){return Object.assign(Object.assign({},n(this._timeScale.options())),{barSpacing:this._timeScale.barSpacing()})}}function $i(t){return function(t){if(s(t.handleScale)){const e=t.handleScale;t.handleScale={axisPressedMouseMove:{time:e,price:e},mouseWheel:e,pinch:e}}else if(void 0!==t.handleScale){const{axisPressedMouseMove:e,_:i}=t.handleScale;s(e)&&(t.handleScale.axisPressedMouseMove={time:e,price:e})}const e=t.handleScroll;s(e)&&(t.handleScroll={horzTouchDrag:e,vertTouchDrag:e,mouseWheel:e,pressedMouseMove:e})}(t),t}class Xi{constructor(t,e,i){this._seriesMap=new Map,this._seriesMapReversed=new Map,this._clickedDelegate=new wt,this._crosshairMovedDelegate=new wt,this._dataLayer=new yi(e);const s=void 0===i?n(Wi()):d(n(Wi()),$i(i));this._horzScaleBehavior=e,this._chartWidget=new ci(t,s,e),this._chartWidget.clicked().subscribe((t=>{this._clickedDelegate.hasListeners()&&this._clickedDelegate.fire(this._convertMouseParams(t()))}),this),this._chartWidget.crosshairMoved().subscribe((t=>{this._crosshairMovedDelegate.hasListeners()&&this._crosshairMovedDelegate.fire(this._convertMouseParams(t()))}),this);const o=this._chartWidget.model();this._timeScaleApi=new ji(o,this._chartWidget.timeAxisWidget(),this._horzScaleBehavior)}resize(t,e,i){this._chartWidget.resize(t,e,i)}addCandlestickSeries(t={}){return function(t){void 0!==t.borderColor&&(t.borderUpColor=t.borderColor,t.borderDownColor=t.borderColor),void 0!==t.wickColor&&(t.wickUpColor=t.wickColor,t.wickDownColor=t.wickColor)}(t),this._addSeriesImpl("Candlestick",{upColor:"#26a69a",downColor:"#ef5350",wickVisible:!0,borderVisible:!0,borderColor:"#378658",borderUpColor:"#26a69a",borderDownColor:"#ef5350",wickColor:"#737375",wickUpColor:"#26a69a",wickDownColor:"#ef5350"})}addLineSeries(t){return this._addSeriesImpl("Line",{color:"#2196f3",lineStyle:0,lineWidth:3,lineType:0,lineVisible:!0,crosshairMarkerVisible:!0,crosshairMarkerRadius:4,crosshairMarkerBorderColor:"",crosshairMarkerBorderWidth:2,crosshairMarkerBackgroundColor:""},t)}applyNewData(t,e){this._sendUpdateToChart(this._dataLayer.setSeriesData(t,e))}priceScale(t){return new Fi(this._chartWidget,t)}timeScale(){return this._timeScaleApi}applyOptions(t){this._chartWidget.applyOptions($i(t))}options(){return this._chartWidget.options()}_addSeriesImpl(t,e,i={}){!function(t){if(void 0===t||"custom"===t.type)return;const e=t;void 0!==e.minMove&&void 0===e.precision&&(e.precision=function(t){if(t>=1)return 0;let e=0;for(;e<8;e++){const i=Math.round(t);if(Math.abs(i-t)<1e-8)return e;t*=10}return e}(e.minMove))}(i.priceFormat);const s=d({title:"",visible:!0,lastValueVisible:!0,priceLineVisible:!0,priceLineSource:0,priceLineWidth:1,priceLineColor:"",priceLineStyle:2,baseLineVisible:!0,baseLineWidth:1,baseLineColor:"#B2B5BE",baseLineStyle:0,priceFormat:{type:"price",precision:2,minMove:.01}},e,i),n=this._chartWidget.model().createSeries(t,s),o=new Yi(n,this,this,this,this._horzScaleBehavior);return this._seriesMap.set(o,n),this._seriesMapReversed.set(n,o),o}_sendUpdateToChart(t){const e=this._chartWidget.model();e.updateTimeScale(t.timeScale.baseIndex,t.timeScale.points,t.timeScale.firstChangedPointIndex),t.series.forEach(((t,e)=>e.setData(t.data,t.info))),e.recalculateAllPanes()}_mapSeriesToApi(t){return l(this._seriesMapReversed.get(t))}_convertMouseParams(t){const e=new Map;t.seriesData.forEach(((t,i)=>{const s=i.seriesType(),n=function(t){return{Area:ki,Line:Ti,Baseline:Ei,Histogram:Ti,Bar:Ri,Candlestick:Bi,Custom:Ii}[t]}(s)(t);"Custom"!==s&&a(ui(n)),e.set(this._mapSeriesToApi(i),n)}));const i=void 0===t.hoveredSeries?void 0:this._mapSeriesToApi(t.hoveredSeries);return{time:t.originalTime,logical:t.index,point:t.point,hoveredSeries:i,hoveredObjectId:t.hoveredObject,seriesData:e,sourceEvent:t.touchMouseEventData}}}let Gi=Object.freeze({__proto__:null,createChart:function(t,e){let i=new we,s=we.applyDefaults(e);const n=new Xi(t,i,s);return i.setOptions(n.options()),n},isBusinessDay:de,isUTCTimestamp:ue});const Ki="#03866a",Zi="#dc2020",qi="rgba(140,137,137,0.2)";function Qi(t){return new Date(t).getTime()/1e3}const Ji=document.getElementById("chart-container"),ts=Gi.createChart(Ji,{grid:{vertLines:{color:qi},horzLines:{color:qi}},height:600});ts.priceScale("right").applyOptions({borderVisible:!1,autoScale:!1,scaleMargins:{top:.1,bottom:.2}}),ts.timeScale("down").applyOptions({barSpacing:10,borderVisible:!1});const es=ts.addCandlestickSeries({upColor:Ki,downColor:Zi,borderVisible:!1,wickUpColor:Ki,wickDownColor:Zi}),is=function(t){const e=[];let i=1e3,s=new Date;s.setDate(s.getDate()-100);for(let t=0;t<100;t++){const t=i,n=t+Math.round(10*(Math.random()-.5)),o=Math.max(t,n)+Math.round(10*Math.random()),r=Math.min(t,n)-Math.round(10*Math.random()),a=n>=t?Ki:Zi;s.setDate(s.getDate()+1);const l=s.getFullYear(),h=String(s.getMonth()+1).padStart(2,"0"),c=String(s.getDate()).padStart(2,"0");e.push({time:`${l}-${h}-${c}`,open:t,high:o,low:r,close:n,color:a}),i=n}return e}();es.setData(is),ts.addLineSeries({priceLine:!1,firstValueVisible:!0,lineStyle:1,color:"rgba(79,75,75,0.2)",lineWidth:1}).setData([{time:is[0].time,value:is[0].open},{time:is[is.length-1].time,value:is[0].open}]);let ss=is.length>=60?is[is.length-60].time:is[0].time,ns=is[is.length-1].time;function os(){ts.timeScale().scrollToRealTime()}ts.timeScale().setVisibleRange({from:Qi(ss),to:Qi(ns)}),os(),document.getElementById("scrollBtn").addEventListener("click",(()=>{os()})),window.addEventListener("resize",(()=>{const{width:t,height:e}=Ji.getBoundingClientRect();ts.resize(t,e)}))})();